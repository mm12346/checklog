<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>USD & Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/5C5CFF/FFFFFF?text=Icon">
    <link rel="apple-touch-startup-image" href="https://placehold.co/512x512/5C5CFF/FFFFFF?text=Icon">
    <style>
        /* Custom styles for smooth scrolling and fixed bottom nav */
        body {
            font-family: 'Prompt', sans-serif;
            overflow: hidden; /* Prevent body scrolling, Swiper will handle it */
            height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            background-color: #5C5CFF; /* Purple background from image */
            color: #E5E7EB; /* Light gray text for general content */
        }

        .swiper {
            width: 100%;
            height: calc(100vh - 80px); /* Adjust this value if bottom-nav height changes */
            flex-grow: 1; /* Allow Swiper to take available space */
        }

        .swiper-slide {
            height: 100%; /* Ensure slide takes full height of its container */
            overflow-y: auto; /* Enable vertical scrolling within each slide */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS devices */
            padding-bottom: 100px; /* Add some padding to the bottom of each slide content to clear bottom nav */
            background-color: transparent; /* Transparent for slides to show body background */
        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .swiper-slide::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for Firefox */
        .swiper-slide {
            scrollbar-width: none;
        }

        .container {
            padding: 1.5rem; /* Default padding */
            max-width: 960px; /* Max width for content */
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Fixed bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1E1E1E; /* Darker gray for bottom nav */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 100; /* Ensure it's above other content */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px; /* Fixed height for the nav bar */
            opacity: 1; /* Default to visible */
            pointer-events: auto; /* Allow clicks by default */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for visibility */
        }

        /* Class to hide bottom nav smoothly */
        .bottom-nav.bottom-nav-hidden {
            opacity: 0;
            pointer-events: none; /* Disable clicks when hidden */
        }

        .bottom-nav .grid {
            width: 100%;
            max-width: 400px; /* Limit width for better mobile display */
            /* Updated to 3 columns for new main tabs */
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            cursor: pointer;
            color: #6B7280; /* Gray-500 for inactive */
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-item.active {
            color: #60A5FA; /* Blue-400 for active */
        }

        .nav-item .emoji {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-item .label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
        }

        .page-indicator {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            position: absolute;
            bottom: 5px; /* Position indicators below the nav items */
            width: 100%;
        }

        .indicator {
            width: 8px;
            height: 8px;
            background-color: #4B5563; /* Gray-700 for inactive */
            border-radius: 50%;
            margin: 0 4px;
            transition: background-color 0.3s ease;
        }

        .indicator.active {
            background-color: #60A5FA; /* Blue-400 for active */
        }


        /* General card styles */
        .summary-card {
            background-color: #2C2C2E; /* Darker gray for card background */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* darker shadow */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            color: #E5E7EB; /* Light gray text */
            transition: background-color 0.3s ease; /* Smooth transition for background */
            position: relative; /* For icon positioning */
            min-height: 150px; /* Ensure a minimum height for cards */
            justify-content: space-between; /* Distribute content */
        }

        .summary-card.card-on {
            background-color: #5C5CFF; /* Blue from image for active state */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 2.5rem; /* Larger icon size */
            color: #E5E7EB; /* Light gray icon color */
        }

        /* Responsive font sizes for card titles, labels, and values */
        .card-title {
            font-size: clamp(1rem, 4vw, 1.125rem); /* text-base on small, text-lg on larger */
            font-weight: 600; /* font-semibold */
            color: #E5E7EB; /* Light gray for title */
            margin-bottom: 0.5rem; /* mb-2 */
        }

        .card-status {
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* text-sm on small, text-sm on larger */
            color: #9CA3AF; /* Gray-400 for status */
            margin-bottom: 1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #4B5563; /* Darker gray dashed border */
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* text-sm on small, text-sm on larger */
            color: #9CA3AF; /* Gray-400 */
        }

        .summary-value {
            font-size: clamp(0.9rem, 3.5vw, 1rem); /* text-base on small, text-base on larger */
            font-weight: 500; /* font-medium */
            color: #F3F4F6; /* Lighter gray for values */
        }

        .highlight-value {
            font-size: clamp(1rem, 4vw, 1.125rem); /* text-lg on small, text-lg on larger */
            font-weight: 600; /* font-semibold */
            color: #FBBF24; /* Yellow-400 for highlights */
        }
        .profit-value {
            color: #10B981; /* Green for profit */
        }
        .loss-value {
            color: #EF4444; /* Red for loss */
        }

        /* Loader styles */
        .loader {
            border-top-color: #60A5FA; /* Blue-400 */
            -webkit-animation: spinner 1.2s linear infinite;
            animation: spinner 1.2s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification styles */
        #successNotification, #errorNotification {
            min-width: 250px;
        }

        /* Editable field styles */
        .editable-field {
            display: flex;
            align-items: center;
        }

        .editable-field input {
            border: 1px solid #4B5563; /* Darker gray border */
            background-color: #2C2C2E; /* Match card background */
            color: #F3F4F6; /* Light text */
            border-radius: 0.25rem; /* rounded-md */
            padding: 0.25rem 0.5rem;
            width: clamp(60px, 15vw, 80px); /* Responsive width for input */
            font-size: clamp(0.8rem, 3vw, 0.875rem); /* Responsive font size */
            margin-right: 0.5rem;
        }

        .edit-button, .save-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9CA3AF; /* Gray-400 */
            transition: color 0.2s ease;
        }

        .edit-button:hover {
            color: #60A5FA; /* Blue-400 */
        }

        .save-button {
            background-color: #60A5FA; /* Blue-400 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* Responsive font size */
        }

        .save-button:hover {
            background-color: #3B82F6; /* Blue-500 */
        }

        /* Toggle switch for settings and cards */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px; /* Wider toggle */
            height: 24px; /* Taller toggle */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6B7280; /* Gray-500 for off state */
            transition: .3s;
            border-radius: 24px; /* Rounded slider */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; /* Smaller circle */
            width: 18px; /* Smaller circle */
            left: 3px; /* Adjust position */
            bottom: 3px; /* Adjust position */
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #FBBF24; /* Yellow-400 for on state */
        }

        input:checked + .slider:before {
            transform: translateX(20px); /* Move circle to the right */
        }

        /* TradingView widget container styles */
        /* Removed for USD Summary page */

        /* Adjust input field styles for dark theme */
        input[type="date"],
        input[type="number"],
        input[type="text"],
        select { /* Added select here */
            background-color: #121212; /* Even darker background for inputs */
            color: #E5E7EB;
            border-color: #4B5563;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Invert color for dark theme */
        }
        /* select {
            background-color: #121212;
            color: #E5E7EB;
            border-color: #4B5563;
        } */

        /* History list items */
        .history-item {
            border-left: 4px solid; /* Border will be dynamic (buy/sell) */
            padding: 0; /* Remove padding from here, it will be on swipe-content */
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            color: #E5E7EB;
            position: relative; /* For delete button positioning */
            overflow: hidden; /* Hide overflowing delete button initially */
        }

        .history-item.buy {
            border-left-color: #5C5CFF; /* Matching total card active (dark) */
            background-color: #3A3A50; /* Slightly darker tint of the new blue */
        }

        .history-item.sale {
            border-left-color: #EF4444; /* Red for sale */
            background-color: #4A2C2C; /* Dark red for sale */
        }

        .swipe-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.75rem; /* Match parent border-radius */
        }

        .swipe-content {
            padding: 1rem; /* Apply padding here */
            /* background-color will be inherited from .history-item.buy or .history-item.sale */
            transition: transform 0.3s ease;
            position: relative;
            z-index: 2; /* Ensure content is above delete button */
            cursor: grab; /* Indicate it's draggable */
        }

        .swipe-content.dragging {
            cursor: grabbing;
        }

        .delete-reveal {
            position: absolute;
            top: 0;
            right: 0; /* Align to the right */
            bottom: 0;
            width: 80px; /* Width of the delete button area */
            background-color: #EF4444; /* Red background for delete */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Behind the swipe-content */
            transform: translateX(100%); /* Initially off-screen to the right */
            transition: transform 0.3s ease;
        }

        .swipe-content.swiped {
            transform: translateX(-80px); /* Move content left to reveal delete */
        }

        .delete-reveal.revealed {
            transform: translateX(0); /* Bring delete button into view */
        }

        .history-item .font-medium {
            color: #F3F4F6;
            font-size: clamp(0.85rem, 3.5vw, 1rem); /* Responsive font size */
        }
        /* Adjust font-semibold for buy/sell history items */
        .history-item.buy .font-semibold {
            color: #60A5FA; /* Blue for USD amount in buy history */
            font-size: clamp(0.95rem, 4vw, 1.125rem); /* Responsive font size */
        }
        body.light-theme .history-item.buy .font-semibold {
            color: #2563EB; /* Darker blue for USD amount in light theme buy history */
        }
        .history-item.sale .font-semibold {
            color: #EF4444; /* Red for USD amount in sale history */
            font-size: clamp(0.95rem, 4vw, 1.125rem); /* Responsive font size */
        }
        body.light-theme .history-item.sale .font-semibold {
            color: #DC2626; /* Darker red for USD amount in light theme sale history */
        }

        .history-item .text-sm {
            color: #9CA3AF;
            font-size: clamp(0.7rem, 2.8vw, 0.875rem); /* Responsive font size */
        }
        .delete-button {
            background: none;
            border: none;
            color: white; /* White icon on red background */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .delete-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Form button - matching total card active */
        .form-button {
            background-color: #5C5CFF; /* Matching total card active (dark) */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .form-button:hover {
            background-color: #4A4AF0; /* Slightly darker hover for new blue */
        }

        /* New style for sale button */
        .sale-button {
            background-color: #EF4444; /* Red for sale button */
        }
        .sale-button:hover {
            background-color: #DC2626; /* Darker red on hover */
        }


        /* Toggle between forms (Buy/Sell) */
        .form-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            background-color: #1E1E1E;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }

        .form-toggle-button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: #9CA3AF;
            background-color: transparent;
        }

        /* Active state for Buy toggle button - matching total card active */
        .form-toggle-button.active-toggle {
            background-color: #5C5CFF; /* Matching total card active (dark) */
            color: white;
        }

        /* Active state for Sale toggle button - red */
        .form-toggle-button.active-sale-toggle {
            background-color: #EF4444; /* Red for sale button */
            color: white;
        }


        /* Light Theme */
        body.light-theme {
            background-color: #F3F4F6; /* Light background */
            color: #1F2937; /* Dark text */
        }
        body.light-theme .swiper-slide {
            background-color: #F3F4F6;
        }
        body.light-theme .bottom-nav {
            background-color: #FFFFFF; /* White for bottom nav */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        body.light-theme .nav-item {
            color: #6B7280; /* Gray-500 */
        }
        body.light-theme .nav-item.active {
            color: #2563EB; /* Blue-600 */
        }
        body.light-theme .indicator {
            background-color: #D1D5DB; /* Gray-300 */
        }
        body.light-theme .indicator.active {
            background-color: #2563EB; /* Blue-600 */
        }
        body.light-theme .summary-card {
            background-color: #FFFFFF; /* White for card background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        body.light-theme .summary-card.card-on {
            background-color: #DBEAFE; /* Light blue for active state */
        }
        body.light-theme .card-title {
            color: #1E40AF; /* Blue-800 */
        }
        body.light-theme .card-status {
            color: #4B5563; /* Gray-700 */
        }
        body.light-theme .summary-label {
            color: #4B5563; /* Gray-700 */
        }
        body.light-theme .summary-value {
            color: #1F2937; /* Gray-900 */
        }
        body.light-theme .highlight-value {
            color: #10B981; /* Green-600 */
        }
        body.light-theme .editable-field input {
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #D1D5DB;
        }
        body.light-theme input[type="date"], body.light-theme input[type="number"], body.light-theme input[type="text"], body.light-theme select { /* Added select here */
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #D1D5DB;
        }
        body.light-theme input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0); /* Reset filter for light theme */
        }
        /* body.light-theme select {
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #4B5563;
        } */
        body.light-theme .history-item {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #1F2937;
        }
        body.light-theme .history-item.buy {
            border-left-color: #2563EB; /* A stronger blue for light theme border */
            background-color: #E0F2FE; /* Light blue, similar to DBEAFE but a bit more distinct */
        }
        body.light-theme .history-item.sale {
            border-left-color: #DC2626; /* Darker red for light theme */
            background-color: #FEE2E2; /* Light red for sale */
        }
        body.light-theme .history-item .font-medium {
            color: #1E40AF;
        }
        body.light-theme .history-item .text-sm {
            color: #4B5563;
        }
        body.light-theme .delete-button {
            color: white; /* White icon on red background */
        }
        body.light-theme .delete-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        body.light-theme .form-button {
            background-color: #DBEAFE; /* Matching total card active (light) */
            color: #1F2937; /* Dark text for light background */
        }
        body.light-theme .form-button:hover {
            background-color: #B2D8FA; /* Slightly darker hover for light blue */
        }
        body.light-theme .sale-button {
            background-color: #DC2626; /* Red-700 for light theme */
        }
        body.light-theme .sale-button:hover {
            background-color: #B91C1C; /* Darker red on hover */
        }
        body.light-theme #loadingOverlay .bg-[#2C2C2E] {
            background-color: #FFFFFF;
        }
        body.light-theme #loadingOverlay h2 {
            color: #4B5563;
        }
        body.light-theme #successNotification {
            background-color: #10B981; /* green-600 */
        }
        body.light-theme #errorNotification {
            background-color: #EF4444; /* red-600 */
        }
        body.light-theme .profit-value {
            color: #10B981; /* Green for profit */
        }
        body.light-theme .loss-value {
            color: #EF4444; /* Red for loss */
        }
        body.light-theme .form-toggle-container {
            background-color: #E5E7EB;
        }
        body.light-theme .form-toggle-button {
            color: #4B5563;
        }
        body.light-theme .form-toggle-button.active-toggle {
            background-color: #DBEAFE;
            color: #1F2937;
        }
        body.light-theme .form-toggle-button.active-sale-toggle {
            background-color: #DC2626;
            color: white;
        }


        /* Custom Modal for Confirmation */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-modal-content {
            background-color: #2C2C2E;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            color: #E5E7EB;
            text-align: center;
            width: 90%;
            max-width: 400px;
            position: relative; /* Ensure this is relative for absolute positioning of close button */
        }
        .custom-modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
        }
        .custom-modal-actions {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        .custom-modal-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .custom-modal-actions button.confirm {
            background-color: #EF4444; /* Red */
            color: white;
        }
        .custom-modal-actions button.confirm:hover {
            background-color: #DC2626; /* Darker Red */
        }
        .custom-modal-actions button.cancel {
            background-color: #4B5563; /* Gray */
            color: white;
        }
        .custom-modal-actions button.cancel:hover {
            background-color: #374151; /* Darker Gray */
        }

        body.light-theme .custom-modal-content {
            background-color: #FFFFFF;
            color: #1F2937;
        }
        body.light-theme .custom-modal-actions button.confirm {
            background-color: #DC2626;
        }
        body.light-theme .custom-modal-actions button.confirm:hover {
            background-color: #B91C1C;
        }
        body.light-theme .custom-modal-actions button.cancel {
            background-color: #6B7280;
        }
        body.light-theme .custom-modal-actions button.cancel:hover {
            background-color: #4B5563;
        }

        /* PWA Update Notification */
        #updateNotification {
            position: fixed;
            bottom: 90px; /* เหนือ bottom-nav */
            left: 50%;
            transform: translateX(-50%) translateY(100%); /* เริ่มต้นซ่อนอยู่ด้านล่าง */
            background-color: #2C2C2E;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 101; /* สูงกว่า bottom-nav */
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease-out;
            max-width: calc(100% - 2rem); /* Adjusted max-width */
            left: 1rem; /* Adjusted left position */
            right: 1rem; /* Adjusted right position */
            margin-left: auto; /* Center horizontally */
            margin-right: auto; /* Center horizontally */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        #updateNotification.translate-y-0 {
            transform: translateX(-50%) translateY(0); /* เลื่อนขึ้นมาแสดง */
        }
        #updateNotification button {
            background-color: #60A5FA;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #updateNotification button:hover {
            background-color: #3B82F6;
        }
        #updateNotification .close-button {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 10px;
        }
        #updateNotification .close-button:hover {
            color: white;
        }

        /* Ensure .hidden truly hides elements */
        .hidden {
            display: none !important;
        }

        /* Custom styles for Login/Registration modal */
        .login-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's above everything else */
        }

        .login-modal-content {
            background-color: #FFFFFF; /* White background for login card */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); /* Soft shadow */
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            color: #1F2937; /* Dark text for light background */
        }

        .login-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #E5E7EB; /* Light border at the bottom */
        }

        .login-toggle-button {
            flex: 1;
            padding: 0.75rem 1rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: color 0.3s ease, border-color 0.3s ease;
            color: #6B7280; /* Gray text for inactive */
            border-bottom: 2px solid transparent; /* Transparent border for inactive */
            font-size: 1.125rem; /* text-lg */
        }

        .login-toggle-button.active-login-tab {
            color: #5C5CFF; /* Purple for active tab */
            border-color: #5C5CFF; /* Purple underline for active tab */
        }

        .login-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #D1D5DB; /* Light gray border */
            border-radius: 0.5rem; /* More rounded */
            background-color: #F9FAFB; /* Very light background */
            color: #1F2937; /* Dark text */
            font-size: 1rem;
            box-sizing: border-box;
        }
        .login-input::placeholder {
            color: #9CA3AF; /* Placeholder color */
        }
        .login-input:focus {
            outline: none;
            border-color: #5C5CFF; /* Purple focus border */
            box-shadow: 0 0 0 3px rgba(92, 92, 255, 0.3); /* Purple ring on focus */
        }

        .login-button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: 700; /* font-bold */
            color: white;
            background: linear-gradient(to right, #60A5FA, #5C5CFF); /* Blue to purple gradient */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .login-button:hover {
            background: linear-gradient(to right, #3B82F6, #4A4AF0); /* Darker gradient on hover */
            box-shadow: 6px 15px rgba(0, 0, 0, 0.3);
        }

        .login-version {
            color: #9CA3AF; /* Gray-400 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 1.5rem;
        }

        /* Styles for stock app */
        .stock-nav {
            background-color: #1E1E1E; /* Dark nav background */
            border-bottom-color: #4B5563; /* Dark border */
        }

        .stock-nav-item {
            color: #9CA3AF; /* Inactive text color */
            border-bottom: 2px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        .stock-nav-item.active {
            color: #60A5FA; /* Active text color */
            border-bottom-color: #60A5FA; /* Active border color */
        }
        .stock-nav-item:hover {
            background-color: #2C2C2E; /* Darker hover background */
        }

        /* Light theme for stock nav */
        body.light-theme .stock-nav {
            background-color: #FFFFFF; /* Light nav background */
            border-bottom-color: #D1D5DB; /* Light border */
        }
        body.light-theme .stock-nav-item {
            color: #6B7280; /* Inactive text color */
        }
        body.light-theme .stock-nav-item.active {
            color: #2563EB; /* Active text color */
            border-bottom-color: #2563EB; /* Active border color */
        }
        body.light-theme .stock-nav-item:hover {
            background-color: #F3F4F6; /* Lighter hover background */
        }

        /* Stock section content background */
        .stock-content-bg {
            background-color: #121212; /* Dark background for content */
        }
        body.light-theme .stock-content-bg {
            background-color: #F3F4F6; /* Light background for content */
        }

        /* Stock Summary Cards (using existing .summary-card for consistency) */
        /* .summary-card is already defined for dark/light themes */
        .summary-card-title {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* Tailwind gray-400 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .summary-card-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold; /* font-bold */
            color: #ffffff; /* white */
        }
        body.light-theme .summary-card-value {
            color: #1F2937; /* Dark text for light theme */
        }
        .summary-card-currency {
            font-size: 1rem; /* text-base */
            color: #d1d5db; /* Tailwind gray-300 */
            margin-left: 0.25rem;
        }
        body.light-theme .summary-card-currency {
            color: #4B5563; /* Darker text for light theme */
        }


        /* New styles for individual stock list items */
        .stock-list-item-container {
            margin-bottom: 1rem; /* space between items */
        }
        .stock-list-item {
            background-color: #2C2C2E; /* Dark background for list item */
            color: #E5E7EB; /* Light text */
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl, increased rounding */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        body.light-theme .stock-list-item {
            background-color: #FFFFFF; /* Light background for list item */
            color: #1F2937; /* Dark text */
        }

        .stock-icon-placeholder {
            width: 3rem; /* w-12 */
            height: 3rem; /* h-12 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
        }
        .stock-info {
            flex-grow: 1;
        }
        .stock-info-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #F3F4F6; /* Light text */
        }
        body.light-theme .stock-info-title {
            color: #111827; /* Dark text */
        }
        .stock-info-subtitle {
            font-size: 0.875rem; /* text-sm */
            color: #9CA3AF; /* Gray-400 */
        }
        body.light-theme .stock-info-subtitle {
            color: #6b7280; /* Gray-500 */
        }
        .stock-info p.font-medium { /* For target rates */
            color: #60A5FA; /* Blue-400 */
        }
        body.light-theme .stock-info p.font-medium {
            color: #2563EB; /* Blue-600 */
        }

        .stock-value-tag {
            width: 5rem; /* w-20, increased width */
            height: 5rem; /* h-20, increased height */
            border-radius: 9999px; /* rounded-full */
            background-color: #10b981; /* emerald-500, changed to emerald for better visibility */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-left: 1rem; /* ml-4 */
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(16,185,129,0.3), 0 2px 4px -1px rgba(16,185,129,0.2);
        }
        .stock-value-tag .value-amount {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            line-height: 1.2;
        }
        .stock-value-tag .value-label {
            font-size: 0.65rem; /* text-xs, slightly smaller */
            line-height: 1;
            margin-top: 0.125rem; /* mt-0.5 */
        }
        .stock-actions {
            background-color: #1E1E1E; /* Dark background */
            padding: 0.75rem; /* p-3 */
            margin-top: 0.75rem; /* mt-3 */
            border-top: 1px solid #4B5563; /* Dark border */
            border-radius: 0 0 0.75rem 0.75rem; /* rounded-b-xl */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.light-theme .stock-actions {
            background-color: #F9FAFB; /* Light background */
            border-top-color: #e5e7eb; /* Light border */
        }
        body.light-theme .stock-actions p {
            color: #4B5563; /* Darker text for light theme */
        }
        body.light-theme .stock-actions p.text-green-700 {
            color: #047857; /* Darker green */
        }
        body.light-theme .stock-actions p.text-orange-600 {
            color: #D97706; /* Darker orange */
        }
        body.light-theme .stock-actions p.text-red-600 {
            color: #DC2626; /* Darker red */
        }

        /* Stock form inputs */
        .stock-form-input {
            background-color: #121212; /* Darker background */
            color: #E5E7EB; /* Light text */
            border-color: #4B5563; /* Dark border */
        }
        body.light-theme .stock-form-input {
            background-color: #FFFFFF; /* Light background */
            color: #1F2937; /* Dark text */
            border-color: #D1D5DB; /* Light border */
        }
        .stock-form-label {
            color: #9CA3AF; /* Gray-400 */
        }
        body.light-theme .stock-form-label {
            color: #4B5563; /* Gray-700 */
        }

        /* Stock table styles (no longer used for history display, but keeping for other potential uses) */
        .stock-table-header {
            background-color: #1E1E1E; /* Dark header */
        }
        body.light-theme .stock-table-header {
            background-color: #F3F4F6; /* Light header */
        }
        body.light-theme .stock-table-header th {
            color: #6B7280; /* Gray-500 */
        }
        .stock-table-body {
            background-color: #2C2C2E; /* Dark body */
            color: #E5E7EB; /* Light text */
            border-color: #4B5563; /* Dark border */
        }
        body.light-theme .stock-table-body {
            background-color: #FFFFFF; /* Light body */
            color: #1F2937; /* Dark text */
            border-color: #D1D5DB; /* Light border */
        }
        body.light-theme .stock-table-body td {
            color: #1F2937; /* Dark text */
        }
        .stock-table-body td.font-medium { /* For stock symbol */
            color: #F3F4F6; /* Lighter text */
        }
        body.light-theme .stock-table-body td.font-medium {
            color: #111827; /* Darker text */
        }
        .stock-table-body button {
            color: #EF4444; /* Red for delete */
        }
        body.light-theme .stock-table-body button {
            color: #DC2626; /* Darker red */
        }

        /* Stock settings specific styles */
        .stock-settings-card {
            background-color: #2C2C2E; /* Dark background */
            border-color: #4B5563; /* Dark border */
        }
        body.light-theme .stock-settings-card {
            background-color: #FFFFFF; /* Light background */
            border-color: #D1D5DB; /* Light border */
        }
        body.light-theme .stock-settings-card h2, body.light-theme .stock-settings-card h1 {
            color: #1F2937; /* Dark text */
        }
        body.light-theme .stock-settings-card p.text-sm {
            color: #6B7280; /* Gray-500 */
        }
        body.light-theme .stock-settings-card .font-medium {
            color: #1F2937; /* Dark text */
        }
        body.light-theme .stock-settings-card .text-slate-600 {
            color: #4B5563; /* Darker text */
        }
        body.light-theme .stock-settings-card button.bg-sky-500 {
            background-color: #0284C7; /* Sky-600 */
        }
        body.light-theme .stock-settings-card button.bg-blue-500 {
            background-color: #2563EB; /* Blue-600 */
        }

        /* TradingView Fullscreen Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }

        .tradingview-fullscreen-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            border-radius: 0;
            padding: 0;
            background-color: transparent; /* Make content background transparent */
            box-shadow: none; /* Remove shadow */
        }
        .tradingview-fullscreen-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* New styles for USD Sub-Navigation */
        .usd-sub-nav {
            background-color: #1E1E1E; /* Dark nav background */
            border-bottom-color: #4B5563; /* Dark border */
        }

        .usd-sub-nav-item {
            color: #9CA3AF; /* Inactive text color */
            border-bottom: 2px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        .usd-sub-nav-item.active {
            color: #60A5FA; /* Active text color */
            border-bottom-color: #60A5FA; /* Active border color */
        }
        .usd-sub-nav-item:hover {
            background-color: #2C2C2E; /* Darker hover background */
        }

        /* Light theme for USD sub-nav */
        body.light-theme .usd-sub-nav {
            background-color: #FFFFFF; /* Light nav background */
            border-bottom-color: #D1D5DB; /* Light border */
        }
        body.light-theme .usd-sub-nav-item {
            color: #6B7280; /* Inactive text color */
        }
        body.light-theme .usd-sub-nav-item.active {
            color: #2563EB; /* Active text color */
            border-bottom-color: #2563EB; /* Active border color */
        }
        body.light-theme .usd-sub-nav-item:hover {
            background-color: #F3F4F6; /* Lighter hover background */
        }

        /* USD section content background */
        .usd-content-bg {
            background-color: #121212; /* Dark background for content */
        }
        body.light-theme .usd-content-bg {
            background-color: #F3F4F6; /* Light background for content */
        }

    </style>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Updated imports for email/password authentication
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword as firebaseSignInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyB9xHmmBOgq6NLncJNk0tBsygjsmhKqA4c", // กรุณาแทนที่ด้วย API Key ของคุณ
            authDomain: "usd-tracker-app.firebaseapp.com", // กรุณาแทนที่ด้วย Auth Domain ของคุณ
            projectId: "usd-tracker-app", // กรุณาแทนที่ด้วย Project ID ของคุณ
            storageBucket: "usd-tracker-app.firebaseapp.com", // กรุณาแทนที่ด้วย Storage Bucket ของคุณ
            messagingSenderId: "243448319635", // กรุณาแทนที่ด้วย Messaging Sender ID ของคุณ
            appId: "1:243448319635:web:95a3d5b01bcb53d68a4766" // กรุณาแทนที่ด้วย App ID ของคุณ
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase (will be initialized in DOMContentLoaded)
        window.firebaseApp = app; 
        window.db = db; 
        window.auth = auth; 
        window.userId = null; 
        window.userSheetId = null; 

        // Define a fixed appId for Firestore path
        const APP_ID_FOR_FIRESTORE = 'usd-tracker-app-standalone'; 

        let swiperInstance = null; 


        // Google Apps Script API URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxvf43ju7cZ11SRInOU-PWV-yz31BMunoT_uHzQlWH3-3CRsDO9cuCv_eaZrXvoBmud/exec'; // กรุณาแทนที่ด้วย URL ของ Google Apps Script ที่ Deploy แล้ว
        console.log("Using Google Apps Script API_URL:", API_URL); 

        // Global variables to store summary data
        let summaryData = null;

        // DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successNotification = document.getElementById('successNotification');
        const errorNotification = document.getElementById('errorNotification');
        const totalCardEl = document.getElementById('totalCard');
        const ratesCardEl = document.getElementById('ratesCard');
        const buyCardEl = document.getElementById('buyCard');
        const profitLossCardEl = document.getElementById('profitLossCard'); 
        const historyList = document.getElementById('historyList'); 
        const updateNotificationEl = document.getElementById('updateNotification'); // Renamed to avoid conflict

        // Custom Modal elements
        const customModalOverlay = document.getElementById('customModalOverlay');
        const customModalTitle = document.getElementById('customModalTitle');
        const customModalMessage = document.getElementById('customModalMessage');
        const customModalConfirmBtn = document.getElementById('customModalConfirmBtn');
        const customModalCancelBtn = document.getElementById('customModalCancelBtn');

        // Login Modal elements
        const loginModalOverlay = document.getElementById('loginModalOverlay');
        const loginModalAuthSection = document.getElementById('loginModalAuthSection'); 
        const loginModalToggleSignIn = document.getElementById('loginModalToggleSignIn');
        const loginModalToggleSignUp = document.getElementById('loginModalToggleSignUp');
        const loginModalFormContainer = document.getElementById('loginModalFormContainer');
        const signUpModalFormContainer = document.getElementById('signUpModalFormContainer');
        const loginModalEmailInput = document.getElementById('loginModalEmailInput');
        const loginModalPasswordInput = document.getElementById('loginModalPasswordInput');
        const signInModalButton = document.getElementById('signInModalButton');
        const signUpModalEmailInput = document.getElementById('signUpModalEmailInput');
        const signUpModalPasswordInput = document.getElementById('signUpModalPasswordInput');
        const signUpModalConfirmPasswordInput = document.getElementById('signUpModalConfirmPasswordInput');
        const signUpModalSubmitButton = document.getElementById('signUpModalSubmitButton');
        // const loginModalSignOutButton = document.getElementById('loginModalSignOutButton'); // This button might not exist directly on the modal but rather in settings


        // Function to display notifications
        function showNotification(element, message = null) {
            const notificationTextElement = element.querySelector('p');
            if (notificationTextElement && message) {
                notificationTextElement.textContent = message;
            } else if (notificationTextElement) {
                notificationTextElement.textContent = element.id === 'successNotification' ? 'บันทึกข้อมูลสำเร็จ' : 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง';
            }
            element.classList.remove('translate-x-full'); 
            setTimeout(() => {
                element.classList.add('translate-x-full'); 
            }, 3000);
        }

        // Function to show custom modal
        function showCustomModal(title, message, onConfirm) {
            customModalTitle.textContent = title;
            customModalMessage.textContent = message;
            customModalOverlay.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                customModalOverlay.classList.add('hidden');
                customModalConfirmBtn.removeEventListener('click', confirmHandler);
                customModalCancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                customModalOverlay.classList.add('hidden');
                customModalConfirmBtn.removeEventListener('click', confirmHandler);
                customModalCancelBtn.removeEventListener('click', cancelHandler);
            };

            customModalConfirmBtn.addEventListener('click', confirmHandler);
            customModalCancelBtn.addEventListener('click', cancelHandler);
        }

        // Function to toggle card state (visual only)
        function toggleCardState(cardElement, toggleInput) {
            if (toggleInput.checked) {
                cardElement.classList.add('card-on');
            } else {
                cardElement.classList.remove('card-on');
            }
        }

        // Format currency to 2 decimal places
        function formatCurrency(value, symbol) {
            if (value === undefined || value === null || isNaN(value)) return '-';
            return `${symbol}${parseFloat(value).toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Format exchange rate to 2 decimal places
        function formatRate(value) {
            if (value === undefined || value === null || isNaN(value)) return '-';
            return parseFloat(value).toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Function to calculate additional buy amount and profit/loss
        function calculateAdditionalBuy() {
            if (!summaryData || summaryData.totalUSD === undefined || summaryData.targetRate === undefined || summaryData.totalTHB === undefined || summaryData.currentRate === undefined || summaryData.avgRate === undefined) {
                console.warn("Summary data not fully loaded or incomplete for calculating additional buy and profit/loss.");
                const additionalBuyTHBDisplay = document.getElementById('display-additionalBuyTHB');
                if (additionalBuyTHBDisplay) additionalBuyTHBDisplay.textContent = 'N/A';
                const additionalBuyUSDDisplay = document.getElementById('display-additionalBuyUSD');
                if (additionalBuyUSDDisplay) additionalBuyUSDDisplay.textContent = 'N/A';
                const displayUnrealizedProfitLossTHB = document.getElementById('display-unrealizedProfitLossTHB');
                if (displayUnrealizedProfitLossTHB) {
                    displayUnrealizedProfitLossTHB.textContent = 'N/A';
                    displayUnrealizedProfitLossTHB.classList.remove('profit-value', 'loss-value');
                }
                const displayUnrealizedProfitLossUSD = document.getElementById('display-unrealizedProfitLossUSD');
                if (displayUnrealizedProfitLossUSD) {
                    displayUnrealizedProfitLossUSD.textContent = 'N/A';
                    displayUnrealizedProfitLossUSD.classList.remove('profit-value', 'loss-value');
                }
                return;
            }

            const totalTHB = parseFloat(summaryData.totalTHB) || 0; // This is current_totalTHB_for_currency_summary
            const totalUSD = parseFloat(summaryData.totalUSD) || 0; // This is current_totalUSD_available_for_exchange
            const targetRate = parseFloat(summaryData.targetRate) || 0;
            const currentRate = parseFloat(summaryData.currentRate) || 0;
            const avgRate = parseFloat(summaryData.avgRate) || 0; // This is avgRate_overall_currency_buy

            let additionalTHB = 0;
            let additionalUSD = 0;

            // The avgRate here is the average cost of the *currently available USD for exchange*.
            // If the goal is to reach targetRate for the *currently available USD*,
            // and totalTHB = totalUSD * avgRate (which it should if avgRate is correctly representing the cost of totalUSD)
            if (avgRate <= targetRate && totalUSD > 0) { // Only calculate if we want to lower the avgRate and have USD
                 additionalTHB = 0;
                 additionalUSD = 0;
            } else if (totalUSD <=0 && targetRate > 0 && currentRate > 0) { // If no USD, and want to buy to target
                // This case might need a different interpretation or a fixed amount to buy.
                // For now, if totalUSD is zero or negative, additional buy is zero by the formula if avgRate is not well-defined.
                additionalTHB = 0;
                additionalUSD = 0;
            }
            else {
                const numerator = (targetRate * totalUSD) - totalTHB; // Should be totalUSD * (targetRate - avgRate)
                const denominator = (1 - (targetRate / currentRate));

                if (currentRate === 0 || denominator === 0) {
                    additionalTHB = 0; 
                    additionalUSD = 0;
                } else {
                    additionalTHB = numerator / denominator;
                    if (additionalTHB < 0) additionalTHB = 0; // Don't suggest selling with this formula
                    additionalUSD = additionalTHB / currentRate;
                }
            }
            
            const additionalBuyTHBDisplay = document.getElementById('display-additionalBuyTHB');
            if (additionalBuyTHBDisplay) additionalBuyTHBDisplay.textContent = formatCurrency(additionalTHB, '฿');
            const additionalBuyUSDDisplay = document.getElementById('display-additionalBuyUSD');
            if (additionalBuyUSDDisplay) additionalBuyUSDDisplay.textContent = formatCurrency(additionalUSD, '$');

            summaryData.additionalBuyTHB = additionalTHB;
            summaryData.additionalBuyUSD = additionalUSD;

            // --- Calculate and update Profit/Loss ---
            // Unrealized Profit/Loss (from current holdings of currency available for exchange)
            let unrealizedProfitLossTHB = (totalUSD * currentRate) - totalTHB;
            let unrealizedProfitLossUSD = (currentRate > 0) ? unrealizedProfitLossTHB / currentRate : 0;

            const displayUnrealizedProfitLossTHB = document.getElementById('display-unrealizedProfitLossTHB');
            const displayUnrealizedProfitLossUSD = document.getElementById('display-unrealizedProfitLossUSD');

            if (displayUnrealizedProfitLossTHB) {
                displayUnrealizedProfitLossTHB.textContent = formatCurrency(unrealizedProfitLossTHB, '฿');
                displayUnrealizedProfitLossTHB.classList.remove('profit-value', 'loss-value');
                displayUnrealizedProfitLossTHB.classList.add(unrealizedProfitLossTHB >= 0 ? 'profit-value' : 'loss-value');
            }
            if (displayUnrealizedProfitLossUSD) {
                displayUnrealizedProfitLossUSD.textContent = formatCurrency(unrealizedProfitLossUSD, '$');
                displayUnrealizedProfitLossUSD.classList.remove('profit-value', 'loss-value');
                displayUnrealizedProfitLossUSD.classList.add(unrealizedProfitLossUSD >= 0 ? 'profit-value' : 'loss-value');
            }
        }

        // Function to display summary data
        function displaySummary(summary) {
            // avgRate is now avgRate_overall_currency_buy
            // totalTHB is current_totalTHB_for_currency_summary
            // totalUSD is current_totalUSD_available_for_exchange

            // Populate Total Card
            totalCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">💰</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-totalCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">ยอดรวม (สำหรับแลกเปลี่ยน)</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">Total (฿)</div>
                    <div class="summary-value">${formatCurrency(summary.totalTHB, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total ($)</div>
                    <div class="summary-value">${formatCurrency(summary.totalUSD, '$')}</div>
                </div>
            `;
            const totalCardToggle = document.getElementById('toggle-totalCard');
            if (totalCardToggle) totalCardToggle.addEventListener('change', () => toggleCardState(totalCardEl, totalCardToggle));

            // Populate Rates Card
            ratesCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-ratesCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">อัตราแลกเปลี่ยน (สกุลเงิน)</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">AvgRate ซื้อ ($)</div>
                    <div class="summary-value" id="display-avgRate">${formatRate(summary.avgRate)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Target AvgRate ($)</div>
                    <div class="editable-field">
                        <div class="summary-value" id="display-targetRate">${formatRate(summary.targetRate)}</div>
                        <button class="edit-button ml-2" id="edit-button-targetRate">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <div class="hidden flex items-center" id="edit-form-targetRate">
                            <input type="number" step="0.01" min="0" id="input-targetRate" value="${parseFloat(summary.targetRate).toFixed(2)}">
                            <button class="save-button" id="save-button-targetRate">บันทึก</button>
                        </div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rate ปัจจุบัน</div>
                    <div class="editable-field">
                        <div class="summary-value" id="display-currentRate">${formatRate(summary.currentRate)}</div>
                        <button class="edit-button ml-2" id="edit-button-currentRate">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <div class="hidden flex items-center" id="edit-form-currentRate">
                            <input type="number" id="input-currentRate" step="0.01" min="0" value="${parseFloat(summary.currentRate).toFixed(2)}">
                            <button class="save-button" id="save-button-currentRate">บันทึก</button>
                        </div>
                    </div>
                </div>
            `;
            const ratesCardToggle = document.getElementById('toggle-ratesCard');
            if (ratesCardToggle) ratesCardToggle.addEventListener('change', () => toggleCardState(ratesCardEl, ratesCardToggle));

            // Populate Buy Card (for currency)
            buyCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">💵</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-buyCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">ซื้อเพิ่ม (สกุลเงิน)</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">ซื้อเพิ่ม (฿)</div>
                    <div id="display-additionalBuyTHB" class="highlight-value">0.00 ฿</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ซื้อเพิ่ม ($)</div>
                    <div id="display-additionalBuyUSD" class="highlight-value">0.00 USD</div>
                </div>
            `;
            const buyCardToggle = document.getElementById('toggle-buyCard');
            if (buyCardToggle) buyCardToggle.addEventListener('change', () => toggleCardState(buyCardEl, buyCardToggle));

            // Populate Profit/Loss Card (for currency)
            const realizedProfitLoss = parseFloat(summary.realizedProfitLoss) || 0;
            const unrealizedProfitLossTHB = (summary.totalUSD * summary.currentRate) - summary.totalTHB;
            const unrealizedProfitLossUSD = summary.currentRate > 0 ? unrealizedProfitLossTHB / summary.currentRate : 0;

            const realizedProfitLossClass = realizedProfitLoss >= 0 ? 'profit-value' : 'loss-value';
            const unrealizedProfitLossClassTHB = unrealizedProfitLossTHB >= 0 ? 'profit-value' : 'loss-value';
            const unrealizedProfitLossClassUSD = unrealizedProfitLossUSD >= 0 ? 'profit-value' : 'loss-value';

            profitLossCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-profitLossCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">กำไร/ขาดทุน (สกุลเงิน)</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่รับรู้ (฿)</div>
                    <div id="display-realizedProfitLossTHB" class="${realizedProfitLossClass}">${formatCurrency(realizedProfitLoss, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่ยังไม่รับรู้ (฿)</div>
                    <div id="display-unrealizedProfitLossTHB" class="${unrealizedProfitLossClassTHB}">${formatCurrency(unrealizedProfitLossTHB, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่ยังไม่รับรู้ ($)</div>
                    <div id="display-unrealizedProfitLossUSD" class="${unrealizedProfitLossClassUSD}">${formatCurrency(unrealizedProfitLossUSD, '$')}</div>
                </div>
            `;
            const profitLossCardToggle = document.getElementById('toggle-profitLossCard');
            if (profitLossCardToggle) profitLossCardToggle.addEventListener('change', () => toggleCardState(profitLossCardEl, profitLossCardToggle));

            addEditableFieldListeners();
            calculateAdditionalBuy();
        }

        // Add event listeners to all editable fields
        function addEditableFieldListeners() {
            const targetRateEditButton = document.getElementById('edit-button-targetRate');
            const targetRateDisplay = document.getElementById('display-targetRate');
            const targetRateForm = document.getElementById('edit-form-targetRate');
            const targetRateInput = document.getElementById('input-targetRate');
            const targetRateSaveButton = document.getElementById('save-button-targetRate');

            if (targetRateEditButton) {
                targetRateEditButton.addEventListener('click', function() {
                    targetRateDisplay.classList.add('hidden');
                    targetRateEditButton.classList.add('hidden');
                    targetRateForm.classList.remove('hidden');
                    targetRateInput.focus();
                });
                targetRateInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') targetRateSaveButton.click(); });
                targetRateSaveButton.addEventListener('click', () => saveEditableField('TargetRate', targetRateInput, targetRateDisplay, targetRateEditButton, targetRateForm));
            }

            const currentRateEditButton = document.getElementById('edit-button-currentRate');
            const currentRateDisplay = document.getElementById('display-currentRate');
            const currentRateForm = document.getElementById('edit-form-currentRate');
            const currentRateInput = document.getElementById('input-currentRate');
            const currentRateSaveButton = document.getElementById('save-button-currentRate');

            if (currentRateEditButton) {
                currentRateEditButton.addEventListener('click', function() {
                    currentRateDisplay.classList.add('hidden');
                    currentRateEditButton.classList.add('hidden');
                    currentRateForm.classList.remove('hidden');
                    currentRateInput.focus();
                });
                currentRateInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') currentRateSaveButton.click(); });
                currentRateSaveButton.addEventListener('click', () => saveEditableField('CurrentRate', currentRateInput, currentRateDisplay, currentRateEditButton, currentRateForm));
            }
        }


        // Function to save an editable field
        function saveEditableField(key, inputElement, displayElement, editButton, formElement) { 
            const newValue = parseFloat(inputElement.value);
            if (!isNaN(newValue) && newValue >= 0) { // Allow 0 for current rate
                if (summaryData) summaryData[key] = newValue;

                updateSummaryField(key, newValue)
                    .then(() => {
                        displayElement.textContent = formatRate(newValue);
                        displayElement.classList.remove('hidden');
                        editButton.classList.remove('hidden');
                        formElement.classList.add('hidden');
                        calculateAdditionalBuy();
                    })
                    .catch(error => {
                        console.error('Error saving field:', error);
                        showNotification(errorNotification, 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message); 
                        displayElement.classList.remove('hidden');
                        editButton.classList.remove('hidden');
                        formElement.classList.add('hidden');
                    });
            } else {
                inputElement.classList.add('border-red-500');
                setTimeout(() => inputElement.classList.remove('border-red-500'), 2000);
                showNotification(errorNotification, 'ค่าที่ป้อนไม่ถูกต้อง'); 
                displayElement.classList.remove('hidden');
                editButton.classList.remove('hidden');
                formElement.classList.add('hidden');
            }
        }


        // Function to update a summary field in Google Sheets
        async function updateSummaryField(fieldName, value) {
            loadingOverlay.classList.remove('hidden');
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                loadingOverlay.classList.add('hidden');
                return false; // Changed to return Promise.reject or handle error appropriately
            }

            const formData = new FormData();
            formData.append('action', 'updateSummary');
            formData.append('field', fieldName); 
            formData.append('value', value);
            formData.append('sheetId', window.userSheetId); 

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                const data = await response.json();
                loadingOverlay.classList.add('hidden');
                if (data.success) {
                    showNotification(successNotification); 
                    return true; 
                } else {
                    showNotification(errorNotification, data.message || 'Failed to update summary field'); 
                    throw new Error(data.message || 'Failed to update summary field'); 
                }
            } catch (error) {
                console.error('Error updating summary field:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถอัปเดตข้อมูลสรุปได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง'); 
                throw error; 
            }
        }

        // Variables for swipe logic
        let activeSwipeItem = null; 

        // Function to close any currently open swipe item
        function closeActiveSwipeItem() {
            if (activeSwipeItem) {
                activeSwipeItem.style.transform = 'translateX(0)';
                activeSwipeItem.classList.remove('swiped');
                const deleteReveal = activeSwipeItem.nextElementSibling; 
                if (deleteReveal && deleteReveal.classList.contains('delete-reveal')) {
                    deleteReveal.classList.remove('revealed');
                }
                activeSwipeItem = null;
            }
        }

        // Function to delete a record from Google Sheet
        async function deleteRecord(originalRowIndex, sheetName) { 
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', originalRowIndex); 
            formData.append('sheetId', window.userSheetId);
            formData.append('sheetName', sheetName); 

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                const data = await response.json();
                loadingOverlay.classList.add('hidden');
                if (data.success) {
                    showNotification(successNotification, 'ลบข้อมูลสำเร็จ');
                    fetchHistory();
                    fetchSummary();
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            } catch (error) {
                console.error('Error deleting data:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถลบข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง');
            }
        }

        // Function to fetch history data from Google Sheets
        function fetchHistory() {
            historyList.innerHTML = `<div class="flex justify-center py-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>`;
            if (!window.userSheetId) {
                historyList.innerHTML = '<p class="text-red-500 text-center py-4">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>';
                return;
            }
            const formData = new FormData();
            formData.append('action', 'getRecords');
            formData.append('sheetId', window.userSheetId); 

            fetch(API_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok for history: ${response.status} ${response.statusText}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.records && Array.isArray(data.records) && data.records.length > 0) {
                    displayHistory(data.records); 
                } else {
                    historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching history data:', error);
                historyList.innerHTML = `<p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง</p>`;
            });
        }

        // Function to display history data
        function displayHistory(records) {
            historyList.innerHTML = ''; 
            closeActiveSwipeItem(); 

            if (!records || records.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
                return;
            }

            const sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.data[a.data.length - 1]); 
                const dateB = new Date(b.data[b.data.length - 1]);
                return dateB - dateA; 
            });

            sortedRecords.forEach((recordObj) => {
                const record = recordObj.data;
                const originalRowIndex = recordObj.rowIndex; 
                const type = recordObj.type; 
                const sheetName = recordObj.sheetName; 

                let displayDate, amountLabel, amountValue, rateLabel, rateValue, primaryAmount, secondaryAmount;

                if (type === 'buy') {
                    displayDate = record[0];
                    primaryAmount = parseFloat(record[3]); 
                    secondaryAmount = parseFloat(record[1]); 
                    rateValue = parseFloat(record[2]); 
                    amountLabel = 'จำนวนเงิน:';
                    amountValue = formatCurrency(secondaryAmount, '฿');
                    rateLabel = 'อัตรา:';
                } else if (type === 'sale') {
                    displayDate = record[0];
                    primaryAmount = parseFloat(record[1]); 
                    secondaryAmount = parseFloat(record[3]); 
                    rateValue = parseFloat(record[2]); 
                    amountLabel = 'ได้รับเงิน:';
                    amountValue = formatCurrency(secondaryAmount, '฿');
                    rateLabel = 'อัตรา:';
                } else {
                    return;
                }

                try {
                    if (typeof displayDate === 'string') {
                        const dateObj = new Date(displayDate);
                        if (!isNaN(dateObj.getTime())) {
                            displayDate = dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                    }
                } catch (e) { console.error("Error formatting date:", e); }

                if (!isNaN(primaryAmount) && !isNaN(rateValue)) {
                    const historyItem = document.createElement('div');
                    historyItem.className = `history-item fade-in ${type}`; 
                    historyItem.dataset.originalRowIndex = originalRowIndex; 
                    historyItem.dataset.sheetName = sheetName; 

                    historyItem.innerHTML = `
                        <div class="swipe-container">
                            <div class="swipe-content">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${displayDate} (${type === 'buy' ? 'ซื้อ' : 'ขาย'})</span>
                                    <span class="font-semibold">${primaryAmount.toFixed(2)} USD</span>
                                </div>
                                <div class="flex justify-between text-sm mt-2">
                                    <span>${amountLabel} ${amountValue}</span>
                                    <span>${rateLabel} ${rateValue.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="delete-reveal">
                                <button class="delete-button" data-row-index="${originalRowIndex}" data-sheet-name="${sheetName}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    historyList.appendChild(historyItem);
                }
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    const originalRowIndex = this.dataset.rowIndex; 
                    const sheetName = this.dataset.sheetName; 
                    showCustomModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => deleteRecord(originalRowIndex, sheetName));
                });
            });

            document.querySelectorAll('.history-item').forEach(item => {
                const swipeContent = item.querySelector('.swipe-content');
                const deleteReveal = item.querySelector('.delete-reveal');
                const deleteButtonWidth = 80; 

                let startX = 0;
                let currentX = 0;
                let isSwiping = false;
                let initialTranslateX = 0; 

                const handleStart = (e) => {
                    closeActiveSwipeItem(); 
                    isSwiping = true;
                    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    swipeContent.classList.add('dragging');
                    const transformMatch = swipeContent.style.transform.match(/translateX\(([^)]+)px\)/);
                    initialTranslateX = transformMatch ? parseFloat(transformMatch[1]) : 0;
                    if (swiperInstance) swiperInstance.allowTouchMove = false;
                };

                const handleMove = (e) => {
                    if (!isSwiping) return;
                    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    let deltaX = currentX - startX;
                    let newTranslateX = initialTranslateX + deltaX;
                    newTranslateX = Math.max(-deleteButtonWidth, Math.min(0, newTranslateX));
                    swipeContent.style.transform = `translateX(${newTranslateX}px)`;
                    deleteReveal.style.transform = `translateX(${Math.max(0, deleteButtonWidth + newTranslateX)}px)`; 
                    if (Math.abs(deltaX) > 5) e.preventDefault();
                };

                const handleEnd = () => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    swipeContent.classList.remove('dragging');
                    const currentSwipePosition = parseFloat(swipeContent.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
                    if (currentSwipePosition < -deleteButtonWidth / 2) {
                        swipeContent.style.transform = `translateX(-${deleteButtonWidth}px)`;
                        deleteReveal.style.transform = `translateX(0)`;
                        swipeContent.classList.add('swiped');
                        deleteReveal.classList.add('revealed');
                        activeSwipeItem = swipeContent; 
                    } else {
                        swipeContent.style.transform = 'translateX(0)';
                        deleteReveal.style.transform = `translateX(100%)`;
                        swipeContent.classList.remove('swiped');
                        deleteReveal.classList.remove('revealed');
                    }
                    if (swiperInstance) swiperInstance.allowTouchMove = true;
                };

                swipeContent.addEventListener('touchstart', handleStart, { passive: false });
                swipeContent.addEventListener('touchmove', handleMove, { passive: false });
                swipeContent.addEventListener('touchend', handleEnd);
                swipeContent.addEventListener('mousedown', handleStart);
                swipeContent.addEventListener('mousemove', handleMove);
                swipeContent.addEventListener('mouseup', handleEnd);
                swipeContent.addEventListener('mouseleave', () => { if (isSwiping) handleEnd(); });
            });

            if (historyList.children.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
            }
        }


        // Function to fetch summary data from Google Apps Script
        function fetchSummary() {
            const loaderHTML = `<div class="flex justify-center py-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>`;
            totalCardEl.innerHTML = loaderHTML;
            ratesCardEl.innerHTML = loaderHTML;
            buyCardEl.innerHTML = loaderHTML;
            profitLossCardEl.innerHTML = loaderHTML;

            if (!window.userSheetId) {
                const noSheetIdMessage = '<p class="text-red-500 text-center py-4">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่า</p>';
                totalCardEl.innerHTML = noSheetIdMessage;
                ratesCardEl.innerHTML = noSheetIdMessage;
                buyCardEl.innerHTML = noSheetIdMessage;
                profitLossCardEl.innerHTML = noSheetIdMessage;
                return;
            }

            const formData = new FormData();
            formData.append('action', 'getSummary');
            formData.append('sheetId', window.userSheetId); 

            fetch(API_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.summary) {
                    const { totalTHB, totalUSD, avgRate, targetRate, currentRate, realizedProfitLoss } = data.summary; // avgRate is avgRate_overall_currency_buy
                    if (typeof totalTHB === 'number' && typeof totalUSD === 'number' &&
                        typeof avgRate === 'number' && typeof targetRate === 'number' && 
                        typeof currentRate === 'number' && typeof realizedProfitLoss === 'number') {
                        summaryData = data.summary; 
                        displaySummary(data.summary); 
                        
                        const totalCardToggle = document.getElementById('toggle-totalCard');
                        const ratesCardToggle = document.getElementById('toggle-ratesCard');
                        const buyCardToggle = document.getElementById('toggle-buyCard');
                        const profitLossCardToggle = document.getElementById('toggle-profitLossCard');

                        if (totalCardToggle) { totalCardToggle.checked = true; toggleCardState(totalCardEl, totalCardToggle); }
                        if (ratesCardToggle) { ratesCardToggle.checked = true; toggleCardState(ratesCardEl, ratesCardToggle); }
                        if (buyCardToggle) { buyCardToggle.checked = true; toggleCardState(buyCardEl, buyCardToggle); }
                        if (profitLossCardToggle) { profitLossCardToggle.checked = true; toggleCardState(profitLossCardEl, profitLossCardToggle); }
                    } else {
                        console.warn("Summary data received but essential fields are not numbers:", data.summary);
                        const invalidDataMessage = '<p class="text-red-500 text-center py-4">ข้อมูลสรุปไม่ถูกต้องหรือไม่สมบูรณ์</p>';
                        totalCardEl.innerHTML = invalidDataMessage; ratesCardEl.innerHTML = invalidDataMessage;
                        buyCardEl.innerHTML = invalidDataMessage; profitLossCardEl.innerHTML = invalidDataMessage;
                        showNotification(errorNotification, 'ข้อมูลสรุปไม่ถูกต้องหรือไม่สมบูรณ์');
                    }
                } else {
                    const noDataMessage = '<p class="text-gray-500 text-center py-4">ไม่พบข้อมูลสรุป</p>';
                    totalCardEl.innerHTML = noDataMessage; ratesCardEl.innerHTML = noDataMessage;
                    buyCardEl.innerHTML = noDataMessage; profitLossCardEl.innerHTML = noDataMessage;
                }
            })
            .catch(error => {
                console.error('Error fetching summary data:', error);
                const errorMessage = `<p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลสรุปได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง</p>`;
                totalCardEl.innerHTML = errorMessage; ratesCardEl.innerHTML = errorMessage;
                buyCardEl.innerHTML = errorMessage; profitLossCardEl.innerHTML = errorMessage;
            });
        }


        // Function to fetch the user's Google Sheet ID from Firestore
        async function fetchUserSheetId() {
            if (!window.db || !window.userId) {
                console.error("Firestore or User ID not available to fetch sheet ID.");
                window.userSheetId = null;
                const sheetIdInput = document.getElementById('sheetIdInput');
                if (sheetIdInput) sheetIdInput.value = '';
                const stockSettingsSheetIdInput = document.getElementById('stockSettingsSheetId');
                if (stockSettingsSheetIdInput) stockSettingsSheetIdInput.value = '';
                return;
            }
            try {
                const userSheetDocRef = doc(window.db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${window.userId}/sheets/userSheet`);
                const docSnap = await getDoc(userSheetDocRef); 
                if (docSnap.exists()) {
                    window.userSheetId = docSnap.data().sheetId; 
                    const sheetIdInput = document.getElementById('sheetIdInput');
                    if (sheetIdInput) sheetIdInput.value = window.userSheetId; 
                    const stockSettingsSheetIdInput = document.getElementById('stockSettingsSheetId');
                    if (stockSettingsSheetIdInput) stockSettingsSheetIdInput.value = window.userSheetId;
                    console.log("User's Google Sheet ID fetched from Firestore:", window.userSheetId);
                } else {
                    window.userSheetId = null; 
                    const sheetIdInput = document.getElementById('sheetIdInput');
                    if (sheetIdInput) sheetIdInput.value = ''; 
                    const stockSettingsSheetIdInput = document.getElementById('stockSettingsSheetId');
                    if (stockSettingsSheetIdInput) stockSettingsSheetIdInput.value = '';
                    console.log("No Google Sheet ID found for this user in Firestore.");
                }
            } catch (error) {
                console.error("Error fetching user sheet ID from Firestore:", error);
                window.userSheetId = null;
                const sheetIdInput = document.getElementById('sheetIdInput');
                if (sheetIdInput) sheetIdInput.value = '';
                const stockSettingsSheetIdInput = document.getElementById('stockSettingsSheetId');
                if (stockSettingsSheetIdInput) stockSettingsSheetIdInput.value = '';
            }
        }


        // Function to save the user's Google Sheet ID to Firestore
        async function saveUserSheetId(sheetId) {
            if (!window.db || !window.userId) {
                console.error("Firestore or User ID not available to save sheet ID.");
                return false;
            }
            try {
                const userSheetDocRef = doc(window.db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${window.userId}/sheets/userSheet`);
                await setDoc(userSheetDocRef, { sheetId: sheetId }); 
                window.userSheetId = sheetId; 
                const stockSettingsSheetIdInput = document.getElementById('stockSettingsSheetId');
                if (stockSettingsSheetIdInput) stockSettingsSheetIdInput.value = sheetId;
                console.log("User's Google Sheet ID saved to Firestore:", sheetId);
                return true;
            } catch (error) {
                console.error("Error saving user sheet ID to Firestore:", error);
                return false;
            }
        }

        // Function to handle Email/Password Sign-up
        async function signUpWithEmailPassword(email, password) {
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification(successNotification, 'ลงทะเบียนสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว');
                loginModalOverlay.classList.add('hidden'); 
            } catch (error) {
                console.error("Error during Email/Password Sign-up:", error);
                let errorMessage = 'ลงทะเบียนไม่สำเร็จ: ';
                if (error.code === 'auth/email-already-in-use') errorMessage += 'อีเมลนี้ถูกใช้ไปแล้ว';
                else if (error.code === 'auth/weak-password') errorMessage += 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                else if (error.code === 'auth/invalid-email') errorMessage += 'รูปแบบอีเมลไม่ถูกต้อง';
                else errorMessage += error.message;
                showNotification(errorNotification, errorMessage);
            }
        }

        // Function to handle Email/Password Sign-in
        async function handleSignInWithEmailPassword(email, password) { 
            try {
                await firebaseSignInWithEmailAndPassword(auth, email, password); 
                showNotification(successNotification, 'เข้าสู่ระบบสำเร็จ!');
                loginModalOverlay.classList.add('hidden'); 
            } catch (error) {
                console.error("Error during Email/Password Sign-in:", error);
                let errorMessage = 'เข้าสู่ระบบไม่สำเร็จ: ';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage += 'อีเมลหรือรหัสผ่านไม่ถูกต้อง โปรดตรวจสอบ Firebase Console ว่าเปิดใช้งานการยืนยันตัวตนด้วยอีเมล/รหัสผ่านแล้ว';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'รูปแบบอีเมลไม่ถูกต้อง';
                } else {
                    errorMessage += error.message;
                }
                showNotification(errorNotification, errorMessage);
            }
        }

        // Function to handle user sign-out
        async function signOutUser() {
            try {
                await signOut(auth);
                showNotification(successNotification, 'ออกจากระบบสำเร็จ');
                loginModalOverlay.classList.remove('hidden');
            } catch (error) {
                console.error("Error during sign out:", error);
                showNotification(errorNotification, 'ออกจากระบบไม่สำเร็จ: ' + error.message);
            }
        }

        // --- Stock Application State & Data ---
        let stockTransactions = []; 
        let currentStockHoldings = {}; // New global variable to store current stock holdings and average rates
        let stockSettings = { 
            targetCurrency: 'THB', 
            stockTargetRates: {},
            stockTargetExchangeRates: {}
        };
        
        // --- Stock DOM Elements ---
        let stockMainContent;
        let stockNavItems;
        let stockViews;
        let stockRecordForm;
        let stockSellForm; 
        let stockSettingsForm;
        let stockHistoryList; // Changed from stockHistoryTableBody
        let stockHistorySearchInput;
        let stockSummaryDashboard;
        let stockSummaryStockDetails;
        let stockStockTargetRatesContainer; // Declared here
        let stockAddStockTargetRateBtn;
        let stockStockTargetExchangeRatesContainer; // Declared here
        let stockAddStockTargetUsdRateBtn;
        let stockTvSymbolInput;
        let stockTvLoadSymbolBtn;
        let stockTvFullscreenBtn;
        let stockTvFullscreenModal; 
        let stockTradingViewWidgetContainer;
        let stockTradingViewFullscreenModal; 
        let stockTradingViewFullscreenContent; 
        let stockCloseTradingViewFullscreenBtn; 

        // Stock Form Inputs for calculations (Buy Form)
        let stockBuyUsdAmountPerShareInput;
        let stockBuyUsdExchangeRateAtPurchaseInput;
        let stockBuyQuantityInput;
        let stockBuyCalculatedTotalTHBInput;
        let stockBuyCalculatedPricePerShareInput;

        // Stock Form Inputs for calculations (Sell Form - main)
        let stockSellStockSymbolSelect; // Changed to select
        let stockSellQuantityInput;
        let stockSellUsdSellPricePerShareInput;
        let stockSellUsdExchangeRateAtSaleInput;
        let stockSellCalculatedTotalTHBReceivedInput;
        let stockSellCalculatedSellPricePerShareInput;


        // Stock Form Inputs for calculations (Sell Modal)
        let stockSellModalOverlay;
        let stockSellModalTitle;
        let stockSellModalSymbolDisplay;
        let closeStockSellModalBtn; // This is the close button for the sell stock modal
        let stockSellModalForm;
        let stockSellModalDate;
        let stockSellModalUsdPricePerShareInput;
        let stockSellModalQuantityInput;
        let stockSellModalUsdExchangeRateAtSaleInput;
        let stockSellModalTotalTHBReceivedInput;
        let stockSellModalPricePerShareInput;
        let stockSellModalSubmitBtn;


        // Color mapping for stock icons
        const stockIconColors = [
            'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500',
            'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'
        ];
        let stockColorMap = {};
        let stockNextColorIndex = 0;

        function stockGetStockIconColor(symbol) {
            if (!stockColorMap[symbol]) {
                stockColorMap[symbol] = stockIconColors[stockNextColorIndex % stockIconColors.length];
                stockNextColorIndex++;
            }
            return stockColorMap[symbol];
        }
        
        // --- Stock TradingView Widget ---
        let stockCurrentTradingViewSymbol = '';
        function stockLoadTradingViewWidget() {
            if (!stockTvSymbolInput || !stockTradingViewWidgetContainer) return; // Ensure elements exist
            const symbol = stockTvSymbolInput.value.trim().toUpperCase() || 'AAPL';
            stockCurrentTradingViewSymbol = symbol;
            stockTradingViewWidgetContainer.innerHTML = '';
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "autosize": true, "symbol": symbol, "interval": "D",
                "timezone": "Asia/Bangkok", 
                "theme": document.body.classList.contains('light-theme') ? 'light' : 'dark', 
                "style": "1", "locale": "th_TH", "enable_publishing": false,
                "allow_symbol_change": true, "calendar": false,
                "support_host": "https://www.tradingview.com"
            });
            stockTradingViewWidgetContainer.appendChild(script);
        }

        function stockOpenTradingViewFullscreen() {
            if (!stockTradingViewFullscreenModal || !stockTradingViewFullscreenContent) return;
            if (!stockCurrentTradingViewSymbol && (!stockTvSymbolInput || !stockTvSymbolInput.value.trim())) {
                showNotification(errorNotification, 'กรุณาโหลดกราฟของหุ้นที่ต้องการก่อนเข้าโหมดเต็มจอ');
                return;
            }
            const symbolToLoad = stockCurrentTradingViewSymbol || (stockTvSymbolInput ? stockTvSymbolInput.value.trim().toUpperCase() : 'AAPL') || 'AAPL';
            stockTradingViewFullscreenContent.innerHTML = '';
            const fullscreenScript = document.createElement('script');
            fullscreenScript.type = 'text/javascript';
            fullscreenScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            fullscreenScript.async = true;
            fullscreenScript.innerHTML = JSON.stringify({
                "autosize": true, "symbol": symbolToLoad, "interval": "D",
                "timezone": "Asia/Bangkok",
                "theme": document.body.classList.contains('light-theme') ? 'light' : 'dark',
                "style": "1", "locale": "th_TH", "enable_publishing": false,
                "allow_symbol_change": true, "calendar": false,
                "support_host": "https://www.tradingview.com",
                "enabled_features": ["header_fullscreen_button"] 
            });
            stockTradingViewFullscreenContent.appendChild(fullscreenScript);
            stockTradingViewFullscreenModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function stockCloseTradingViewFullscreen() {
            if (!stockTradingViewFullscreenModal || !stockTradingViewFullscreenContent) return;
            stockTradingViewFullscreenModal.style.display = 'none';
            stockTradingViewFullscreenContent.innerHTML = '';
            document.body.style.overflow = '';
        }

        // --- Stock Record Form Handling (Buy) ---
        function stockCalculateBuyAmounts() {
            if (!stockBuyQuantityInput || !stockBuyUsdAmountPerShareInput || !stockBuyUsdExchangeRateAtPurchaseInput || !stockBuyCalculatedTotalTHBInput || !stockBuyCalculatedPricePerShareInput) return;
            const quantity = parseFloat(stockBuyQuantityInput.value) || 0;
            const usdAmountPerShare = parseFloat(stockBuyUsdAmountPerShareInput.value) || 0;
            const usdExchangeRate = parseFloat(stockBuyUsdExchangeRateAtPurchaseInput.value) || 0;
            let totalTHB = 0; let pricePerShareTHB = 0;
            if (quantity > 0 && usdAmountPerShare > 0 && usdExchangeRate > 0) {
                totalTHB = quantity * usdAmountPerShare * usdExchangeRate;
                pricePerShareTHB = totalTHB / quantity;
            }
            stockBuyCalculatedTotalTHBInput.value = totalTHB.toFixed(2);
            stockBuyCalculatedPricePerShareInput.value = pricePerShareTHB.toFixed(2);
        }

        async function stockHandleRecordSubmit(event) {
            event.preventDefault();
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            stockCalculateBuyAmounts();
            const date = document.getElementById('stockRecordDate').value;
            const stockSymbol = document.getElementById('stockRecordStockSymbol').value.toUpperCase().trim();
            const quantity = parseFloat(stockBuyQuantityInput.value);
            const usdAmountPerShare = parseFloat(stockBuyUsdAmountPerShareInput.value);
            const usdExchangeRateAtPurchase = parseFloat(stockBuyUsdExchangeRateAtPurchaseInput.value);
            const totalTHB = parseFloat(stockBuyCalculatedTotalTHBInput.value);
            const pricePerShare = parseFloat(stockBuyCalculatedPricePerShareInput.value);

            if (!date || !stockSymbol || isNaN(quantity) || quantity <= 0 || isNaN(usdAmountPerShare) || usdAmountPerShare <= 0 || isNaN(usdExchangeRateAtPurchase) || usdExchangeRateAtPurchase <= 0 || isNaN(totalTHB) || totalTHB < 0 || isNaN(pricePerShare) || pricePerShare < 0) { // Allow 0 for total/price if quantity is 0
                showNotification(errorNotification, 'กรุณากรอกข้อมูลการซื้อหุ้นให้ครบถ้วนและถูกต้อง (USD ต่อหุ้น, จำนวนหุ้น, Rate THB/USD ต้องมากกว่า 0)');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const submitButton = event.submitter; if (submitButton) submitButton.disabled = true;
            const apiFormData = new FormData();
            apiFormData.append('action', 'saveStockRecord'); 
            apiFormData.append('sheetId', window.userSheetId);
            apiFormData.append('date', date); apiFormData.append('stockSymbol', stockSymbol);
            apiFormData.append('quantity', quantity); apiFormData.append('usdAmountPerShare', usdAmountPerShare); 
            apiFormData.append('usdExchangeRateAtPurchase', usdExchangeRateAtPurchase);
            apiFormData.append('totalTHB', totalTHB); apiFormData.append('pricePerShare', pricePerShare); 

            try {
                const response = await fetch(API_URL, { method: 'POST', body: apiFormData });
                const data = await response.json();
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                if (data.success) {
                    showNotification(successNotification, 'บันทึกรายการซื้อหุ้นเรียบร้อยแล้ว');
                    if(stockRecordForm) stockRecordForm.reset();
                    const stockRecordDateEl = document.getElementById('stockRecordDate');
                    if(stockRecordDateEl) stockRecordDateEl.valueAsDate = new Date();
                    stockCalculateBuyAmounts(); 
                    stockFetchAndRenderHistory(); 
                    stockFetchAndRenderSummary(); 
                    stockNavigateTo('stockHistoryView');
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกรายการซื้อหุ้น');
                }
            } catch (error) {
                console.error('Error saving stock record:', error);
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                showNotification(errorNotification, 'ไม่สามารถบันทึกรายการซื้อหุ้นได้: ' + error.message);
            }
        }

        // --- Stock Record Form Handling (Sell) ---
        // This function is for the dedicated sell form on the record page (not the modal)
        function stockCalculateSellAmounts() {
            // Note: This function is for the separate "Sell Stock" form on the "Record" page.
            // The modal will use stockCalculateSellModalAmounts.
            if (!stockSellQuantityInput || !stockSellUsdSellPricePerShareInput || !stockSellUsdExchangeRateAtSaleInput || !stockSellCalculatedTotalTHBReceivedInput || !stockSellCalculatedSellPricePerShareInput) return;
            const quantity = parseFloat(stockSellQuantityInput.value) || 0;
            const usdSellPricePerShare = parseFloat(stockSellUsdSellPricePerShareInput.value) || 0;
            const usdExchangeRateAtSale = parseFloat(stockSellUsdExchangeRateAtSaleInput.value) || 0;
            let totalTHBReceived = 0; let sellPricePerShareTHB = 0;
            if (quantity > 0 && usdSellPricePerShare > 0 && usdExchangeRateAtSale > 0) {
                totalTHBReceived = quantity * usdSellPricePerShare * usdExchangeRateAtSale;
                sellPricePerShareTHB = totalTHBReceived / quantity;
            }
            stockSellCalculatedTotalTHBReceivedInput.value = totalTHBReceived.toFixed(2);
            stockSellCalculatedSellPricePerShareInput.value = sellPricePerShareTHB.toFixed(2);
        }

        // This function is for the dedicated sell form on the record page (not the modal)
        async function stockHandleSellRecordSubmit(event) {
            event.preventDefault();
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            stockCalculateSellAmounts(); // Use the calculation for the main sell form
            const date = document.getElementById('stockSellDate').value;
            const stockSymbol = stockSellStockSymbolSelect.value.toUpperCase().trim(); // Get symbol from select
            const quantity = parseFloat(stockSellQuantityInput.value);
            const usdSellPricePerShare = parseFloat(stockSellUsdSellPricePerShareInput.value);
            const usdExchangeRateAtSale = parseFloat(stockSellUsdExchangeRateAtSaleInput.value);
            const totalTHBReceived = parseFloat(stockSellCalculatedTotalTHBReceivedInput.value);
            const sellPricePerShare = parseFloat(stockSellCalculatedSellPricePerShareInput.value);

            // --- Validation for selling shares ---
            if (stockSymbol === "") {
                showNotification(errorNotification, 'กรุณาเลือกหุ้นที่ต้องการขาย');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                showNotification(errorNotification, 'กรุณากรอกจำนวนหุ้นที่ต้องการขายให้ถูกต้อง (ต้องมากกว่า 0)');
                return;
            }
            if (!currentStockHoldings[stockSymbol] || currentStockHoldings[stockSymbol].quantity < quantity) {
                showNotification(errorNotification, `จำนวนหุ้นที่ต้องการขาย (${quantity} หุ้น) เกินจำนวนที่มีอยู่ (${currentStockHoldings[stockSymbol].quantity || 0} หุ้น) สำหรับหุ้น ${stockSymbol}`);
                return;
            }
            // --- End Validation ---

            if (!date || isNaN(usdSellPricePerShare) || usdSellPricePerShare <= 0 || isNaN(usdExchangeRateAtSale) || usdExchangeRateAtSale <= 0 || isNaN(totalTHBReceived) || totalTHBReceived < 0 || isNaN(sellPricePerShare) || sellPricePerShare < 0) { // Allow 0 for total/price
                showNotification(errorNotification, 'กรุณากรอกข้อมูลการขายหุ้นให้ครบถ้วนและถูกต้อง (USD ต่อหุ้น, Rate THB/USD ต้องมากกว่า 0)');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const submitButton = event.submitter; if (submitButton) submitButton.disabled = true;
            const apiFormData = new FormData();
            apiFormData.append('action', 'saveStockSaleRecord'); 
            apiFormData.append('sheetId', window.userSheetId);
            apiFormData.append('date', date); apiFormData.append('stockSymbol', stockSymbol);
            apiFormData.append('quantity', quantity); apiFormData.append('usdSellPricePerShare', usdSellPricePerShare); 
            apiFormData.append('usdExchangeRateAtSale', usdExchangeRateAtSale);
            apiFormData.append('totalTHBReceived', totalTHBReceived); apiFormData.append('sellPricePerShare', sellPricePerShare); 

            try {
                const response = await fetch(API_URL, { method: 'POST', body: apiFormData });
                const data = await response.json();
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                if (data.success) {
                    showNotification(successNotification, 'บันทึกรายการขายหุ้นเรียบร้อยแล้ว');
                    if(stockSellForm) stockSellForm.reset();
                    const stockSellDateEl = document.getElementById('stockSellDate');
                    if(stockSellDateEl) stockSellDateEl.valueAsDate = new Date();
                    stockCalculateSellAmounts(); 
                    stockFetchAndRenderHistory(); 
                    stockFetchAndRenderSummary(); 
                    stockNavigateTo('stockHistoryView');
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกรายการขายหุ้น');
                }
            } catch (error) {
                console.error('Error saving stock sale record:', error);
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                showNotification(errorNotification, 'ไม่สามารถบันทึกรายการขายหุ้นได้: ' + error.message);
            }
        }

        // --- Stock History List Rendering & Actions ---
        async function stockFetchAndRenderHistory(searchTerm = '') {
            if (!stockHistoryList) return; // Changed from stockHistoryTableBody
            stockHistoryList.innerHTML = `<div class="flex justify-center py-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>`;
            if (!window.userSheetId) {
                stockHistoryList.innerHTML = '<p class="text-red-500 text-center py-4">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>';
                return;
            }
            const formData = new FormData();
            formData.append('action', 'getStockRecords'); 
            formData.append('sheetId', window.userSheetId);
            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success && Array.isArray(data.records)) {
                    stockTransactions = data.records; 
                    calculateCurrentHoldings(); // NEW: Calculate holdings after fetching transactions
                    stockRenderHistoryList(searchTerm); // Changed to stockRenderHistoryList
                    populateStockSellSymbolDropdown(); // NEW: Populate dropdown after holdings are calculated
                } else {
                    stockHistoryList.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่พบประวัติการซื้อขายหุ้น</p>';
                }
            } catch (error) {
                console.error('Error fetching stock history:', error);
                stockHistoryList.innerHTML = `<p class="text-red-500 text-center py-4">ไม่สามารถโหลดประวัติหุ้นได้: ${error.message}</p>`;
            }
        }

        function stockRenderHistoryList(searchTerm = '') { // Changed function name
            if (!stockHistoryList) return; // Changed from stockHistoryTableBody
            stockHistoryList.innerHTML = '';
            closeActiveSwipeItem(); // Close any active swipe items

            const displayTransactions = stockTransactions.filter(tx => {
                const symbol = String(tx.data[2] || '').toLowerCase(); 
                const date = String(tx.data[0] || '').toLowerCase(); 
                const type = String(tx.data[1] || '').toLowerCase();
                const searchLower = searchTerm.toLowerCase();
                return symbol.includes(searchLower) || date.includes(searchLower) || type.includes(searchLower);
            }).sort((a, b) => new Date(b.data[8]) - new Date(a.data[8])); 

            if (displayTransactions.length === 0) {
                stockHistoryList.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่พบรายการที่ตรงกัน หรือยังไม่มีประวัติการซื้อขาย</p>';
                return;
            }

            displayTransactions.forEach(tx => {
                const record = tx.data;
                const originalRowIndex = tx.rowIndex; 
                const type = tx.type; 
                const sheetName = tx.sheetName; 

                const displayDate = new Date(record[0]).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                const stockSymbol = record[2];
                const quantity = parseFloat(record[3]);
                const totalAmountTHB = parseFloat(record[4]); // Total THB for buy, Total THB Received for sell
                const usdAmountPerShare = parseFloat(record[5]); // USD Amount Per Share for buy, USD Sell Price Per Share for sell
                const exchangeRate = parseFloat(record[6]); // USD Exchange Rate at Purchase for buy, USD Exchange Rate at Sale for sell
                const pricePerShareTHB = parseFloat(record[7]); // Price Per Share (THB) for buy, Sell Price Per Share (THB) for sell

                const historyItem = document.createElement('div');
                historyItem.className = `history-item fade-in ${type.toLowerCase()}`; 
                historyItem.dataset.originalRowIndex = originalRowIndex; 
                historyItem.dataset.sheetName = sheetName; 

                // Determine display values based on type
                let primaryAmountDisplay = `${usdAmountPerShare.toFixed(2)} USD`;
                let secondaryDetails = `
                    <span>จำนวน: ${quantity.toLocaleString(undefined, {minimumFractionDigits: 7, maximumFractionDigits: 7})} หุ้น</span>
                    <span>Rate: ${exchangeRate.toFixed(2)} THB/USD</span>
                `;
                let totalAmountDisplay = `รวมเงิน: ${totalAmountTHB.toLocaleString(undefined, {minimumFractionDigits: 2})} ฿`;
                let pricePerShareDisplay = `ราคา/หุ้น: ${pricePerShareTHB.toLocaleString(undefined, {minimumFractionDigits: 2})} ฿`;
                let actionButtonHTML = '';

                if (type === 'Buy') {
                    // Only show sell button if there are available shares for this stock
                    if (currentStockHoldings[stockSymbol] && currentStockHoldings[stockSymbol].quantity > 0) {
                        actionButtonHTML = `
                            <button class="sell-stock-button px-3 py-1 bg-red-500 text-white rounded-md text-xs font-semibold hover:bg-red-600 transition-colors duration-200"
                                data-symbol="${stockSymbol}"
                                data-quantity="${quantity}"
                                data-usd-cost-per-share="${usdAmountPerShare}"
                                data-exchange-rate="${exchangeRate}">
                                ขายหุ้น
                            </button>
                        `;
                    }
                }

                historyItem.innerHTML = `
                    <div class="swipe-container">
                        <div class="swipe-content">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium">${displayDate} (${type === 'Buy' ? 'ซื้อ' : 'ขาย'})</span>
                                <span class="font-semibold">${stockSymbol}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>${totalAmountDisplay}</span>
                                <span class="${type === 'Buy' ? 'text-blue-400' : 'text-red-400'}">${primaryAmountDisplay}</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1 text-gray-400">
                                <span>${pricePerShareDisplay}</span>
                                ${secondaryDetails}
                            </div>
                            ${actionButtonHTML ? `<div class="mt-3 text-right">${actionButtonHTML}</div>` : ''}
                        </div>
                        <div class="delete-reveal">
                            <button class="delete-button" data-row-index="${originalRowIndex}" data-sheet-name="${sheetName}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                stockHistoryList.appendChild(historyItem);
            });

            // Re-attach event listeners for delete and sell buttons
            document.querySelectorAll('#stockHistoryList .delete-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    const originalRowIndex = this.dataset.rowIndex; 
                    const sheetName = this.dataset.sheetName; 
                    showCustomModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => stockDeleteTransaction(originalRowIndex, sheetName));
                });
            });

            document.querySelectorAll('#stockHistoryList .sell-stock-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent swipe content click
                    const symbol = this.dataset.symbol;
                    // Pass the average exchange rate for the symbol
                    const avgExchangeRate = currentStockHoldings[symbol] ? currentStockHoldings[symbol].averageExchangeRate : 0;
                    stockOpenSellModal(symbol, currentStockHoldings[symbol].quantity, 0, avgExchangeRate); // Pass 0 for usdCostPerShare as it's not relevant for average
                });
            });

            // Re-attach swipe listeners
            document.querySelectorAll('#stockHistoryList .history-item').forEach(item => {
                const swipeContent = item.querySelector('.swipe-content');
                const deleteReveal = item.querySelector('.delete-reveal');
                const deleteButtonWidth = 80; 

                let startX = 0;
                let currentX = 0;
                let isSwiping = false;
                let initialTranslateX = 0; 

                const handleStart = (e) => {
                    closeActiveSwipeItem(); 
                    isSwiping = true;
                    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    swipeContent.classList.add('dragging');
                    const transformMatch = swipeContent.style.transform.match(/translateX\(([^)]+)px\)/);
                    initialTranslateX = transformMatch ? parseFloat(transformMatch[1]) : 0;
                    if (swiperInstance) swiperInstance.allowTouchMove = false;
                };

                const handleMove = (e) => {
                    if (!isSwiping) return;
                    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    let deltaX = currentX - startX;
                    let newTranslateX = initialTranslateX + deltaX;
                    newTranslateX = Math.max(-deleteButtonWidth, Math.min(0, newTranslateX));
                    swipeContent.style.transform = `translateX(${newTranslateX}px)`;
                    deleteReveal.style.transform = `translateX(${Math.max(0, deleteButtonWidth + newTranslateX)}px)`; 
                    if (Math.abs(deltaX) > 5) e.preventDefault();
                };

                const handleEnd = () => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    swipeContent.classList.remove('dragging');
                    const currentSwipePosition = parseFloat(swipeContent.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
                    if (currentSwipePosition < -deleteButtonWidth / 2) {
                        swipeContent.style.transform = `translateX(-${deleteButtonWidth}px)`;
                        deleteReveal.style.transform = `translateX(0)`;
                        swipeContent.classList.add('swiped');
                        deleteReveal.classList.add('revealed');
                        activeSwipeItem = swipeContent; 
                    } else {
                        swipeContent.style.transform = 'translateX(0)';
                        deleteReveal.style.transform = `translateX(100%)`;
                        swipeContent.classList.remove('swiped');
                        deleteReveal.classList.remove('revealed');
                    }
                    if (swiperInstance) swiperInstance.allowTouchMove = true;
                };

                swipeContent.addEventListener('touchstart', handleStart, { passive: false });
                swipeContent.addEventListener('touchmove', handleMove, { passive: false });
                swipeContent.addEventListener('touchend', handleEnd);
                swipeContent.addEventListener('mousedown', handleStart);
                swipeContent.addEventListener('mousemove', handleMove);
                swipeContent.addEventListener('mouseup', handleEnd);
                swipeContent.addEventListener('mouseleave', () => { if (isSwiping) handleEnd(); });
            });

            if (stockHistoryList.children.length === 0) {
                stockHistoryList.innerHTML = '<p class="text-gray-500 text-center py-4">ไม่พบข้อมูล</p>';
            }
        }


        // Make stockConfirmDeleteTransaction globally accessible
        window.stockConfirmDeleteTransaction = (rowIndex, sheetName) => {
             showCustomModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => stockDeleteTransaction(rowIndex, sheetName));
        }

        async function stockDeleteTransaction(rowIndex, sheetName) {
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const formData = new FormData();
            formData.append('action', 'deleteStockRecord');
            formData.append('rowIndex', rowIndex); formData.append('sheetId', window.userSheetId);
            formData.append('sheetName', sheetName); 
            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await response.json();
                loadingOverlay.classList.add('hidden');
                if (data.success) {
                    showNotification(successNotification, 'ลบรายการเรียบร้อยแล้ว');
                    stockFetchAndRenderHistory(); 
                    stockFetchAndRenderSummary(); 
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการลบรายการหุ้น');
                }
            } catch (error) {
                console.error('Error deleting stock data:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถลบรายการหุ้นได้: ' + error.message);
            }
        }
        
        // --- Stock Settings Form Handling ---
        async function stockFetchAndRenderSettingsForm() {
            // Explicitly check if elements are available before using them
            if (!stockStockTargetRatesContainer) {
                console.error("stockStockTargetRatesContainer is null. Cannot render settings form.");
                return;
            }
            if (!stockStockTargetExchangeRatesContainer) {
                console.error("stockStockTargetExchangeRatesContainer is null. Cannot render settings form.");
                return;
            }

            const stockSettingsSheetIdEl = document.getElementById('stockSettingsSheetId');
            if(stockSettingsSheetIdEl) stockSettingsSheetIdEl.value = window.userSheetId || ''; 
            if (!window.userSheetId) {
                // Add explicit null checks here before setting innerHTML
                if (stockStockTargetRatesContainer) {
                    stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-red-500">กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าหลักก่อน</p>';
                }
                if (stockStockTargetExchangeRatesContainer) {
                    stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-red-500">กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าหลักก่อน</p>';
                }
                return;
            }
            const formData = new FormData();
            formData.append('action', 'getStockSettings'); formData.append('sheetId', window.userSheetId);
            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.success && data.settings) {
                    stockSettings.stockTargetRates = {}; stockSettings.stockTargetExchangeRates = {};
                    for (const key in data.settings) {
                        if (key.startsWith('TargetRate_')) stockSettings.stockTargetRates[key.replace('TargetRate_', '')] = parseFloat(data.settings[key]);
                        else if (key.startsWith('ExchangeRate_')) stockSettings.stockTargetExchangeRates[key.replace('ExchangeRate_', '')] = parseFloat(data.settings[key]);
                        else if (key === 'TargetCurrency') stockSettings.targetCurrency = data.settings[key];
                    }
                    stockRenderStockTargetRates(); stockRenderStockTargetExchangeRates();
                } else {
                    if (stockStockTargetRatesContainer) {
                        stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>';
                    }
                    if (stockStockTargetExchangeRatesContainer) {
                        stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>';
                    }
                }
            } catch (error) {
                console.error('Error fetching stock settings:', error);
                showNotification(errorNotification, 'ไม่สามารถโหลดการตั้งค่าหุ้นได้: ' + error.message);
                if (stockStockTargetRatesContainer) {
                    stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-red-500">ไม่สามารถโหลดการตั้งค่าหุ้นได้</p>';
                }
                if (stockStockTargetExchangeRatesContainer) {
                    stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-red-500">ไม่สามารถโหลดการตั้งค่าหุ้นได้</p>';
                }
            }
        }

        async function stockHandleSettingsSubmit(event) {
            event.preventDefault(); 
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            showNotification(successNotification, 'บันทึกการตั้งค่าหุ้นเรียบร้อยแล้ว');
            stockFetchAndRenderSummary(); 
        }

        async function stockUpdateSettingInSheet(key, value) {
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return false;
            }
            loadingOverlay.classList.remove('hidden');
            const formData = new FormData();
            formData.append('action', 'updateStockSetting'); formData.append('sheetId', window.userSheetId);
            formData.append('key', key); formData.append('value', value);
            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await response.json();
                loadingOverlay.classList.add('hidden');
                if (data.success) {
                    showNotification(successNotification, 'อัปเดตการตั้งค่าสำเร็จ'); return true;
                } else {
                    showNotification(errorNotification, data.message || 'ไม่สามารถอัปเดตการตั้งค่าได้'); return false;
                }
            } catch (error) {
                console.error('Error updating stock setting:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถอัปเดตการตั้งค่าได้: ' + error.message); return false;
            }
        }

        function stockRenderStockTargetRates() {
            if (!stockStockTargetRatesContainer) return;
            stockStockTargetRatesContainer.innerHTML = '';
            const targetRates = Object.keys(stockSettings.stockTargetRates).sort();
            if (targetRates.length === 0) {
                stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>'; return;
            }
            targetRates.forEach(symbol => {
                const rate = stockSettings.stockTargetRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${stockSettings.targetCurrency}</span>
                    <button onclick="stockRemoveStockTargetRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `; // onclick calls global function
                stockStockTargetRatesContainer.appendChild(div);
            });
        }
        // Make stockRemoveStockTargetRate globally accessible
        window.stockRemoveStockTargetRate = (symbol) => {
            showCustomModal('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบ Rate เป้าหมายสำหรับ ${symbol}?`, async () => {
                const success = await stockUpdateSettingInSheet(`TargetRate_${symbol}`, ''); 
                if (success) {
                    delete stockSettings.stockTargetRates[symbol]; 
                    stockRenderStockTargetRates(); stockFetchAndRenderSummary();
                }
            });
        }


        async function stockHandleAddStockTargetRate() {
            const symbolInput = document.getElementById('stockNewTargetStockSymbol');
            const rateInput = document.getElementById('stockNewTargetStockRate');
            if (!symbolInput || !rateInput) return;
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);
            if (symbol && !isNaN(rate) && rate > 0) {
                const success = await stockUpdateSettingInSheet(`TargetRate_${symbol}`, rate);
                if (success) {
                    stockSettings.stockTargetRates[symbol] = rate; 
                    stockRenderStockTargetRates(); stockFetchAndRenderSummary();
                    symbolInput.value = ''; rateInput.value = '';
                }
            } else {
                showNotification(errorNotification, 'กรุณากรอกชื่อหุ้นและ Rate เป้าหมายให้ถูกต้อง');
            }
        }

        function stockRenderStockTargetExchangeRates() {
            if (!stockStockTargetExchangeRatesContainer) return;
            stockStockTargetExchangeRatesContainer.innerHTML = '';
            const exchangeRates = Object.keys(stockSettings.stockTargetExchangeRates).sort();
            if (exchangeRates.length === 0) {
                stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>'; return;
            }
            exchangeRates.forEach(symbol => {
                const rate = stockSettings.stockTargetExchangeRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toFixed(2)} THB/USD</span>
                    <button onclick="stockRemoveStockTargetUsdRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `; // onclick calls global function
                stockStockTargetExchangeRatesContainer.appendChild(div);
            });
        }
        // Make stockRemoveStockTargetUsdRate globally accessible
        window.stockRemoveStockTargetUsdRate = (symbol) => {
             showCustomModal('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบ Rate แลกเปลี่ยนเป้าหมายสำหรับ ${symbol}?`, async () => {
                const success = await stockUpdateSettingInSheet(`ExchangeRate_${symbol}`, ''); 
                if (success) {
                    delete stockSettings.stockTargetExchangeRates[symbol]; 
                    stockRenderStockTargetExchangeRates(); stockFetchAndRenderSummary();
                }
            });
        }

        async function stockHandleAddStockTargetUsdRate() {
            const symbolInput = document.getElementById('stockNewTargetStockSymbolUsd');
            const rateInput = document.getElementById('stockNewTargetUsdRate');
            if (!symbolInput || !rateInput) return;
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);
            if (symbol && !isNaN(rate) && rate > 0) {
                const success = await stockUpdateSettingInSheet(`ExchangeRate_${symbol}`, rate);
                if (success) {
                    stockSettings.stockTargetExchangeRates[symbol] = rate; 
                    stockRenderStockTargetExchangeRates(); stockFetchAndRenderSummary();
                    symbolInput.value = ''; rateInput.value = '';
                }
            } else {
                showNotification(errorNotification, 'กรุณากรอกชื่อหุ้นและ Rate แลกเปลี่ยนเป้าหมายให้ถูกต้อง');
            }
        }

        // --- Stock Summary Calculation and Rendering ---
        async function stockFetchAndRenderSummary() {
            if (!stockSummaryDashboard || !stockSummaryStockDetails) return;
            stockSummaryDashboard.innerHTML = `<div class="summary-card"><p class="summary-card-title">กำลังโหลดข้อมูล...</p><p class="summary-card-value">-</p></div>`;
            stockSummaryStockDetails.innerHTML = '<p class="text-gray-400 p-4 text-center">กำลังโหลดข้อมูลหุ้น...</p>';
            if (!window.userSheetId) {
                 stockSummaryDashboard.innerHTML = `<div class="summary-card col-span-1 sm:col-span-2"><p class="summary-card-title">ภาพรวมพอร์ตการลงทุน</p><p class="text-lg text-red-500">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p></div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-red-500 p-4 text-center">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>';
                return;
            }
            try {
                const stockTxFormData = new FormData(); stockTxFormData.append('action', 'getStockRecords'); stockTxFormData.append('sheetId', window.userSheetId);
                const stockTxResponse = await fetch(API_URL, { method: 'POST', body: stockTxFormData });
                const stockTxData = await stockTxResponse.json();
                stockTransactions = (stockTxData.success && Array.isArray(stockTxData.records)) ? stockTxData.records : [];

                calculateCurrentHoldings(); // NEW: Calculate holdings after fetching transactions
                populateStockSellSymbolDropdown(); // NEW: Populate dropdown after holdings are calculated

                const stockSettingsFormData = new FormData(); stockSettingsFormData.append('action', 'getStockSettings'); stockSettingsFormData.append('sheetId', window.userSheetId);
                const stockSettingsResponse = await fetch(API_URL, { method: 'POST', body: stockSettingsFormData });
                const stockSettingsData = await stockSettingsResponse.json();
                if (stockSettingsData.success && stockSettingsData.settings) {
                    stockSettings.stockTargetRates = {}; stockSettings.stockTargetExchangeRates = {};
                    for (const key in stockSettingsData.settings) {
                        if (key.startsWith('TargetRate_')) stockSettings.stockTargetRates[key.replace('TargetRate_', '')] = parseFloat(stockSettingsData.settings[key]);
                        else if (key.startsWith('ExchangeRate_')) stockSettings.stockTargetExchangeRates[key.replace('ExchangeRate_', '')] = parseFloat(stockSettingsData.settings[key]);
                        else if (key === 'TargetCurrency') stockSettings.targetCurrency = stockSettingsData.settings[key]; 
                    }
                } else { stockSettings.stockTargetRates = {}; stockSettings.stockTargetExchangeRates = {}; }
                stockRenderSummaryContent();
            } catch (error) {
                console.error('Error fetching stock data for summary:', error);
                stockSummaryDashboard.innerHTML = `<div class="summary-card col-span-1 sm:col-span-2"><p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลสรุปหุ้นได้: ${error.message}</p></div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-red-500 p-4 text-center">ไม่สามารถโหลดข้อมูลหุ้นรายตัวได้</p>';
            }
        }

        function stockRenderSummaryContent() {
            if (!stockSummaryDashboard || !stockSummaryStockDetails) return;
            stockSummaryDashboard.innerHTML = ''; stockSummaryStockDetails.innerHTML = '';
            if (stockTransactions.length === 0) {
                 stockSummaryDashboard.innerHTML = `<div class="summary-card col-span-1 sm:col-span-2"><p class="summary-card-title">ภาพรวมพอร์ตการลงทุน</p><p class="text-lg text-gray-300">ยังไม่มีข้อมูลการลงทุน</p><p class="text-sm text-gray-400 mt-2">กรุณาไปที่หน้า "บันทึก" เพื่อเพิ่มรายการซื้อขายแรกของคุณ</p></div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-gray-400 p-4 text-center">เมื่อมีข้อมูลแล้ว รายละเอียดหุ้นจะแสดงที่นี่</p>';
                return;
            }
            let totalInvestmentTHB = 0; const uniqueStockSymbols = new Set(); const stocksData = {};
            stockTransactions.forEach(tx => {
                const record = tx.data; 
                const type = record[1]; 
                const stockSymbol = record[2]; const quantity = parseFloat(record[3]);
                const totalAmount = parseFloat(record[4]); 
                const usdExchangeRateAtPurchase = parseFloat(record[6]); 
                if (type === 'Buy') {
                    totalInvestmentTHB += totalAmount; uniqueStockSymbols.add(stockSymbol);
                    if (!stocksData[stockSymbol]) stocksData[stockSymbol] = { totalShares: 0, totalTHBSpent: 0, totalUsdRateWeighted: 0, usdRateTxCount: 0 };
                    stocksData[stockSymbol].totalShares += quantity; stocksData[stockSymbol].totalTHBSpent += totalAmount;
                    if (usdExchangeRateAtPurchase > 0) { stocksData[stockSymbol].totalUsdRateWeighted += usdExchangeRateAtPurchase * quantity; stocksData[stockSymbol].usdRateTxCount += quantity; }
                } else if (type === 'Sell') {
                    if (stocksData[stockSymbol]) {
                        const originalShares = stocksData[stockSymbol].totalShares;
                        const originalTHBSpent = stocksData[symbol].totalTHBSpent;
                        if (originalShares > 0) { // Avoid division by zero if selling stock not previously bought (or data inconsistency)
                             const avgCostOfSoldShares = originalTHBSpent / originalShares;
                             stocksData[stockSymbol].totalTHBSpent -= (avgCostOfSoldShares * quantity);
                        }
                        stocksData[stockSymbol].totalShares -= quantity;
                    }
                }
            });
            for (const symbol in stocksData) { if (stocksData[symbol].totalShares <= 0) { delete stocksData[symbol]; uniqueStockSymbols.delete(symbol); } }

            const totalInvestmentCard = document.createElement('div'); totalInvestmentCard.className = 'summary-card';
            totalInvestmentCard.innerHTML = `<p class="summary-card-title">มูลค่าลงทุนรวม (หุ้น)</p><p class="summary-card-value">${totalInvestmentTHB.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}<span class="summary-card-currency">${stockSettings.targetCurrency}</span></p>`;
            stockSummaryDashboard.appendChild(totalInvestmentCard);
            const uniqueStocksCard = document.createElement('div'); uniqueStocksCard.className = 'summary-card';
            uniqueStocksCard.innerHTML = `<p class="summary-card-title">จำนวนหุ้นที่ถือครอง</p><p class="summary-card-value">${uniqueStockSymbols.size}<span class="summary-card-currency">ตัว</span></p><p class="text-xs text-gray-400 mt-1">หุ้นที่ไม่ซ้ำกัน</p>`;
            stockSummaryDashboard.appendChild(uniqueStocksCard);
            if (Object.keys(stocksData).length === 0) stockSummaryStockDetails.innerHTML = `<p class="text-gray-400 p-4 text-center">ยังไม่มีข้อมูลหุ้นรายตัว</p>`;
            Object.keys(stocksData).sort().forEach(stockSymbol => { // Changed 'symbol' to 'stockSymbol'
                const data = stocksData[stockSymbol];
                const averageCostPerShare = data.totalShares > 0 ? data.totalTHBSpent / data.totalShares : 0;
                const actualAverageUsdRateAtPurchase = data.totalShares > 0 && data.usdRateTxCount > 0 ? data.totalUsdRateWeighted / data.usdRateTxCount : 0; // Corrected this line, should be totalUsdRateWeighted / totalShares if weighted by shares
                const targetRate = stockSettings.stockTargetRates[stockSymbol] || 0;
                const targetUsdExchangeRate = stockSettings.stockTargetExchangeRates[stockSymbol] || 0;
                const iconColor = stockGetStockIconColor(stockSymbol);
                let displayValue = data.totalTHBSpent >= 1000000 ? (data.totalTHBSpent / 1000000).toFixed(1) + 'M' : (data.totalTHBSpent >= 1000 ? (data.totalTHBSpent / 1000).toFixed(0) + 'K' : data.totalTHBSpent.toFixed(0));
                const stockItemContainer = document.createElement('div'); stockItemContainer.className = 'stock-list-item-container mb-3';
                const stockDiv = document.createElement('div'); stockDiv.className = 'stock-list-item';
                stockDiv.innerHTML = `
                    <div class="stock-icon-placeholder ${iconColor}">${stockSymbol.charAt(0)}</div>
                    <div class="stock-info">
                        <h3 class="stock-info-title">${stockSymbol}</h3>
                        <p class="text-sm text-gray-500">จำนวนหุ้น: ${data.totalShares.toLocaleString(undefined, {minimumFractionDigits: 7, maximumFractionDigits: 7})}</p>
                        <p class="text-sm text-gray-500">ต้นทุนเฉลี่ย (THB/หุ้น): ${averageCostPerShare.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</p>
                        ${actualAverageUsdRateAtPurchase > 0 ? `<p class="text-sm text-gray-500">Rate แลกเปลี่ยนเฉลี่ย (THB/USD): ${actualAverageUsdRateAtPurchase.toFixed(2)}</p>` : ''}
                        ${targetRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมายราคา (THB/หุ้น): ${targetRate.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</p>` : ''}
                        ${targetUsdExchangeRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมาย Rate แลกเปลี่ยน (THB/USD): ${targetUsdExchangeRate.toFixed(2)}</p>` : ''}
                    </div>
                    <div class="stock-value-tag"><span class="value-amount">${displayValue}</span><span class="value-label">${stockSettings.targetCurrency}</span></div>`;
                const actionsDiv = document.createElement('div'); actionsDiv.className = 'stock-actions hidden';
                actionsDiv.innerHTML = `
                    <div class="grid grid-cols-1 gap-2">
                         <div><label for="currentMarketPrice_${stockSymbol}" class="block text-xs font-medium text-gray-700 mb-1">Rate ปัจจุบัน (ราคาตลาด/หุ้น):</label><input type="number" id="currentMarketPrice_${stockSymbol}" step="any" placeholder="กรอกราคาตลาด" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500"></div>
                        <button onclick="stockCalculateAdditionalPurchase('${stockSymbol}', ${data.totalShares}, ${data.totalTHBSpent}, ${targetRate})" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs">คำนวณซื้อเพิ่ม</button>
                    </div>
                    <div id="additionalPurchaseResult_${stockSymbol}" class="mt-2 text-xs text-gray-600"></div>`;
                stockItemContainer.appendChild(stockDiv); stockItemContainer.appendChild(actionsDiv); stockSummaryStockDetails.appendChild(stockItemContainer);
                stockDiv.addEventListener('click', () => { actionsDiv.classList.toggle('hidden'); if (!actionsDiv.classList.contains('hidden')) setTimeout(() => actionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100); });
            });
        }

        // Make stockCalculateAdditionalPurchase globally accessible
        window.stockCalculateAdditionalPurchase = (symbol, currentShares, currentTotalCost, targetAvgPrice) => {
            const marketPriceInput = document.getElementById(`currentMarketPrice_${symbol}`);
            const resultDiv = document.getElementById(`additionalPurchaseResult_${symbol}`);
            if(!marketPriceInput || !resultDiv) return;
            const marketPrice = parseFloat(marketPriceInput.value);
            resultDiv.innerHTML = '';
            if (isNaN(marketPrice) || marketPrice <= 0) { resultDiv.innerHTML = '<p class="text-red-600">กรุณากรอกราคาตลาดปัจจุบันให้ถูกต้อง</p>'; return; }
            if (targetAvgPrice <= 0) { resultDiv.innerHTML = '<p class="text-orange-600">กรุณาตั้ง Rate เป้าหมายสำหรับหุ้นนี้ในหน้า "ตั้งค่า" ก่อน</p>'; return; }
            if (Math.abs(marketPrice - targetAvgPrice) < 0.001) {
                const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) resultDiv.innerHTML = `<p class="text-green-600">ต้นทุนเฉลี่ยและราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมายแล้ว ไม่จำเป็นต้องซื้อเพิ่ม</p>`;
                else resultDiv.innerHTML = `<p class="text-orange-600">ราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมาย ไม่สามารถใช้สูตรนี้เพื่อปรับ Rate เฉลี่ยได้โดยตรง</p>`;
                return;
            }
            const amountTHBtoBuy = (targetAvgPrice * currentShares - currentTotalCost) * marketPrice / (marketPrice - targetAvgPrice);
            let message = '';
            if (amountTHBtoBuy > 0) {
                const newShares = amountTHBtoBuy / marketPrice; const newTotalShares = currentShares + newShares;
                const newTotalCost = currentTotalCost + amountTHBtoBuy; const newAvgCost = newTotalCost / newTotalShares;
                message = `<p class="text-green-700 font-semibold">หากต้องการ Rate เฉลี่ยที่ ${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}:</p><ul class="list-disc list-inside ml-2 mt-1"><li>ซื้อเพิ่ม: <strong class="font-medium">${amountTHBtoBuy.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</strong></li><li>(ที่ราคา ${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}/หุ้น)</li><li>ได้หุ้นเพิ่ม: ${newShares.toLocaleString(undefined, {minimumFractionDigits: 7})} หุ้น</li><li>Rate เฉลี่ยใหม่: ${newAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${stockSettings.targetCurrency}</li></ul>`;
            } else {
                 const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                 if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) message = `<p class="text-green-600">ต้นทุนเฉลี่ยปัจจุบันของคุณอยู่ที่ประมาณ Rate เป้าหมายแล้ว (${currentAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}).</p>`;
                 else if (targetAvgPrice > currentAvgCost && marketPrice < targetAvgPrice) message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยต่ำลง/เข้าใกล้ราคาตลาด</p`;
                 else if (targetAvgPrice < currentAvgCost && marketPrice > targetAvgPrice) message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยสูงขึ้น/เข้าใกล้ราคาตลาด</p>`;
                 else message = `<p class="text-orange-500">การซื้อหุ้นที่ราคาตลาดปัจจุบัน (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) อาจไม่ช่วยให้ไปถึง Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ตามที่ต้องการ หรือเงื่อนไขไม่เหมาะสม</p>`;
            }
            resultDiv.innerHTML = message;
        }

        // --- Stock Sell Modal Functions ---
        function stockOpenSellModal(symbol, quantityAvailable, usdCostPerShare, averageExchangeRate) {
            if (!stockSellModalOverlay || !stockSellModalSymbolDisplay || !stockSellModalDate || !stockSellModalQuantityInput || !stockSellModalUsdExchangeRateAtSaleInput) return;
            
            stockSellModalSymbolDisplay.textContent = symbol;
            stockSellModalDate.valueAsDate = new Date(); // Set current date
            
            // Display total available quantity for this symbol
            stockSellModalQuantityInput.value = quantityAvailable; // Pre-fill with total available
            stockSellModalQuantityInput.max = quantityAvailable; // Set max attribute for input

            stockSellModalUsdPricePerShareInput.value = usdCostPerShare.toFixed(4); // Pre-fill with purchase price for convenience
            stockSellModalUsdExchangeRateAtSaleInput.value = averageExchangeRate.toFixed(2); // Pre-fill with average purchase exchange rate

            stockCalculateSellModalAmounts(); // Calculate initial THB received and price per share

            stockSellModalOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling background
        }

        function stockCloseSellModal() {
            if (!stockSellModalOverlay || !stockSellModalForm) return;
            stockSellModalOverlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
            stockSellModalForm.reset(); // Clear form fields
            stockCalculateSellModalAmounts(); // Reset calculated fields
        }

        function stockCalculateSellModalAmounts() {
            if (!stockSellModalQuantityInput || !stockSellModalUsdPricePerShareInput || !stockSellModalUsdExchangeRateAtSaleInput || !stockSellModalTotalTHBReceivedInput || !stockSellModalPricePerShareInput) return;
            const quantity = parseFloat(stockSellModalQuantityInput.value) || 0;
            const usdSellPricePerShare = parseFloat(stockSellModalUsdPricePerShareInput.value) || 0;
            const usdExchangeRateAtSale = parseFloat(stockSellModalUsdExchangeRateAtSaleInput.value) || 0;
            let totalTHBReceived = 0; let sellPricePerShareTHB = 0;
            if (quantity > 0 && usdSellPricePerShare > 0 && usdExchangeRateAtSale > 0) {
                totalTHBReceived = quantity * usdSellPricePerShare * usdExchangeRateAtSale;
                sellPricePerShareTHB = totalTHBReceived / quantity;
            }
            stockSellModalTotalTHBReceivedInput.value = totalTHBReceived.toFixed(2);
            stockSellModalPricePerShareInput.value = sellPricePerShareTHB.toFixed(2);
        }

        async function stockHandleSellModalSubmit(event) {
            event.preventDefault();
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }
            stockCalculateSellModalAmounts();
            const date = stockSellModalDate.value;
            const stockSymbol = stockSellModalSymbolDisplay.textContent.trim(); // Get symbol from modal title
            const quantity = parseFloat(stockSellModalQuantityInput.value);
            const usdSellPricePerShare = parseFloat(stockSellModalUsdPricePerShareInput.value);
            const usdExchangeRateAtSale = parseFloat(stockSellModalUsdExchangeRateAtSaleInput.value);
            const totalTHBReceived = parseFloat(stockSellModalTotalTHBReceivedInput.value);
            const sellPricePerShare = parseFloat(stockSellModalPricePerShareInput.value);

            // --- Validation for selling shares ---
            if (isNaN(quantity) || quantity <= 0) {
                showNotification(errorNotification, 'กรุณากรอกจำนวนหุ้นที่ต้องการขายให้ถูกต้อง (ต้องมากกว่า 0)');
                return;
            }
            if (!currentStockHoldings[stockSymbol] || currentStockHoldings[stockSymbol].quantity < quantity) {
                showNotification(errorNotification, `จำนวนหุ้นที่ต้องการขาย (${quantity} หุ้น) เกินจำนวนที่มีอยู่ (${currentStockHoldings[stockSymbol].quantity || 0} หุ้น) สำหรับหุ้น ${stockSymbol}`);
                return;
            }
            // --- End Validation ---

            if (!date || !stockSymbol || isNaN(usdSellPricePerShare) || usdSellPricePerShare <= 0 || isNaN(usdExchangeRateAtSale) || usdExchangeRateAtSale <= 0 || isNaN(totalTHBReceived) || totalTHBReceived < 0 || isNaN(sellPricePerShare) || sellPricePerShare < 0) {
                showNotification(errorNotification, 'กรุณากรอกข้อมูลการขายหุ้นให้ครบถ้วนและถูกต้อง (USD ต่อหุ้น, จำนวนหุ้น, Rate THB/USD ต้องมากกว่า 0)');
                return;
            }
            loadingOverlay.classList.remove('hidden');
            const submitButton = event.submitter; if (submitButton) submitButton.disabled = true;
            const apiFormData = new FormData();
            apiFormData.append('action', 'saveStockSaleRecord'); 
            apiFormData.append('sheetId', window.userSheetId);
            apiFormData.append('date', date); apiFormData.append('stockSymbol', stockSymbol);
            apiFormData.append('quantity', quantity); apiFormData.append('usdSellPricePerShare', usdSellPricePerShare); 
            apiFormData.append('usdExchangeRateAtSale', usdExchangeRateAtSale);
            apiFormData.append('totalTHBReceived', totalTHBReceived); apiFormData.append('sellPricePerShare', sellPricePerShare); 

            try {
                const response = await fetch(API_URL, { method: 'POST', body: apiFormData });
                const data = await response.json();
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                if (data.success) {
                    showNotification(successNotification, 'บันทึกรายการขายหุ้นเรียบร้อยแล้ว');
                    stockCloseSellModal();
                    stockFetchAndRenderHistory(); 
                    stockFetchAndRenderSummary(); 
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกรายการขายหุ้น');
                }
            } catch (error) {
                console.error('Error saving stock sale record:', error);
                loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                showNotification(errorNotification, 'ไม่สามารถบันทึกรายการขายหุ้นได้: ' + error.message);
            }
        }

        // NEW: Function to calculate current stock holdings and average exchange rates
        function calculateCurrentHoldings() {
            currentStockHoldings = {};
            stockTransactions.forEach(tx => {
                const type = tx.type; // 'Buy' or 'Sell'
                const symbol = tx.data[2];
                const quantity = parseFloat(tx.data[3]);
                const usdExchangeRate = parseFloat(tx.data[6]); // Exchange rate for this transaction

                if (!currentStockHoldings[symbol]) {
                    currentStockHoldings[symbol] = {
                        quantity: 0,
                        totalWeightedExchangeRate: 0,
                        totalQuantityForExchangeRate: 0
                    };
                }

                if (type === 'Buy') {
                    currentStockHoldings[symbol].quantity += quantity;
                    currentStockHoldings[symbol].totalWeightedExchangeRate += quantity * usdExchangeRate;
                    currentStockHoldings[symbol].totalQuantityForExchangeRate += quantity;
                } else if (type === 'Sell') {
                    currentStockHoldings[symbol].quantity -= quantity;
                    // For selling, we don't adjust the weighted average of *purchases*.
                    // The average rate is purely based on the cost of shares *held*.
                    // If shares are sold, the average cost of the *remaining* shares doesn't change unless new shares are bought.
                }
            });

            // Calculate average exchange rate for each stock with positive holdings
            for (const symbol in currentStockHoldings) {
                if (currentStockHoldings[symbol].quantity <= 0) {
                    delete currentStockHoldings[symbol]; // Remove stocks with zero or negative holdings
                } else if (currentStockHoldings[symbol].totalQuantityForExchangeRate > 0) {
                    currentStockHoldings[symbol].averageExchangeRate = 
                        currentStockHoldings[symbol].totalWeightedExchangeRate / currentStockHoldings[symbol].totalQuantityForExchangeRate;
                } else {
                    currentStockHoldings[symbol].averageExchangeRate = 0; // Should not happen if quantity > 0 and only buys contribute
                }
            }
            console.log("Current Stock Holdings (with average rates):", currentStockHoldings);
        }

        // NEW: Function to populate the stock sell symbol dropdown
        function populateStockSellSymbolDropdown() {
            const selectElement = document.getElementById('stockSellStockSymbol');
            if (!selectElement) return;

            selectElement.innerHTML = '<option value="">เลือกหุ้น</option>'; // Clear and add default

            const sortedSymbols = Object.keys(currentStockHoldings).sort();

            sortedSymbols.forEach(symbol => {
                if (currentStockHoldings[symbol].quantity > 0) { // Only show stocks with positive holdings
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = `${symbol} (คงเหลือ: ${currentStockHoldings[symbol].quantity.toLocaleString(undefined, {minimumFractionDigits: 7, maximumFractionDigits: 7})} หุ้น)`;
                    selectElement.appendChild(option);
                }
            });

            // Add event listener for when the dropdown value changes
            selectElement.removeEventListener('change', handleStockSellSymbolChange); // Remove previous to prevent duplicates
            selectElement.addEventListener('change', handleStockSellSymbolChange);
        }

        // NEW: Handler for stock sell symbol dropdown change
        function handleStockSellSymbolChange() {
            const selectedSymbol = stockSellStockSymbolSelect.value;
            if (selectedSymbol && currentStockHoldings[selectedSymbol]) {
                const avgRate = currentStockHoldings[selectedSymbol].averageExchangeRate || 0;
                stockSellUsdExchangeRateAtSaleInput.value = avgRate.toFixed(2);
                stockSellQuantityInput.max = currentStockHoldings[selectedSymbol].quantity; // Update max quantity
                stockSellQuantityInput.value = currentStockHoldings[selectedSymbol].quantity; // Pre-fill with max
                stockCalculateSellAmounts(); // Recalculate amounts
            } else {
                stockSellUsdExchangeRateAtSaleInput.value = '';
                stockSellQuantityInput.max = '';
                stockSellQuantityInput.value = '';
                stockCalculateSellAmounts(); // Clear amounts
            }
        }


        // Main application initialization function.
        function initializeAppComponent() {
            const buyForm = document.getElementById('usdBuyForm'); 
            const thbAmountInput = document.getElementById('thbAmount');
            const exchangeRateInput = document.getElementById('exchangeRate');
            const usdResultElement = document.getElementById('usdResult');
            const refreshButton = document.getElementById('refreshButton');
            const refreshSummaryButton = document.getElementById('refreshSummaryButton');
            const navItems = document.querySelectorAll('.nav-item');
            const indicators = document.querySelectorAll('.indicator');
            const sellForm = document.getElementById('usdSellForm');
            const usdSellAmountInput = document.getElementById('usdSellAmount');
            const exchangeRateSellInput = document.getElementById('exchangeRateSell');
            const thbReceiveResultElement = document.getElementById('thbReceiveResult');
            const buyFormToggleBtn = document.getElementById('buyFormToggleBtn');
            const sellFormToggleBtn = document.getElementById('sellFormToggleBtn');
            const buyFormContainer = document.getElementById('buyFormContainer');
            const sellFormContainer = document.getElementById('sellFormContainer');
            const usdSubNavItems = document.querySelectorAll('.usd-sub-nav-item');
            const usdSubViews = {
                usdSummarySubView: document.getElementById('usdSummarySubView'),
                usdRecordSubView: document.getElementById('usdRecordSubView'),
                usdHistorySubView: document.getElementById('usdHistorySubView'),
                usdSettingsSubView: document.getElementById('usdSettingsSubView')
            };
            const usdMainContentScroller = document.querySelector('#usdMainView .flex-grow.overflow-y-auto'); 
            const sheetIdInput = document.getElementById('sheetIdInput');
            const saveSheetIdButton = document.getElementById('saveSheetIdButton');
            const displayUserId = document.getElementById('displayUserId');
            const signOutButtonSettings = document.getElementById('signOutButtonSettings'); 
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            
            swiperInstance = new Swiper(".mySwiper", { 
                initialSlide: 0, effect: "slide", speed: 300, 
                allowTouchMove: false, resistance: true, resistanceRatio: 0.85,
                on: {
                    slideChange: function() { updateNavigation(this.activeIndex); },
                    slideChangeTransitionEnd: function() {
                        if (this.activeIndex === 0) usdNavigateTo('usdSummarySubView');
                        else if (this.activeIndex === 1) stockLoadTradingViewWidget();
                        else if (this.activeIndex === 2) stockNavigateTo('stockSummaryView');
                    },
                    touchStart: (swiper) => { swiper.allowTouchMove = !!window.userId; },
                    touchEnd: (swiper) => { swiper.allowTouchMove = !!window.userId; }
                }
            });

            function updateNavigation(index) {
                navItems.forEach((item, i) => item.classList.toggle('active', i === index));
                indicators.forEach((indicator, i) => indicator.classList.toggle('active', i === index));
            }

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetIndex = parseInt(this.getAttribute('data-index')); 
                    if (window.userId) { if (swiperInstance) swiperInstance.slideTo(targetIndex); } 
                    else { showNotification(errorNotification, 'กรุณาเข้าสู่ระบบก่อน'); }
                });
            });

            function usdNavigateTo(subViewId) {
                Object.values(usdSubViews).forEach(view => { if (view) view.classList.add('hidden'); });
                if (usdSubViews[subViewId]) {
                    usdSubViews[subViewId].classList.remove('hidden');
                    if (usdMainContentScroller) usdMainContentScroller.scrollTop = 0;
                }
                usdSubNavItems.forEach(item => {
                    if (item) { item.classList.remove('active'); if (item.dataset.usdSubView === subViewId) item.classList.add('active'); }
                });
                if (subViewId === 'usdSummarySubView') {
                    if (window.userSheetId) fetchSummary();
                    else if (window.userId) showNotification(errorNotification, 'กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                    else { /* Show login prompt in cards */ }
                } else if (subViewId === 'usdRecordSubView') {
                    const today = new Date().toISOString().split('T')[0];
                    const dateEl = document.getElementById('date');
                    const dateSellEl = document.getElementById('dateSell');
                    if(dateEl) dateEl.value = today;
                    if(dateSellEl) dateSellEl.value = today;
                    calculateUSD(); calculateTHBForSale();
                    if(buyFormToggleBtn) buyFormToggleBtn.click();
                } else if (subViewId === 'usdHistorySubView') fetchHistory();
                else if (subViewId === 'usdSettingsSubView') {
                    const sheetIdInputEl = document.getElementById('sheetIdInput');
                    if(sheetIdInputEl) sheetIdInputEl.value = window.userSheetId || '';
                }
            }
            usdSubNavItems.forEach(item => item.addEventListener('click', function() { usdNavigateTo(this.dataset.usdSubView); }));

            function calculateUSD() {
                if(!thbAmountInput || !exchangeRateInput || !usdResultElement) return;
                const thbAmount = parseFloat(thbAmountInput.value) || 0; 
                const exchangeRate = parseFloat(exchangeRateInput.value) || 0; 
                usdResultElement.textContent = (thbAmount > 0 && exchangeRate > 0) ? (thbAmount / exchangeRate).toFixed(2) + ' USD' : '0.00 USD';
            }
            function calculateTHBForSale() {
                if(!usdSellAmountInput || !exchangeRateSellInput || !thbReceiveResultElement) return;
                const usdAmount = parseFloat(usdSellAmountInput.value) || 0;
                const exchangeRate = parseFloat(exchangeRateSellInput.value) || 0;
                thbReceiveResultElement.textContent = (usdAmount > 0 && exchangeRate > 0) ? (usdAmount * exchangeRate).toFixed(2) + ' ฿' : '0.00 ฿';
            }

            if(thbAmountInput) thbAmountInput.addEventListener('input', calculateUSD);
            if(exchangeRateInput) exchangeRateInput.addEventListener('input', calculateUSD);
            if(usdSellAmountInput) usdSellAmountInput.addEventListener('input', calculateTHBForSale);
            if(exchangeRateSellInput) exchangeRateSellInput.addEventListener('input', calculateTHBForSale);

            if(buyForm) buyForm.addEventListener('submit', async function(e) { 
                e.preventDefault(); 
                const date = document.getElementById('date').value;
                const thbAmount = parseFloat(thbAmountInput.value);
                const exchangeRate = parseFloat(exchangeRateInput.value);
                if (!date || isNaN(thbAmount) || thbAmount <= 0 || isNaN(exchangeRate) || exchangeRate <= 0) { // Ensure positive values
                    showNotification(errorNotification, 'กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (จำนวนเงินและอัตราแลกเปลี่ยนต้องมากกว่า 0)'); 
                    return;
                }
                if (!window.userSheetId) { showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน'); return; }
                loadingOverlay.classList.remove('hidden');
                const submitButton = e.submitter; if (submitButton) submitButton.disabled = true;
                const formData = new FormData();
                formData.append('action', 'save'); formData.append('date', date);
                formData.append('thbAmount', thbAmount); formData.append('exchangeRate', exchangeRate);
                formData.append('sheetId', window.userSheetId); 
                try { 
                    const response = await fetch(API_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    const data = await response.json();
                    loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                    if (data.success) {
                        showNotification(successNotification); 
                        if(thbAmountInput) thbAmountInput.value = ''; if(exchangeRateInput) exchangeRateInput.value = ''; 
                        if(usdResultElement) usdResultElement.textContent = '0.00 USD';
                        setTimeout(() => { if (swiperInstance) { swiperInstance.slideTo(0); usdNavigateTo('usdSummarySubView'); } }, 1000);
                    } else { showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล'); }
                } catch (error) {
                    console.error('Error saving data:', error); 
                    loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                    showNotification(errorNotification, 'ไม่สามารถบันทึกข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง'); 
                }
            });

            if(sellForm) sellForm.addEventListener('submit', async function(e) { 
                e.preventDefault();
                const date = document.getElementById('dateSell').value;
                const usdAmount = parseFloat(usdSellAmountInput.value);
                const exchangeRate = parseFloat(exchangeRateSellInput.value);
                if (!date || isNaN(usdAmount) || usdAmount <= 0 || isNaN(exchangeRate) || exchangeRate <= 0) { // Ensure positive values
                    showNotification(errorNotification, 'กรุณากรอกข้อมูลการขายให้ครบถ้วนและถูกต้อง (จำนวนเงินและอัตราแลกเปลี่ยนต้องมากกว่า 0)');
                    return;
                }
                if (!window.userSheetId) { showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน'); return; }
                loadingOverlay.classList.remove('hidden');
                const submitButton = e.submitter; if (submitButton) submitButton.disabled = true;
                const formData = new FormData();
                formData.append('action', 'saveSale'); formData.append('date', date);
                formData.append('usdAmount', usdAmount); formData.append('exchangeRate', exchangeRate);
                formData.append('sheetId', window.userSheetId);
                try { 
                    const response = await fetch(API_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    const data = await response.json();
                    loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                    if (data.success) {
                        showNotification(successNotification, 'บันทึกการขายสำเร็จ');
                        if(usdSellAmountInput) usdSellAmountInput.value = ''; if(exchangeRateSellInput) exchangeRateSellInput.value = ''; 
                        if(thbReceiveResultElement) thbReceiveResultElement.textContent = '0.00 ฿';
                        setTimeout(() => { if (swiperInstance) { swiperInstance.slideTo(0); usdNavigateTo('usdSummarySubView'); } }, 1000);
                    } else { showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกการขาย'); }
                } catch (error) {
                    console.error('Error saving sale data:', error);
                    loadingOverlay.classList.add('hidden'); if (submitButton) submitButton.disabled = false; 
                    showNotification(errorNotification, 'ไม่สามารถบันทึกการขายได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง');
                }
            });

            if(buyFormToggleBtn) buyFormToggleBtn.addEventListener('click', () => {
                buyFormToggleBtn.classList.add('active-toggle'); buyFormToggleBtn.classList.remove('active-sale-toggle'); 
                if(sellFormToggleBtn) { sellFormToggleBtn.classList.remove('active-toggle'); sellFormToggleBtn.classList.remove('active-sale-toggle'); }
                if(buyFormContainer) buyFormContainer.classList.remove('hidden'); if(sellFormContainer) sellFormContainer.classList.add('hidden');
            });
            if(sellFormToggleBtn) sellFormToggleBtn.addEventListener('click', () => {
                sellFormToggleBtn.classList.add('active-sale-toggle'); sellFormToggleBtn.classList.remove('active-toggle'); 
                if(buyFormToggleBtn) { buyFormToggleBtn.classList.remove('active-toggle'); buyFormToggleBtn.classList.remove('active-sale-toggle'); }
                if(buyFormContainer) buyFormContainer.classList.add('hidden'); if(sellFormContainer) sellFormContainer.classList.remove('hidden');
            });
            if(buyFormToggleBtn) buyFormToggleBtn.click();

            document.addEventListener('click', (e) => { if (activeSwipeItem && !activeSwipeItem.contains(e.target) && !e.target.closest('.delete-reveal')) closeActiveSwipeItem(); });
            if(refreshButton) refreshButton.addEventListener('click', fetchHistory);
            if(refreshSummaryButton) refreshSummaryButton.addEventListener('click', fetchSummary); 

            function setTheme(isDark) {
                body.classList.toggle('light-theme', !isDark);
                if (stockCurrentTradingViewSymbol && stockTradingViewWidgetContainer) stockLoadTradingViewWidget(); 
            }
            if(themeToggle) { setTheme(themeToggle.checked); themeToggle.addEventListener('change', function() { setTheme(this.checked); }); }
            
            const notificationToggle = document.getElementById('notificationToggle');
            if(notificationToggle) notificationToggle.addEventListener('change', function() { console.log('Notification toggle:', this.checked ? 'On' : 'Off'); });

            if(saveSheetIdButton) saveSheetIdButton.addEventListener('click', async function() {
                if(!sheetIdInput) return;
                const newSheetId = sheetIdInput.value.trim();
                if (newSheetId) {
                    loadingOverlay.classList.remove('hidden');
                    const success = await saveUserSheetId(newSheetId); 
                    loadingOverlay.classList.add('hidden');
                    if (success) { showNotification(successNotification, 'บันทึก Google Sheet ID สำเร็จ'); usdNavigateTo('usdSummarySubView'); } 
                    else { showNotification(errorNotification, 'ไม่สามารถบันทึก Google Sheet ID ได้'); }
                } else { showNotification(errorNotification, 'กรุณาป้อน Google Sheet ID'); }
            });

            if (signInModalButton) signInModalButton.addEventListener('click', () => { if(loginModalEmailInput && loginModalPasswordInput) handleSignInWithEmailPassword(loginModalEmailInput.value, loginModalPasswordInput.value); });
            if (signUpModalSubmitButton) signUpModalSubmitButton.addEventListener('click', () => { 
                if(signUpModalEmailInput && signUpModalPasswordInput && signUpModalConfirmPasswordInput) {
                    if (signUpModalPasswordInput.value !== signUpModalConfirmPasswordInput.value) { showNotification(errorNotification, 'รหัสผ่านไม่ตรงกัน'); return; }
                    signUpWithEmailPassword(signUpModalEmailInput.value, signUpModalPasswordInput.value); 
                }
            });
            
            if (signOutButtonSettings) signOutButtonSettings.addEventListener('click', signOutUser);
            if (loginModalToggleSignIn) loginModalToggleSignIn.addEventListener('click', () => {
                loginModalToggleSignIn.classList.add('active-login-tab'); if(loginModalToggleSignUp) loginModalToggleSignUp.classList.remove('active-login-tab');
                if(loginModalFormContainer) loginModalFormContainer.classList.remove('hidden'); if(signUpModalFormContainer) signUpModalFormContainer.classList.add('hidden');
            });
            if (loginModalToggleSignUp) loginModalToggleSignUp.addEventListener('click', () => {
                loginModalToggleSignUp.classList.add('active-login-tab'); if(loginModalToggleSignIn) loginModalToggleSignIn.classList.remove('active-login-tab');
                if(signUpModalFormContainer) signUpModalFormContainer.classList.remove('hidden'); if(loginModalFormContainer) loginModalFormContainer.classList.add('hidden');
            });
            if (loginModalToggleSignIn) loginModalToggleSignIn.click();

            // --- Initialize Stock App Elements and Event Listeners ---
            stockMainContent = document.querySelector('#stockManagementView .flex-grow.overflow-y-auto'); // Corrected selector
            stockNavItems = document.querySelectorAll('.stock-nav-item');
            stockViews = {
                stockSummaryView: document.getElementById('stockSummaryView'),
                stockRecordView: document.getElementById('stockRecordView'),
                stockHistoryView: document.getElementById('stockHistoryView'),
                stockSettingsView: document.getElementById('stockSettingsView')
            };
            stockRecordForm = document.getElementById('stockRecordForm');
            stockSellForm = document.getElementById('stockSellForm'); 
            stockSettingsForm = document.getElementById('stockSettingsForm');
            stockHistoryList = document.getElementById('stockHistoryList'); // Changed from stockHistoryTableBody
            stockHistorySearchInput = document.getElementById('stockHistorySearchInput');
            stockSummaryDashboard = document.getElementById('stockSummaryDashboard');
            stockSummaryStockDetails = document.getElementById('stockSummaryStockDetails');
            stockStockTargetRatesContainer = document.getElementById('stockTargetRatesContainer');
            console.log('Assigned stockStockTargetRatesContainer:', stockStockTargetRatesContainer); // Debug log
            stockAddStockTargetRateBtn = document.getElementById('stockAddStockTargetRateBtn');
            stockStockTargetExchangeRatesContainer = document.getElementById('stockTargetExchangeRatesContainer');
            console.log('Assigned stockStockTargetExchangeRatesContainer:', stockStockTargetExchangeRatesContainer); // Debug log
            stockAddStockTargetUsdRateBtn = document.getElementById('stockAddStockTargetUsdRateBtn');
            stockTvSymbolInput = document.getElementById('stockTvSymbolInput');
            stockTvLoadSymbolBtn = document.getElementById('stockTvLoadSymbolBtn');
            stockTvFullscreenBtn = document.getElementById('stockTvFullscreenBtn');
            stockTradingViewWidgetContainer = document.getElementById('stockTradingViewWidgetContainer');
            stockTradingViewFullscreenModal = document.getElementById('tradingViewFullscreenModal'); 
            stockTradingViewFullscreenContent = document.getElementById('tradingViewFullscreenContent'); 
            stockCloseTradingViewFullscreenBtn = document.getElementById('closeTradingViewFullscreenBtn'); 
            stockBuyUsdAmountPerShareInput = document.getElementById('stockRecordUsdAmountPerShare');
            stockBuyUsdExchangeRateAtPurchaseInput = document.getElementById('stockRecordUsdRate');
            stockBuyQuantityInput = document.getElementById('stockRecordQuantity');
            stockBuyCalculatedTotalTHBInput = document.getElementById('stockRecordTotalTHB');
            stockBuyCalculatedPricePerShareInput = document.getElementById('stockRecordPricePerShare');
            // Stock Sell Form elements (main form)
            stockSellStockSymbolSelect = document.getElementById('stockSellStockSymbol'); // Changed to select
            stockSellQuantityInput = document.getElementById('stockSellQuantity');
            stockSellUsdSellPricePerShareInput = document.getElementById('stockSellUsdPricePerShare');
            stockSellUsdExchangeRateAtSaleInput = document.getElementById('stockSellUsdRate');
            stockSellCalculatedTotalTHBReceivedInput = document.getElementById('stockSellTotalTHBReceived');
            stockSellCalculatedSellPricePerShareInput = document.getElementById('stockSellPricePerShare');

            // Stock Sell Modal elements
            stockSellModalOverlay = document.getElementById('stockSellModalOverlay');
            stockSellModalTitle = document.getElementById('stockSellModalTitle');
            stockSellModalSymbolDisplay = document.getElementById('stockSellModalSymbolDisplay');
            closeStockSellModalBtn = document.getElementById('closeStockSellModalBtn'); // This is the close button for the sell stock modal
            stockSellModalForm = document.getElementById('stockSellModalForm');
            stockSellModalDate = document.getElementById('stockSellModalDate');
            stockSellModalUsdPricePerShareInput = document.getElementById('stockSellModalUsdPricePerShare');
            stockSellModalQuantityInput = document.getElementById('stockSellModalQuantity');
            stockSellModalUsdExchangeRateAtSaleInput = document.getElementById('stockSellModalUsdRate');
            stockSellModalTotalTHBReceivedInput = document.getElementById('stockSellModalTotalTHBReceived');
            stockSellModalPricePerShareInput = document.getElementById('stockSellModalPricePerShare');
            stockSellModalSubmitBtn = document.getElementById('stockSellModalSubmitBtn');

            const stockBuyFormToggleBtn = document.getElementById('stockBuyFormToggleBtn');
            const stockSellFormToggleBtn = document.getElementById('stockSellFormToggleBtn');
            const stockBuyFormContainer = document.getElementById('stockBuyFormContainer');
            const stockSellFormContainer = document.getElementById('stockSellFormContainer');
            const refreshStockHistoryButton = document.getElementById('refreshStockHistoryButton');


            stockNavItems.forEach(item => item.addEventListener('click', () => stockNavigateTo(item.dataset.stockView)));
            if (stockRecordForm) stockRecordForm.addEventListener('submit', stockHandleRecordSubmit);
            if (stockSellForm) stockSellForm.addEventListener('submit', stockHandleSellRecordSubmit); // Main sell form submit listener
            if (stockSettingsForm) stockSettingsForm.addEventListener('submit', stockHandleSettingsSubmit); 
            if (stockAddStockTargetRateBtn) stockAddStockTargetRateBtn.addEventListener('click', stockHandleAddStockTargetRate);
            if (stockAddStockTargetUsdRateBtn) stockAddStockTargetUsdRateBtn.addEventListener('click', stockHandleAddStockTargetUsdRate);
            if (stockHistorySearchInput) stockHistorySearchInput.addEventListener('input', () => stockFetchAndRenderHistory(stockHistorySearchInput.value.trim())); 
            if (stockTvLoadSymbolBtn) stockTvLoadSymbolBtn.addEventListener('click', stockLoadTradingViewWidget); // Added listener for load button
            if (stockTvFullscreenBtn) stockTvFullscreenBtn.addEventListener('click', stockOpenTradingViewFullscreen);
            if (stockCloseTradingViewFullscreenBtn) stockCloseTradingViewFullscreenBtn.addEventListener('click', stockCloseTradingViewFullscreen);
            
            const stockRecordDateEl = document.getElementById('stockRecordDate');
            const stockSellDateEl = document.getElementById('stockSellDate'); // This is for the main sell form, which is now hidden
            if (stockRecordDateEl) stockRecordDateEl.valueAsDate = new Date();
            // if (stockSellDateEl) stockSellDateEl.valueAsDate = new Date(); // No longer needed for main sell form

            if (stockBuyUsdAmountPerShareInput) stockBuyUsdAmountPerShareInput.addEventListener('input', stockCalculateBuyAmounts);
            if (stockBuyUsdExchangeRateAtPurchaseInput) stockBuyUsdExchangeRateAtPurchaseInput.addEventListener('input', stockCalculateBuyAmounts);
            if (stockBuyQuantityInput) stockBuyQuantityInput.addEventListener('input', stockCalculateBuyAmounts);
            // Listeners for the main sell form inputs
            if (stockSellQuantityInput) stockSellQuantityInput.addEventListener('input', stockCalculateSellAmounts);
            if (stockSellUsdSellPricePerShareInput) stockSellUsdSellPricePerShareInput.addEventListener('input', stockCalculateSellAmounts);
            if (stockSellUsdExchangeRateAtSaleInput) stockSellUsdExchangeRateAtSaleInput.addEventListener('input', stockCalculateSellAmounts);

            // Listeners for the sell modal inputs
            if (stockSellModalUsdPricePerShareInput) stockSellModalUsdPricePerShareInput.addEventListener('input', stockCalculateSellModalAmounts);
            if (stockSellModalUsdExchangeRateAtSaleInput) stockSellModalUsdExchangeRateAtSaleInput.addEventListener('input', stockCalculateSellModalAmounts);
            if (stockSellModalQuantityInput) stockSellModalQuantityInput.addEventListener('input', stockCalculateSellModalAmounts);
            if (stockSellModalForm) stockSellModalForm.addEventListener('submit', stockHandleSellModalSubmit); // Submit for the modal form
            if (closeStockSellModalBtn) closeStockSellModalBtn.addEventListener('click', stockCloseSellModal); // This is the close button for the sell stock modal

            if (stockBuyFormToggleBtn) stockBuyFormToggleBtn.addEventListener('click', () => {
                stockBuyFormToggleBtn.classList.add('active-toggle'); if(stockSellFormToggleBtn) stockSellFormToggleBtn.classList.remove('active-toggle');
                if(stockBuyFormContainer) stockBuyFormContainer.classList.remove('hidden'); if(stockSellFormContainer) stockSellFormContainer.classList.add('hidden');
            });
            if (stockSellFormToggleBtn) stockSellFormToggleBtn.addEventListener('click', () => {
                stockSellFormToggleBtn.classList.add('active-toggle'); if(stockBuyFormToggleBtn) stockBuyFormToggleBtn.classList.remove('active-toggle');
                if(stockSellFormContainer) stockSellFormContainer.classList.remove('hidden'); if(stockBuyFormContainer) stockBuyFormContainer.classList.add('hidden');
                populateStockSellSymbolDropdown(); // Ensure dropdown is populated when switching to sell form
            });
            if (stockBuyFormToggleBtn) stockBuyFormToggleBtn.click();
            if (refreshStockHistoryButton) refreshStockHistoryButton.addEventListener('click', stockFetchAndRenderHistory);
        }


        // Function to navigate between internal stock views
        function stockNavigateTo(viewId) {
            if (!stockViews) { console.error("stockViews is not initialized yet."); return; }
            Object.values(stockViews).forEach(view => { if (view) view.classList.add('hidden'); });
            if (stockViews[viewId]) {
                stockViews[viewId].classList.remove('hidden');
                if (viewId === 'stockSummaryView') {
                    const scroller = stockViews[viewId].querySelector('.overflow-y-auto');
                    if (scroller) scroller.scrollTop = 0;
                    stockFetchAndRenderSummary(); 
                } else if (viewId === 'stockHistoryView') stockFetchAndRenderHistory(); 
                else if (viewId === 'stockSettingsView') stockFetchAndRenderSettingsForm(); 
                else if (viewId === 'stockRecordView') { 
                    const stockRecordDateEl = document.getElementById('stockRecordDate');
                    const stockSellDateEl = document.getElementById('stockSellDate');
                    if(stockRecordDateEl) stockRecordDateEl.valueAsDate = new Date();
                    if(stockSellDateEl) stockSellDateEl.valueAsDate = new Date(); 

                    // Set USD Exchange Rate from summaryData.avgRate if available
                    if (summaryData && summaryData.avgRate) {
                        const avgRate = parseFloat(summaryData.avgRate);
                        if (!isNaN(avgRate) && avgRate > 0) {
                            if (stockBuyUsdExchangeRateAtPurchaseInput) stockBuyUsdExchangeRateAtPurchaseInput.value = avgRate.toFixed(2);
                            // The stockSellUsdExchangeRateAtSaleInput is now populated by populateStockSellSymbolDropdown or stockOpenSellModal
                        }
                    }
                    stockCalculateBuyAmounts(); // Only for buy form
                    stockCalculateSellAmounts(); // Only for main sell form
                    const stockBuyFormToggleBtn = document.getElementById('stockBuyFormToggleBtn');
                    if (stockBuyFormToggleBtn) stockBuyFormToggleBtn.click();
                    populateStockSellSymbolDropdown(); // Ensure dropdown is populated when navigating to record view
                }
                if (stockMainContent) stockMainContent.scrollTop = 0;
            }
            stockNavItems.forEach(item => { if (item) { item.classList.remove('active'); if (item.dataset.stockView === viewId) item.classList.add('active'); } });
        }


        let isAppInitialized = false; 

        document.addEventListener('DOMContentLoaded', async function() {
            if (updateNotificationEl) { updateNotificationEl.classList.add('hidden'); updateNotificationEl.classList.add('translate-y-full'); }
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js') // Ensure this path is correct
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        if (updateNotificationEl) { updateNotificationEl.classList.remove('hidden', 'translate-y-full'); updateNotificationEl.classList.add('translate-y-0'); }
                                    }
                                });
                            });
                        }).catch(error => console.error('Service Worker registration failed:', error));
                });
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                        if (updateNotificationEl) { updateNotificationEl.classList.remove('hidden', 'translate-y-full'); updateNotificationEl.classList.add('translate-y-0'); }
                    }
                });
            }

            onAuthStateChanged(window.auth, async (user) => {
                const displayUserIdElement = document.getElementById('displayUserId');
                const bottomNav = document.querySelector('.bottom-nav'); 

                if (user) {
                    window.userId = user.uid; console.log("User ID:", window.userId);
                    if (displayUserIdElement) displayUserIdElement.textContent = window.userId;
                    if(loginModalOverlay) loginModalOverlay.classList.add('hidden');
                    await fetchUserSheetId(); 
                    if (swiperInstance) { swiperInstance.allowTouchMove = true; swiperInstance.allowSlidePrev = true; swiperInstance.allowSlideNext = true; swiperInstance.slideTo(0); }
                    if(bottomNav) bottomNav.classList.remove('bottom-nav-hidden'); 
                    if (!window.userSheetId) showNotification(errorNotification, 'กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                    else {
                        // Fetch summary data on initial load after user is authenticated and sheet ID is set
                        // This ensures summaryData is available for stockRecordView
                        await fetchSummary(); 
                        const usdSubNavItems = document.querySelectorAll('.usd-sub-nav-item');
                        if (usdSubNavItems.length > 0 && usdSubNavItems[0].click) usdSubNavItems[0].click(); 
                    }
                } else {
                    window.userId = null; window.userSheetId = null; console.log("No user signed in.");
                    if (displayUserIdElement) displayUserIdElement.textContent = 'N/A (ไม่ได้เข้าสู่ระบบ)';
                    if(loginModalOverlay) loginModalOverlay.classList.remove('hidden');
                    const noAuthMessage = '<p class="text-gray-500 text-center py-4">โปรดเข้าสู่ระบบเพื่อดูข้อมูล</p>';
                    if(totalCardEl) totalCardEl.innerHTML = noAuthMessage; if(ratesCardEl) ratesCardEl.innerHTML = noAuthMessage;
                    if(buyCardEl) buyCardEl.innerHTML = noAuthMessage; if(profitLossCardEl) profitLossCardEl.innerHTML = noAuthMessage;
                    if(historyList) historyList.innerHTML = noAuthMessage;
                    if (swiperInstance) { swiperInstance.slideTo(0); swiperInstance.allowTouchMove = false; swiperInstance.allowSlidePrev = false; swiperInstance.allowSlideNext = false; }
                    if(bottomNav) bottomNav.classList.add('bottom-nav-hidden'); 
                    showNotification(errorNotification, 'โปรดเข้าสู่ระบบเพื่อใช้งาน');
                }
                if (!isAppInitialized) { initializeAppComponent(); isAppInitialized = true; }
            });
        });
    </script>
</head>
<body>
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-[#2C2C2E] p-5 rounded-lg flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <h2 class="text-center text-gray-100 text-xl font-semibold">กำลังดำเนินการ...</h2>
        </div>
    </div>

    <div class="swiper mySwiper">
        <div class="swiper-wrapper">
            <div class="swiper-slide bg-[#121212]" id="usdMainView">
                <div class="container h-full flex flex-col">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 text-center">จัดการ USD</h2>
                    <nav class="usd-sub-nav border-b shadow-md h-12 flex items-center justify-around rounded-t-lg mb-4">
                        <button data-usd-sub-view="usdSummarySubView" class="usd-sub-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150 active">
                            <span class="text-xs">สรุป</span>
                        </button>
                        <button data-usd-sub-view="usdRecordSubView" class="usd-sub-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150">
                            <span class="text-xs">บันทึก</span>
                        </button>
                        <button data-usd-sub-view="usdHistorySubView" class="usd-sub-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150">
                            <span class="text-xs">ประวัติ</span>
                        </button>
                        <button data-usd-sub-view="usdSettingsSubView" class="usd-sub-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150">
                            <span class="text-xs">ตั้งค่า</span>
                        </button>
                    </nav>
                    <div class="flex-grow overflow-y-auto rounded-b-lg shadow-lg p-4 usd-content-bg">
                        <section id="usdSummarySubView">
                            <div class="flex justify-between items-center mb-6 py-2">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-100">สรุปข้อมูล (สกุลเงิน)</h2>
                                <button id="refreshSummaryButton" class="text-blue-400 hover:text-blue-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    รีเฟรช
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
                                <div id="totalCard" class="summary-card fade-in"></div>
                                <div id="ratesCard" class="summary-card fade-in"></div>
                                <div id="buyCard" class="summary-card fade-in"></div>
                                <div id="profitLossCard" class="summary-card fade-in"></div>
                            </div>
                        </section>
                        <section id="usdRecordSubView" class="hidden">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">บันทึกธุรกรรม USD</h2>
                            <div class="form-toggle-container mb-6">
                                <button id="buyFormToggleBtn" class="form-toggle-button active-toggle">ซื้อ USD</button>
                                <button id="sellFormToggleBtn" class="form-toggle-button">ขาย USD</button>
                            </div>
                            <div id="buyFormContainer">
                                <form id="usdBuyForm" class="bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4">
                                    <div><label for="date" class="block text-sm font-medium text-gray-300 mb-1">วันที่:</label><input type="date" id="date" name="date" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="thbAmount" class="block text-sm font-medium text-gray-300 mb-1">จำนวนเงิน (THB):</label><input type="number" id="thbAmount" name="thbAmount" step="0.01" min="0.01" placeholder="฿" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="exchangeRate" class="block text-sm font-medium text-gray-300 mb-1">อัตราแลกเปลี่ยน (THB/USD):</label><input type="number" id="exchangeRate" name="exchangeRate" step="0.01" min="0.01" placeholder="เช่น 35.00" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div class="text-right text-lg font-semibold text-blue-400">จะได้รับ: <span id="usdResult">0.00 USD</span></div>
                                    <button type="submit" class="form-button w-full">บันทึกการซื้อ</button>
                                </form>
                            </div>
                            <div id="sellFormContainer" class="hidden">
                                <form id="usdSellForm" class="bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4">
                                    <div><label for="dateSell" class="block text-sm font-medium text-gray-300 mb-1">วันที่:</label><input type="date" id="dateSell" name="dateSell" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="usdSellAmount" class="block text-sm font-medium text-gray-300 mb-1">จำนวนเงิน (USD) ที่ต้องการขาย:</label><input type="number" id="usdSellAmount" name="usdSellAmount" step="0.01" min="0.01" placeholder="$" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div><label for="exchangeRateSell" class="block text-sm font-medium text-gray-300 mb-1">อัตราแลกเปลี่ยน (THB/USD):</label><input type="number" id="exchangeRateSell" name="exchangeRateSell" step="0.01" min="0.01" placeholder="เช่น 35.00" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500" required></div>
                                    <div class="text-right text-lg font-semibold text-red-400">จะได้รับ: <span id="thbReceiveResult">0.00 ฿</span></div>
                                    <button type="submit" class="form-button sale-button w-full">บันทึกการขาย</button>
                                </form>
                            </div>
                        </section>
                        <section id="usdHistorySubView" class="hidden">
                            <div class="flex justify-between items-center mb-6 py-2">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-100">ประวัติธุรกรรม (สกุลเงิน)</h2>
                                <button id="refreshButton" class="text-blue-400 hover:text-blue-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    รีเฟรช
                                </button>
                            </div>
                            <div id="historyList" class="space-y-3"></div>
                        </section>
                        <section id="usdSettingsSubView" class="hidden">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">ตั้งค่า USD และทั่วไป</h2>
                            <div class="bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4">
                                <div><label for="sheetIdInput" class="block text-sm font-medium text-gray-300 mb-1">Google Sheet ID:</label><input type="text" id="sheetIdInput" placeholder="กรอก Google Sheet ID ของคุณ" class="w-full p-3 rounded-lg bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500"></div>
                                <button id="saveSheetIdButton" class="form-button w-full">บันทึก Sheet ID</button>
                                <div class="border-t border-gray-700 pt-4 mt-4 space-y-2">
                                    <label class="flex items-center justify-between text-sm font-medium text-gray-300">โหมดกลางคืน:<label class="toggle-switch"><input type="checkbox" id="themeToggle" checked><span class="slider"></span></label></label>
                                    <label class="flex items-center justify-between text-sm font-medium text-gray-300">การแจ้งเตือน:<label class="toggle-switch"><input type="checkbox" id="notificationToggle" checked><span class="slider"></span></label></label>
                                </div>
                                <div class="border-t border-gray-700 pt-4 mt-4"><p class="text-sm font-medium text-gray-300 mb-2">User ID:</p><p id="displayUserId" class="text-xs text-gray-400 break-all">N/A (ไม่ได้เข้าสู่ระบบ)</p></div>
                                <button id="signOutButtonSettings" class="form-button sale-button w-full">ออกจากระบบ</button>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <div class="swiper-slide bg-[#121212]" id="stockGraphView">
                <div class="container h-full flex flex-col">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 text-center">กราฟหุ้น</h2>
                    <div class="bg-[#2C2C2E] p-4 rounded-xl shadow-lg mb-4">
                        <div class="flex items-center space-x-2 mb-3">
                            <input type="text" id="stockTvSymbolInput" placeholder="เช่น AAPL" value="AAPL" class="flex-grow p-2 rounded-md bg-[#121212] border border-gray-600 text-gray-100 focus:ring-blue-500 focus:border-blue-500">
                            <button id="stockTvLoadSymbolBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">โหลดกราฟ</button>
                        </div>
                        <button id="stockTvFullscreenBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">ดูแบบเต็มจอ</button>
                    </div>
                    <div id="stockTradingViewWidgetContainer" class="flex-grow w-full h-full bg-gray-800 rounded-xl overflow-hidden shadow-lg"></div>
                </div>
            </div>

            <div class="swiper-slide bg-[#121212]" id="stockManagementView">
                <div class="container h-full flex flex-col">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 text-center">จัดการหุ้น</h2>
                    <nav class="stock-nav border-b shadow-md h-12 flex items-center justify-around rounded-t-lg mb-4">
                        <button data-stock-view="stockSummaryView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150 active"><span class="text-xs">สรุป</span></button>
                        <button data-stock-view="stockRecordView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150"><span class="text-xs">บันทึก</span></button>
                        <button data-stock-view="stockHistoryView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150"><span class="text-xs">ประวัติ</span></button>
                        <button data-stock-view="stockSettingsView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 transition duration-150"><span class="text-xs">ตั้งค่า</span></button>
                    </nav>
                    <div class="flex-grow overflow-y-auto rounded-b-lg shadow-lg p-4 stock-content-bg">
                        <section id="stockSummaryView">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">สรุปพอร์ตหุ้น</h2>
                            <div id="stockSummaryDashboard" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"></div>
                            <h3 class="text-lg sm:text-xl font-bold text-gray-100 mb-4">รายละเอียดหุ้นรายตัว</h3>
                            <div id="stockSummaryStockDetails" class="space-y-4"></div>
                        </section>
                        <section id="stockRecordView" class="hidden">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">บันทึกการซื้อ/ขายหุ้น</h2>
                            <div class="form-toggle-container mb-6">
                                <button id="stockBuyFormToggleBtn" class="form-toggle-button active-toggle">ซื้อหุ้น</button>
                                <button id="stockSellFormToggleBtn" class="form-toggle-button">ขายหุ้น</button>
                            </div>
                            <div id="stockBuyFormContainer">
                                <form id="stockRecordForm" class="bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4">
                                    <div><label for="stockRecordDate" class="block text-sm font-medium text-gray-300 mb-1">วันที่:</label><input type="date" id="stockRecordDate" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockRecordStockSymbol" class="block text-sm font-medium text-gray-300 mb-1">ชื่อหุ้น (Symbol):</label><input type="text" id="stockRecordStockSymbol" placeholder="เช่น AAPL" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockRecordUsdAmountPerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคาซื้อ (USD/หุ้น):</label><input type="number" id="stockRecordUsdAmountPerShare" step="0.0001" min="0.0001" placeholder="ราคาซื้อต่อหุ้นเป็น USD" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockRecordQuantity" class="block text-sm font-medium text-gray-300 mb-1">จำนวนหุ้น:</label><input type="number" id="stockRecordQuantity" step="0.0000001" min="0.0000001" placeholder="จำนวนหุ้นที่ซื้อ" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockRecordUsdRate" class="block text-sm font-medium text-gray-300 mb-1">อัตราแลกเปลี่ยน (THB/USD):</label><input type="number" id="stockRecordUsdRate" step="0.01" min="0.01" placeholder="Rate THB/USD ณ วันที่ซื้อ" class="stock-form-input w-full p-3" required></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label for="stockRecordTotalTHB" class="block text-sm font-medium text-gray-300 mb-1">รวมเงิน (THB):</label><input type="number" id="stockRecordTotalTHB" step="0.01" min="0" class="stock-form-input w-full p-3" readonly></div>
                                        <div><label for="stockRecordPricePerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคา (THB/หุ้น):</label><input type="number" id="stockRecordPricePerShare" step="0.0001" min="0" class="stock-form-input w-full p-3" readonly></div>
                                    </div>
                                    <button type="submit" class="form-button w-full">บันทึกการซื้อหุ้น</button>
                                </form>
                            </div>
                            <div id="stockSellFormContainer" class="hidden">
                                <form id="stockSellForm" class="bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4">
                                    <div><label for="stockSellDate" class="block text-sm font-medium text-gray-300 mb-1">วันที่:</label><input type="date" id="stockSellDate" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockSellStockSymbol" class="block text-sm font-medium text-gray-300 mb-1">เลือกหุ้น:</label>
                                        <select id="stockSellStockSymbol" class="stock-form-input w-full p-3" required>
                                            <option value="">เลือกหุ้น</option>
                                            </select>
                                    </div>
                                    <div><label for="stockSellUsdPricePerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคาขาย (USD/หุ้น):</label><input type="number" id="stockSellUsdPricePerShare" step="0.0001" min="0.0001" placeholder="ราคาขายต่อหุ้นเป็น USD" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockSellQuantity" class="block text-sm font-medium text-gray-300 mb-1">จำนวนหุ้น:</label><input type="number" id="stockSellQuantity" step="0.0000001" min="0.0000001" placeholder="จำนวนหุ้นที่ขาย" class="stock-form-input w-full p-3" required></div>
                                    <div><label for="stockSellUsdRate" class="block text-sm font-medium text-gray-300 mb-1">อัตราแลกเปลี่ยน (THB/USD):</label><input type="number" id="stockSellUsdRate" step="0.01" min="0.01" placeholder="Rate THB/USD ณ วันที่ขาย" class="stock-form-input w-full p-3" required></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label for="stockSellTotalTHBReceived" class="block text-sm font-medium text-gray-300 mb-1">รวมเงินที่ได้รับ (THB):</label><input type="number" id="stockSellTotalTHBReceived" step="0.01" min="0" class="stock-form-input w-full p-3" readonly></div>
                                        <div><label for="stockSellPricePerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคาขาย (THB/หุ้น):</label><input type="number" id="stockSellPricePerShare" step="0.0001" min="0" class="stock-form-input w-full p-3" readonly></div>
                                    </div>
                                    <button type="submit" class="form-button sale-button w-full">บันทึกการขายหุ้น</button>
                                </form>
                            </div>
                        </section>
                        <section id="stockHistoryView" class="hidden">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">ประวัติการซื้อขายหุ้น</h2>
                            <div class="mb-4 flex items-center space-x-2">
                                <input type="text" id="stockHistorySearchInput" placeholder="ค้นหาด้วยชื่อหุ้นหรือวันที่..." class="stock-form-input flex-grow p-3">
                                <button id="refreshStockHistoryButton" class="text-blue-400 hover:text-blue-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                </button>
                            </div>
                            <div id="stockHistoryList" class="space-y-3">
                                </div>
                        </section>
                        <section id="stockSettingsView" class="hidden">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">ตั้งค่าหุ้น</h2>
                            <div class="stock-settings-card bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4 border border-gray-700">
                                <h3 class="text-lg font-semibold text-gray-100 mb-4">การตั้งค่าทั่วไป</h3>
                                <div><label for="stockSettingsSheetId" class="block text-sm font-medium text-gray-300 mb-1">Google Sheet ID:</label><input type="text" id="stockSettingsSheetId" placeholder="Sheet ID" class="stock-form-input w-full p-3" readonly><p class="text-xs text-gray-400 mt-1">สามารถตั้งค่า Sheet ID ได้ที่หน้า "ตั้งค่า" ของ USD</p></div>
                            </div>
                            <div class="stock-settings-card bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4 border border-gray-700 mt-6">
                                <h3 class="text-lg font-semibold text-gray-100 mb-4">ตั้งค่า Rate เป้าหมาย (THB/หุ้น)</h3>
                                <div class="space-y-2" id="stockTargetRatesContainer"></div>
                                <div class="flex space-x-2 mt-4"><input type="text" id="stockNewTargetStockSymbol" placeholder="Symbol หุ้น (เช่น AAPL)" class="stock-form-input flex-1 p-2"><input type="number" id="stockNewTargetStockRate" step="0.01" min="0" placeholder="Rate เป้าหมาย (THB)" class="stock-form-input w-24 p-2"><button id="stockAddStockTargetRateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">เพิ่ม</button></div>
                            </div>
                            <div class="stock-settings-card bg-[#2C2C2E] p-6 rounded-xl shadow-lg space-y-4 border border-gray-700 mt-6">
                                <h3 class="text-lg font-semibold text-gray-100 mb-4">ตั้งค่า Rate แลกเปลี่ยนเป้าหมาย (THB/USD)</h3>
                                <div class="space-y-2" id="stockTargetExchangeRatesContainer"></div>
                                <div class="flex space-x-2 mt-4"><input type="text" id="stockNewTargetStockSymbolUsd" placeholder="Symbol หุ้น (เช่น AAPL)" class="stock-form-input flex-1 p-2"><input type="number" id="stockNewTargetUsdRate" step="0.01" min="0" placeholder="Rate เป้าหมาย (THB/USD)" class="stock-form-input w-24 p-2"><button id="stockAddStockTargetUsdRateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">เพิ่ม</button></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav bottom-nav-hidden">
        <div class="grid grid-cols-3 gap-8 w-full max-w-md">
            <div class="nav-item active" data-index="0"><span class="emoji">💵</span><span class="label">USD</span><div class="page-indicator"><span class="indicator active"></span></div></div>
            <div class="nav-item" data-index="1"><span class="emoji">📊</span><span class="label">กราฟหุ้น</span><div class="page-indicator"><span class="indicator"></span></div></div>
            <div class="nav-item" data-index="2"><span class="emoji">📈</span><span class="label">จัดการหุ้น</span><div class="page-indicator"><span class="indicator"></span></div></div>
        </div>
    </nav>

    <div id="successNotification" class="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full z-50"><div class="flex items-center"><svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><p>บันทึกข้อมูลสำเร็จ</p></div></div>
    <div id="errorNotification" class="fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full z-50"><div class="flex items-center"><svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p>เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง</p></div></div>

    <div id="customModalOverlay" class="custom-modal-overlay hidden"><div class="custom-modal-content"><h3 id="customModalTitle">ยืนยัน</h3><p id="customModalMessage">คุณแน่ใจหรือไม่?</p><div class="custom-modal-actions"><button id="customModalConfirmBtn" class="confirm">ยืนยัน</button><button id="customModalCancelBtn" class="cancel">ยกเลิก</button></div></div></div>

    <div id="updateNotification" class="hidden"><p class="flex-grow">มีเวอร์ชันใหม่พร้อมใช้งานแล้ว! โปรดคลิกเพื่ออัปเดต</p><button onclick="window.location.reload();">อัปเดต</button><button class="close-button" onclick="document.getElementById('updateNotification').classList.add('hidden');">&times;</button></div>

    <div id="loginModalOverlay" class="login-modal-overlay hidden">
        <div class="login-modal-content">
            <h1 class="text-2xl font-bold text-center mb-6">ยินดีต้อนรับ</h1>
            <div class="login-toggle-container mb-8"><button id="loginModalToggleSignIn" class="login-toggle-button active-login-tab">เข้าสู่ระบบ</button><button id="loginModalToggleSignUp" class="login-toggle-button">ลงทะเบียน</button></div>
            <div id="loginModalFormContainer"><form class="space-y-6"><div><label for="loginModalEmailInput" class="sr-only">อีเมล</label><input type="email" id="loginModalEmailInput" placeholder="อีเมล" class="login-input" autocomplete="email" required></div><div><label for="loginModalPasswordInput" class="sr-only">รหัสผ่าน</label><input type="password" id="loginModalPasswordInput" placeholder="รหัสผ่าน" class="login-input" autocomplete="current-password" required></div><button type="button" id="signInModalButton" class="login-button">เข้าสู่ระบบ</button></form></div>
            <div id="signUpModalFormContainer" class="hidden"><form class="space-y-6"><div><label for="signUpModalEmailInput" class="sr-only">อีเมล</label><input type="email" id="signUpModalEmailInput" placeholder="อีเมล" class="login-input" autocomplete="email" required></div><div><label for="signUpModalPasswordInput" class="sr-only">รหัสผ่าน</label><input type="password" id="signUpModalPasswordInput" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" class="login-input" autocomplete="new-password" required></div><div><label for="signUpModalConfirmPasswordInput" class="sr-only">ยืนยันรหัสผ่าน</label><input type="password" id="signUpModalConfirmPasswordInput" placeholder="ยืนยันรหัสผ่าน" class="login-input" autocomplete="new-password" required></div><button type="button" id="signUpModalSubmitButton" class="login-button">ลงทะเบียน</button></form></div>
            <p class="login-version text-center">เวอร์ชัน 1.0</p>
        </div>
    </div>

    <div id="tradingViewFullscreenModal" class="modal tradingview-fullscreen-modal"><div class="modal-content"><button id="closeTradingViewFullscreenBtn" class="absolute top-4 right-4 z-50 text-white text-3xl bg-gray-800 rounded-full w-10 h-10 flex items-center justify-center opacity-75 hover:opacity-100">&times;</button><div id="tradingViewFullscreenContent" class="w-full h-full"></div></div></div>

    <div id="stockSellModalOverlay" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <h3 id="stockSellModalTitle" class="text-xl font-bold mb-4">ขายหุ้น <span id="stockSellModalSymbolDisplay"></span></h3>
            <button id="closeStockSellModalBtn" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center opacity-75 hover:opacity-100 transition-all duration-200">&times;</button>
            <form id="stockSellModalForm" class="space-y-4">
                <div><label for="stockSellModalDate" class="block text-sm font-medium text-gray-300 mb-1">วันที่:</label><input type="date" id="stockSellModalDate" class="stock-form-input w-full p-3" required></div>
                <div><label for="stockSellModalUsdPricePerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคาขาย (USD/หุ้น):</label><input type="number" id="stockSellModalUsdPricePerShare" step="0.0001" min="0.0001" placeholder="ราคาขายต่อหุ้นเป็น USD" class="stock-form-input w-full p-3" required></div>
                <div><label for="stockSellModalQuantity" class="block text-sm font-medium text-gray-300 mb-1">จำนวนหุ้นที่ต้องการขาย:</label><input type="number" id="stockSellModalQuantity" step="0.0000001" min="0.0000001" placeholder="จำนวนหุ้น" class="stock-form-input w-full p-3" required></div>
                <div><label for="stockSellModalUsdRate" class="block text-sm font-medium text-gray-300 mb-1">อัตราแลกเปลี่ยน (THB/USD):</label><input type="number" id="stockSellModalUsdRate" step="0.01" min="0.01" placeholder="Rate THB/USD ณ วันที่ขาย" class="stock-form-input w-full p-3" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="stockSellModalTotalTHBReceived" class="block text-sm font-medium text-gray-300 mb-1">รวมเงินที่ได้รับ (THB):</label><input type="number" id="stockSellModalTotalTHBReceived" step="0.01" min="0" class="stock-form-input w-full p-3" readonly></div>
                    <div><label for="stockSellModalPricePerShare" class="block text-sm font-medium text-gray-300 mb-1">ราคาขาย (THB/หุ้น):</label><input type="number" id="stockSellModalPricePerShare" step="0.0001" min="0" class="stock-form-input w-full p-3" readonly></div>
                </div>
                <button type="submit" id="stockSellModalSubmitBtn" class="form-button sale-button w-full">ยืนยันการขายหุ้น</button>
            </form>
        </div>
    </div>

</body>
</html>
