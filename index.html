<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>USD & Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker">
    <link rel="apple-touch-icon" href="/icons/icon-180x180.png">
    <link rel="apple-touch-startup-image" href="/icons/icon-512x512.png">
    <style>
        /* Custom styles for smooth scrolling and fixed bottom nav */
        body {
            font-family: 'Prompt', sans-serif;
            overflow: hidden; /* Prevent body scrolling, Swiper will handle it */
            height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            background-color: #5C5CFF; /* Purple background from image */
            color: #E5E7EB; /* Light gray text for general content */
        }

        .swiper {
            width: 100%;
            height: calc(100vh - 80px); /* Adjust this value if bottom-nav height changes */
            flex-grow: 1; /* Allow Swiper to take available space */
        }

        .swiper-slide {
            height: 100%; /* Ensure slide takes full height of its container */
            overflow-y: auto; /* Enable vertical scrolling within each slide */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS devices */
            padding-bottom: 100px; /* Add some padding to the bottom of each slide content to clear bottom nav */
            background-color: transparent; /* Transparent for slides to show body background */
        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .swiper-slide::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for Firefox */
        .swiper-slide {
            scrollbar-width: none;
        }

        .container {
            padding: 1.5rem; /* Default padding */
            max-width: 960px; /* Max width for content */
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Fixed bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1E1E1E; /* Darker gray for bottom nav */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 100; /* Ensure it's above other content */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px; /* Fixed height for the nav bar */
            opacity: 1; /* Default to visible */
            pointer-events: auto; /* Allow clicks by default */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for visibility */
        }

        /* Class to hide bottom nav smoothly */
        .bottom-nav.bottom-nav-hidden {
            opacity: 0;
            pointer-events: none; /* Disable clicks when hidden */
        }

        .bottom-nav .grid {
            width: 100%;
            max-width: 400px; /* Limit width for better mobile display */
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columns now */
            gap: 8px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            cursor: pointer;
            color: #6B7280; /* Gray-500 for inactive */
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-item.active {
            color: #60A5FA; /* Blue-400 for active */
        }

        .nav-item .emoji {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-item .label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
        }

        .page-indicator {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            position: absolute;
            bottom: 5px; /* Position indicators below the nav items */
            width: 100%;
        }

        .indicator {
            width: 8px;
            height: 8px;
            background-color: #4B5563; /* Gray-700 for inactive */
            border-radius: 50%;
            margin: 0 4px;
            transition: background-color 0.3s ease;
        }

        .indicator.active {
            background-color: #60A5FA; /* Blue-400 for active */
        }


        /* General card styles */
        .summary-card {
            background-color: #2C2C2E; /* Darker gray for card background */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* darker shadow */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            color: #E5E7EB; /* Light gray text */
            transition: background-color 0.3s ease; /* Smooth transition for background */
            position: relative; /* For icon positioning */
            min-height: 150px; /* Ensure a minimum height for cards */
            justify-content: space-between; /* Distribute content */
        }

        .summary-card.card-on {
            background-color: #5C5CFF; /* Blue from image for active state */
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 2.5rem; /* Larger icon size */
            color: #E5E7EB; /* Light gray icon color */
        }

        /* Responsive font sizes for card titles, labels, and values */
        .card-title {
            font-size: clamp(1rem, 4vw, 1.125rem); /* text-base on small, text-lg on larger */
            font-weight: 600; /* font-semibold */
            color: #E5E7EB; /* Light gray for title */
            margin-bottom: 0.5rem; /* mb-2 */
        }

        .card-status {
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* text-sm on small, text-sm on larger */
            color: #9CA3AF; /* Gray-400 for status */
            margin-bottom: 1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #4B5563; /* Darker gray dashed border */
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* text-sm on small, text-sm on larger */
            color: #9CA3AF; /* Gray-400 */
        }

        .summary-value {
            font-size: clamp(0.9rem, 3.5vw, 1rem); /* text-base on small, text-base on larger */
            font-weight: 500; /* font-medium */
            color: #F3F4F6; /* Lighter gray for values */
        }

        .highlight-value {
            font-size: clamp(1rem, 4vw, 1.125rem); /* text-lg on small, text-lg on larger */
            font-weight: 600; /* font-semibold */
            color: #FBBF24; /* Yellow-400 for highlights */
        }
        .profit-value {
            color: #10B981; /* Green for profit */
        }
        .loss-value {
            color: #EF4444; /* Red for loss */
        }

        /* Loader styles */
        .loader {
            border-top-color: #60A5FA; /* Blue-400 */
            -webkit-animation: spinner 1.2s linear infinite;
            animation: spinner 1.2s linear infinite;
        }

        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification styles */
        #successNotification, #errorNotification {
            min-width: 250px;
        }

        /* Editable field styles */
        .editable-field {
            display: flex;
            align-items: center;
        }

        .editable-field input {
            border: 1px solid #4B5563; /* Darker gray border */
            background-color: #2C2C2E; /* Match card background */
            color: #F3F4F6; /* Light text */
            border-radius: 0.25rem; /* rounded-md */
            padding: 0.25rem 0.5rem;
            width: clamp(60px, 15vw, 80px); /* Responsive width for input */
            font-size: clamp(0.8rem, 3vw, 0.875rem); /* Responsive font size */
            margin-right: 0.5rem;
        }

        .edit-button, .save-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9CA3AF; /* Gray-400 */
            transition: color 0.2s ease;
        }

        .edit-button:hover {
            color: #60A5FA; /* Blue-400 */
        }

        .save-button {
            background-color: #60A5FA; /* Blue-400 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: clamp(0.75rem, 3vw, 0.875rem); /* Responsive font size */
        }

        .save-button:hover {
            background-color: #3B82F6; /* Blue-500 */
        }

        /* Toggle switch for settings and cards */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px; /* Wider toggle */
            height: 24px; /* Taller toggle */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6B7280; /* Gray-500 for off state */
            transition: .3s;
            border-radius: 24px; /* Rounded slider */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; /* Smaller circle */
            width: 18px; /* Smaller circle */
            left: 3px; /* Adjust position */
            bottom: 3px; /* Adjust position */
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #FBBF24; /* Yellow-400 for on state */
        }

        input:checked + .slider:before {
            transform: translateX(20px); /* Move circle to the right */
        }

        /* TradingView widget container styles */
        .tradingview-widget-container {
            height: 350px; /* Ensure enough height for the chart */
            width: 100%;
            background-color: #2C2C2E; /* Darker gray for card background */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* darker shadow */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
        }

        /* Specific styling for the TradingView widget's internal div */
        .tradingview-widget-container__widget {
            height: 100%; /* Make sure the widget takes full height of its container */
            width: 100%;
        }

        /* Adjust input field styles for dark theme */
        input[type="date"],
        input[type="number"],
        input[type="text"] {
            background-color: #121212; /* Even darker background for inputs */
            color: #E5E7EB;
            border-color: #4B5563;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Invert color for dark theme */
        }
        select {
            background-color: #121212;
            color: #E5E7EB;
            border-color: #4B5563;
        }

        /* History list items */
        .history-item {
            border-left: 4px solid; /* Border will be dynamic (buy/sell) */
            padding: 0; /* Remove padding from here, it will be on swipe-content */
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            color: #E5E7EB;
            position: relative; /* For delete button positioning */
            overflow: hidden; /* Hide overflowing delete button initially */
        }

        .history-item.buy {
            border-left-color: #5C5CFF; /* Matching total card active (dark) */
            background-color: #3A3A50; /* Slightly darker tint of the new blue */
        }

        .history-item.sale {
            border-left-color: #EF4444; /* Red for sale */
            background-color: #4A2C2C; /* Dark red for sale */
        }

        .swipe-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 0.75rem; /* Match parent border-radius */
        }

        .swipe-content {
            padding: 1rem; /* Apply padding here */
            /* background-color will be inherited from .history-item.buy or .history-item.sale */
            transition: transform 0.3s ease;
            position: relative;
            z-index: 2; /* Ensure content is above delete button */
            cursor: grab; /* Indicate it's draggable */
        }

        .swipe-content.dragging {
            cursor: grabbing;
        }

        .delete-reveal {
            position: absolute;
            top: 0;
            right: 0; /* Align to the right */
            bottom: 0;
            width: 80px; /* Width of the delete button area */
            background-color: #EF4444; /* Red background for delete */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1; /* Behind the swipe-content */
            transform: translateX(100%); /* Initially off-screen to the right */
            transition: transform 0.3s ease;
        }

        .swipe-content.swiped {
            transform: translateX(-80px); /* Move content left to reveal delete */
        }

        .delete-reveal.revealed {
            transform: translateX(0); /* Bring delete button into view */
        }

        .history-item .font-medium {
            color: #F3F4F6;
            font-size: clamp(0.85rem, 3.5vw, 1rem); /* Responsive font size */
        }
        /* Adjust font-semibold for buy/sell history items */
        .history-item.buy .font-semibold {
            color: #60A5FA; /* Blue for USD amount in buy history */
            font-size: clamp(0.95rem, 4vw, 1.125rem); /* Responsive font size */
        }
        body.light-theme .history-item.buy .font-semibold {
            color: #2563EB; /* Darker blue for USD amount in light theme buy history */
        }
        .history-item.sale .font-semibold {
            color: #EF4444; /* Red for USD amount in sale history */
            font-size: clamp(0.95rem, 4vw, 1.125rem); /* Responsive font size */
        }
        body.light-theme .history-item.sale .font-semibold {
            color: #DC2626; /* Darker red for USD amount in light theme sale history */
        }

        .history-item .text-sm {
            color: #9CA3AF;
            font-size: clamp(0.7rem, 2.8vw, 0.875rem); /* Responsive font size */
        }
        .delete-button {
            background: none;
            border: none;
            color: white; /* White icon on red background */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .delete-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Form button - matching total card active */
        .form-button {
            background-color: #5C5CFF; /* Matching total card active (dark) */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .form-button:hover {
            background-color: #4A4AF0; /* Slightly darker hover for new blue */
        }

        /* New style for sale button */
        .sale-button {
            background-color: #EF4444; /* Red for sale button */
        }
        .sale-button:hover {
            background-color: #DC2626; /* Darker red on hover */
        }


        /* Toggle between forms (Buy/Sell) */
        .form-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            background-color: #1E1E1E;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }

        .form-toggle-button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: #9CA3AF;
            background-color: transparent;
        }

        /* Active state for Buy toggle button - matching total card active */
        .form-toggle-button.active-toggle {
            background-color: #5C5CFF; /* Matching total card active (dark) */
            color: white;
        }

        /* Active state for Sale toggle button - red */
        .form-toggle-button.active-sale-toggle {
            background-color: #EF4444; /* Red for sale button */
            color: white;
        }


        /* Light Theme */
        body.light-theme {
            background-color: #F3F4F6; /* Light background */
            color: #1F2937; /* Dark text */
        }
        body.light-theme .swiper-slide {
            background-color: #F3F4F6;
        }
        body.light-theme .bottom-nav {
            background-color: #FFFFFF; /* White for bottom nav */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        body.light-theme .nav-item {
            color: #6B7280; /* Gray-500 */
        }
        body.light-theme .nav-item.active {
            color: #2563EB; /* Blue-600 */
        }
        body.light-theme .indicator {
            background-color: #D1D5DB; /* Gray-300 */
        }
        body.light-theme .indicator.active {
            background-color: #2563EB; /* Blue-600 */
        }
        body.light-theme .summary-card {
            background-color: #FFFFFF; /* White for card background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        body.light-theme .summary-card.card-on {
            background-color: #DBEAFE; /* Light blue for active state */
        }
        body.light-theme .card-title {
            color: #1E40AF; /* Blue-800 */
        }
        body.light-theme .card-status {
            color: #4B5563; /* Gray-700 */
        }
        body.light-theme .summary-label {
            color: #4B5563; /* Gray-700 */
        }
        body.light-theme .summary-value {
            color: #1F2937; /* Gray-900 */
        }
        body.light-theme .highlight-value {
            color: #10B981; /* Green-600 */
        }
        body.light-theme .editable-field input {
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #D1D5DB;
        }
        body.light-theme input[type="date"], body.light-theme input[type="number"], body.light-theme input[type="text"] {
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #D1D5DB;
        }
        body.light-theme input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0); /* Reset filter for light theme */
        }
        body.light-theme select {
            background-color: #FFFFFF;
            color: #1F2937;
            border-color: #D1D5DB;
        }
        body.light-theme .history-item {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #1F2937;
        }
        body.light-theme .history-item.buy {
            border-left-color: #2563EB; /* A stronger blue for light theme border */
            background-color: #E0F2FE; /* Light blue, similar to DBEAFE but a bit more distinct */
        }
        body.light-theme .history-item.sale {
            border-left-color: #DC2626; /* Darker red for light theme */
            background-color: #FEE2E2; /* Light red for sale */
        }
        body.light-theme .history-item .font-medium {
            color: #1E40AF;
        }
        body.light-theme .history-item .text-sm {
            color: #4B5563;
        }
        body.light-theme .delete-button {
            color: white; /* White icon on red background */
        }
        body.light-theme .delete-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        body.light-theme .form-button {
            background-color: #DBEAFE; /* Matching total card active (light) */
            color: #1F2937; /* Dark text for light background */
        }
        body.light-theme .form-button:hover {
            background-color: #B2D8FA; /* Slightly darker hover for light blue */
        }
        body.light-theme .sale-button {
            background-color: #DC2626; /* Red-700 for light theme */
        }
        body.light-theme .sale-button:hover {
            background-color: #B91C1C; /* Darker red on hover */
        }
        body.light-theme #loadingOverlay .bg-[#2C2C2E] {
            background-color: #FFFFFF;
        }
        body.light-theme #loadingOverlay h2 {
            color: #4B5563;
        }
        body.light-theme #successNotification {
            background-color: #10B981; /* green-600 */
        }
        body.light-theme #errorNotification {
            background-color: #EF4444; /* red-600 */
        }
        body.light-theme .profit-value {
            color: #10B981; /* Green for profit */
        }
        body.light-theme .loss-value {
            color: #EF4444; /* Red for loss */
        }
        body.light-theme .form-toggle-container {
            background-color: #E5E7EB;
        }
        body.light-theme .form-toggle-button {
            color: #4B5563;
        }
        body.light-theme .form-toggle-button.active-toggle {
            background-color: #DBEAFE;
            color: #1F2937;
        }
        body.light-theme .form-toggle-button.active-sale-toggle {
            background-color: #DC2626;
            color: white;
        }


        /* Custom Modal for Confirmation */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-modal-content {
            background-color: #2C2C2E;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            color: #E5E7EB;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .custom-modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .custom-modal-content p {
            margin-bottom: 1.5rem;
        }
        .custom-modal-actions {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
        }
        .custom-modal-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .custom-modal-actions button.confirm {
            background-color: #EF4444; /* Red */
            color: white;
        }
        .custom-modal-actions button.confirm:hover {
            background-color: #DC2626; /* Darker Red */
        }
        .custom-modal-actions button.cancel {
            background-color: #4B5563; /* Gray */
            color: white;
        }
        .custom-modal-actions button.cancel:hover {
            background-color: #374151; /* Darker Gray */
        }

        body.light-theme .custom-modal-content {
            background-color: #FFFFFF;
            color: #1F2937;
        }
        body.light-theme .custom-modal-actions button.confirm {
            background-color: #DC2626;
        }
        body.light-theme .custom-modal-actions button.confirm:hover {
            background-color: #B91C1C;
        }
        body.light-theme .custom-modal-actions button.cancel {
            background-color: #6B7280;
        }
        body.light-theme .custom-modal-actions button.cancel:hover {
            background-color: #4B5563;
        }

        /* PWA Update Notification */
        #updateNotification {
            position: fixed;
            bottom: 90px; /* เหนือ bottom-nav */
            left: 50%;
            transform: translateX(-50%) translateY(100%); /* เริ่มต้นซ่อนอยู่ด้านล่าง */
            background-color: #2C2C2E;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 101; /* สูงกว่า bottom-nav */
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease-out;
            max-width: calc(100% - 2rem); /* Adjusted max-width */
            left: 1rem; /* Adjusted left position */
            right: 1rem; /* Adjusted right position */
            margin-left: auto; /* Center horizontally */
            margin-right: auto; /* Center horizontally */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        #updateNotification.translate-y-0 {
            transform: translateX(-50%) translateY(0); /* เลื่อนขึ้นมาแสดง */
        }
        #updateNotification button {
            background-color: #60A5FA;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        #updateNotification button:hover {
            background-color: #3B82F6;
        }
        #updateNotification .close-button {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 10px;
        }
        #updateNotification .close-button:hover {
            color: white;
        }

        /* Ensure .hidden truly hides elements */
        .hidden {
            display: none !important;
        }

        /* Custom styles for Login/Registration modal */
        .login-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's above everything else */
        }

        .login-modal-content {
            background-color: #FFFFFF; /* White background for login card */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); /* Soft shadow */
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            color: #1F2937; /* Dark text for light background */
        }

        .login-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #E5E7EB; /* Light border at the bottom */
        }

        .login-toggle-button {
            flex: 1;
            padding: 0.75rem 1rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: color 0.3s ease, border-color 0.3s ease;
            color: #6B7280; /* Gray text for inactive */
            border-bottom: 2px solid transparent; /* Transparent border for inactive */
            font-size: 1.125rem; /* text-lg */
        }

        .login-toggle-button.active-login-tab {
            color: #5C5CFF; /* Purple for active tab */
            border-color: #5C5CFF; /* Purple underline for active tab */
        }

        .login-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #D1D5DB; /* Light gray border */
            border-radius: 0.5rem; /* More rounded */
            background-color: #F9FAFB; /* Very light background */
            color: #1F2937; /* Dark text */
            font-size: 1rem;
            box-sizing: border-box;
        }
        .login-input::placeholder {
            color: #9CA3AF; /* Placeholder color */
        }
        .login-input:focus {
            outline: none;
            border-color: #5C5CFF; /* Purple focus border */
            box-shadow: 0 0 0 3px rgba(92, 92, 255, 0.3); /* Purple ring on focus */
        }

        .login-button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: 700; /* font-bold */
            color: white;
            background: linear-gradient(to right, #60A5FA, #5C5CFF); /* Blue to purple gradient */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .login-button:hover {
            background: linear-gradient(to right, #3B82F6, #4A4AF0); /* Darker gradient on hover */
            box-shadow: 6px 15px rgba(0, 0, 0, 0.3);
        }

        .login-version {
            color: #9CA3AF; /* Gray-400 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 1.5rem;
        }

        /* Styles from nas.html for stock app */
        .stock-nav-item.active {
            color: #3b82f6; /* Tailwind blue-500 */
            border-bottom-color: #3b82f6; /* Use border-bottom for internal nav */
        }
        .stock-nav-item {
            border-bottom: 2px solid transparent; /* Use border-bottom for internal nav */
        }
        /* Styles for summary cards (dark theme inspired by image) */
        /* Note: .summary-card is already defined for USD, these will override/complement */
        .summary-card {
            background-color: #1f2937; /* Tailwind gray-800 */
            color: #f3f4f6; /* Tailwind gray-100 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        .summary-card-title {
            font-size: 0.875rem; /* text-sm */
            color: #9ca3af; /* Tailwind gray-400 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .summary-card-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold; /* font-bold */
            color: #ffffff; /* white */
        }
        .summary-card-currency {
            font-size: 1rem; /* text-base */
            color: #d1d5db; /* Tailwind gray-300 */
            margin-left: 0.25rem;
        }

        /* New styles for individual stock list items */
        .stock-list-item-container {
            margin-bottom: 1rem; /* space between items */
        }
        .stock-list-item {
            background-color: #ffffff; /* bg-white */
            color: #1f2937; /* text-gray-800 */
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl, increased rounding */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); /* shadow-md */
            display: flex;
            align-items: center;
        }
        .stock-icon-placeholder {
            width: 3rem; /* w-12 */
            height: 3rem; /* h-12 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 1rem; /* mr-4 */
            flex-shrink: 0;
        }
        .stock-info {
            flex-grow: 1;
        }
        .stock-info-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #111827; /* gray-900 */
        }
        .stock-info-subtitle {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
        }
        .stock-value-tag {
            width: 5rem; /* w-20, increased width */
            height: 5rem; /* h-20, increased height */
            border-radius: 9999px; /* rounded-full */
            background-color: #10b981; /* emerald-500, changed to emerald for better visibility */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-left: 1rem; /* ml-4 */
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(16,185,129,0.3), 0 2px 4px -1px rgba(16,185,129,0.2);
        }
        .stock-value-tag .value-amount {
            font-size: 1.125rem; /* text-lg */
            font-weight: bold;
            line-height: 1.2;
        }
        .stock-value-tag .value-label {
            font-size: 0.65rem; /* text-xs, slightly smaller */
            line-height: 1;
            margin-top: 0.125rem; /* mt-0.5 */
        }
        .stock-actions {
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem; /* p-3 */
            margin-top: 0.75rem; /* mt-3 */
            border-top: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0 0 0.75rem 0.75rem; /* rounded-b-xl */
        }
        /* Modal styles (from nas.html) - these will conflict, so ensure main modal is used */
        /* The main modal in index.html is already defined, these are mostly redundant or need careful merging */
        /* For now, assuming the main index.html modal is sufficient and these are commented out or handled by shared classes */
        /*
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 0.5rem; }
        .tradingview-fullscreen-modal .modal-content { width: 100%; height: 100%; max-width: none; border-radius: 0; padding: 0; }
        .tradingview-fullscreen-modal iframe { width: 100%; height: 100%; border: none; }
        */

    </style>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Updated imports for email/password authentication
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword as firebaseSignInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyB9xHmmBOgq6NLncJNk0tBsygjsmhKqA4c",
            authDomain: "usd-tracker-app.firebaseapp.com",
            projectId: "usd-tracker-app",
            storageBucket: "usd-tracker-app.firebaseapp.com",
            messagingSenderId: "243448319635",
            appId: "1:243448319635:web:95a3d5b01bcb53d68a4766"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase (will be initialized in DOMContentLoaded)
        window.firebaseApp = app; // Use the initialized app
        window.db = db; // Use the initialized db
        window.auth = auth; // Use the initialized auth
        window.userId = null; // Will be set by onAuthStateChanged
        window.userSheetId = null; // To store the user's specific Google Sheet ID

        // Define a fixed appId for Firestore path since Canvas's __app_id is not available
        // This ensures data is stored under a consistent application identifier in Firestore.
        const APP_ID_FOR_FIRESTORE = 'usd-tracker-app-standalone'; // Use your Firebase projectId or a unique identifier

        let swiperInstance = null; // Declare swiperInstance globally or pass it


        // Google Apps Script API URL
        // IMPORTANT: Replace this placeholder URL with your actual deployed Google Apps Script Web App URL.
        // Ensure the Apps Script is deployed as a Web App accessible by "Anyone".
        const API_URL = 'https://script.google.com/macros/s/AKfycbxvf43ju7cZ11SRInOU-PWV-yz31BMunoT_uHzQlWH3-3CRsDO9cuCv_eaZrXvoBmud/exec'; // Updated API_URL
        console.log("Using Google Apps Script API_URL:", API_URL); // Added log for API_URL

        // Global variables to store summary data
        let summaryData = null;

        // Get references to various DOM elements (moved to global scope for broader access)
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successNotification = document.getElementById('successNotification');
        const errorNotification = document.getElementById('errorNotification');
        const totalCardEl = document.getElementById('totalCard');
        const ratesCardEl = document.getElementById('ratesCard');
        const buyCardEl = document.getElementById('buyCard');
        const profitLossCardEl = document.getElementById('profitLossCard'); // New profit/loss card
        const historyList = document.getElementById('historyList'); // For history tab
        const updateNotification = document.getElementById('updateNotification'); // Get update notification element

        // Custom Modal elements (moved to global scope)
        const customModalOverlay = document.getElementById('customModalOverlay');
        const customModalTitle = document.getElementById('customModalTitle');
        const customModalMessage = document.getElementById('customModalMessage');
        const customModalConfirmBtn = document.getElementById('customModalConfirmBtn');
        const customModalCancelBtn = document.getElementById('customModalCancelBtn');

        // Login Modal elements (newly added)
        const loginModalOverlay = document.getElementById('loginModalOverlay');
        const loginModalAuthSection = document.getElementById('loginModalAuthSection'); // Renamed from loginAuthSection
        const loginModalToggleSignIn = document.getElementById('loginModalToggleSignIn');
        const loginModalToggleSignUp = document.getElementById('loginModalToggleSignUp');
        const loginModalFormContainer = document.getElementById('loginModalFormContainer');
        const signUpModalFormContainer = document.getElementById('signUpModalFormContainer');
        const loginModalEmailInput = document.getElementById('loginModalEmailInput');
        const loginModalPasswordInput = document.getElementById('loginModalPasswordInput');
        const signInModalButton = document.getElementById('signInModalButton');
        const signUpModalEmailInput = document.getElementById('signUpModalEmailInput');
        const signUpModalPasswordInput = document.getElementById('signUpModalPasswordInput');
        const signUpModalConfirmPasswordInput = document.getElementById('signUpModalConfirmPasswordInput');
        const signUpModalSubmitButton = document.getElementById('signUpModalSubmitButton');
        const loginModalSignOutButton = document.getElementById('loginModalSignOutButton');


        // Function to display notifications
        function showNotification(element, message = null) {
            const notificationTextElement = element.querySelector('p');
            if (notificationTextElement && message) {
                notificationTextElement.textContent = message;
            } else if (notificationTextElement) {
                // Reset to default message if no custom message is provided
                notificationTextElement.textContent = element.id === 'successNotification' ? 'บันทึกข้อมูลสำเร็จ' : 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง';
            }

            element.classList.remove('translate-x-full'); // Show notification
            setTimeout(() => {
                element.classList.add('translate-x-full'); // Hide notification after 3 seconds
            }, 3000);
        }

        // Function to show custom modal
        function showCustomModal(title, message, onConfirm) {
            customModalTitle.textContent = title;
            customModalMessage.textContent = message;
            customModalOverlay.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                customModalOverlay.classList.add('hidden');
                customModalConfirmBtn.removeEventListener('click', confirmHandler);
                customModalCancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                customModalOverlay.classList.add('hidden');
                customModalConfirmBtn.removeEventListener('click', confirmHandler);
                customModalCancelBtn.removeEventListener('click', cancelHandler);
            };

            customModalConfirmBtn.addEventListener('click', confirmHandler);
            customModalCancelBtn.addEventListener('click', cancelHandler);
        }

        // Function to toggle card state (visual only)
        function toggleCardState(cardElement, toggleInput) {
            if (toggleInput.checked) {
                cardElement.classList.add('card-on');
            } else {
                cardElement.classList.remove('card-on');
            }
        }

        // Format currency to 2 decimal places
        function formatCurrency(value, symbol) {
            if (value === undefined || value === null || isNaN(value)) return '-';
            return `${symbol}${parseFloat(value).toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Format exchange rate to 2 decimal places
        function formatRate(value) {
            if (value === undefined || value === null || isNaN(value)) return '-';
            return parseFloat(value).toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Format date and time (not used directly in current display, but good to keep)
        function formatDateTime(date) {
            return date.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Function to calculate additional buy amount and profit/loss
        function calculateAdditionalBuy() {
            // Check if necessary summary data is loaded
            if (!summaryData || summaryData.totalUSD === undefined || summaryData.targetRate === undefined || summaryData.totalTHB === undefined || summaryData.currentRate === undefined || summaryData.avgRate === undefined) {
                console.warn("Summary data not fully loaded or incomplete for calculating additional buy and profit/loss.");
                // Set to 'N/A' or '0.00' if data is incomplete
                const additionalBuyTHBDisplay = document.getElementById('display-additionalBuyTHB');
                if (additionalBuyTHBDisplay) {
                    additionalBuyTHBDisplay.textContent = 'N/A';
                }
                const additionalBuyUSDDisplay = document.getElementById('display-additionalBuyUSD');
                if (additionalBuyUSDDisplay) {
                    additionalBuyUSDDisplay.textContent = 'N/A';
                }
                const displayUnrealizedProfitLossTHB = document.getElementById('display-unrealizedProfitLossTHB');
                if (displayUnrealizedProfitLossTHB) {
                    displayUnrealizedProfitLossTHB.textContent = 'N/A';
                    displayUnrealizedProfitLossTHB.classList.remove('profit-value', 'loss-value');
                }
                const displayUnrealizedProfitLossUSD = document.getElementById('display-unrealizedProfitLossUSD');
                if (displayUnrealizedProfitLossUSD) {
                    displayUnrealizedProfitLossUSD.textContent = 'N/A';
                    displayUnrealizedProfitLossUSD.classList.remove('profit-value', 'loss-value');
                }
                return;
            }


            const totalTHB = parseFloat(summaryData.totalTHB) || 0;
            const totalUSD = parseFloat(summaryData.totalUSD) || 0;
            const targetRate = parseFloat(summaryData.targetRate) || 0;
            const currentRate = parseFloat(summaryData.currentRate) || 0;
            const avgRate = parseFloat(summaryData.avgRate) || 0; // Get the calculated avgRate


            console.log("Calculating additional buy and profit/loss with:", { totalTHB, totalUSD, targetRate, currentRate, avgRate });


            let additionalTHB = 0;
            let additionalUSD = 0;


            // If AvgRate ($) is less than or equal to Target AvgRate ($), set additional buy to 0.00
            if (avgRate <= targetRate) {
                console.log("AvgRate is less than or equal to TargetRate. Setting additional buy to 0.");
                additionalTHB = 0;
                additionalUSD = 0;
            } else {
                // Calculate the additional amount using the provided formula.
                // Formula: ((TargetRate * totalUSD) - totalTHB) / (1 - (TargetRate / currentRate))
                const numerator = (targetRate * totalUSD) - totalTHB;
                const denominator = (1 - (targetRate / currentRate));

                console.log("Intermediate calculation values:", { numerator, denominator }); // Log intermediate values

                if (currentRate === 0) { // Avoid division by zero for targetRate / currentRate
                    console.warn("Current Rate is zero, cannot calculate additional buy with the given formula.");
                    additionalTHB = 0; // If currentRate is 0, additionalTHB must be 0
                    additionalUSD = 0;
                } else if (denominator === 0) { // Avoid division by zero for the main denominator
                    console.warn("Denominator (1 - (TargetRate / CurrentRate)) is zero, cannot calculate additional buy. This implies TargetRate equals CurrentRate.");
                    additionalTHB = 0; // If denominator is 0, additionalTHB must be 0
                    additionalUSD = 0;
                } else {
                    // Assign the result of the formula directly to additionalTHB as per your clarification
                    additionalTHB = numerator / denominator;
                    // Calculate additionalUSD by converting from the newly calculated additionalTHB
                    additionalUSD = additionalTHB / currentRate;
                }
            }

            // Update display for Additional Buy (฿)
            const additionalBuyTHBDisplay = document.getElementById('display-additionalBuyTHB');
            if (additionalBuyTHBDisplay) {
                additionalBuyTHBDisplay.textContent = formatCurrency(additionalTHB, '฿');
            }


            // Update display for Additional Buy ($)
            const additionalBuyUSDDisplay = document.getElementById('display-additionalBuyUSD');
            if (additionalBuyUSDDisplay) {
                additionalBuyUSDDisplay.textContent = formatCurrency(additionalUSD, '$');
            }


            // Update stored data in summaryData
            summaryData.additionalBuyTHB = additionalTHB;
            summaryData.additionalBuyUSD = additionalUSD;

            // --- Calculate and update Profit/Loss ---
            // Unrealized Profit/Loss (from current holdings)
            let unrealizedProfitLossTHB = (totalUSD * currentRate) - totalTHB;
            let unrealizedProfitLossUSD = unrealizedProfitLossTHB / currentRate;

            const displayUnrealizedProfitLossTHB = document.getElementById('display-unrealizedProfitLossTHB');
            const displayUnrealizedProfitLossUSD = document.getElementById('display-unrealizedProfitLossUSD');

            if (displayUnrealizedProfitLossTHB) {
                displayUnrealizedProfitLossTHB.textContent = formatCurrency(unrealizedProfitLossTHB, '฿');
                displayUnrealizedProfitLossTHB.classList.remove('profit-value', 'loss-value');
                displayUnrealizedProfitLossTHB.classList.add(unrealizedProfitLossTHB >= 0 ? 'profit-value' : 'loss-value');
            }
            if (displayUnrealizedProfitLossUSD) {
                displayUnrealizedProfitLossUSD.textContent = formatCurrency(unrealizedProfitLossUSD, '$');
                displayUnrealizedProfitLossUSD.classList.remove('profit-value', 'loss-value');
                displayUnrealizedProfitLossUSD.classList.add(unrealizedProfitLossUSD >= 0 ? 'profit-value' : 'loss-value');
            }
        }

        // Function to display summary data with improved design
        function displaySummary(summary) {
            // Calculate AvgRate ($) from Total (฿) / Total ($)
            let calculatedAvgRate = 0;
            if (parseFloat(summary.totalUSD) > 0) {
                calculatedAvgRate = parseFloat(summary.totalTHB) / parseFloat(summary.totalUSD);
            }
            summary.avgRate = calculatedAvgRate; // Update avgRate in the summary object

            // Populate Total Card
            totalCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">💰</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-totalCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">ยอดรวม</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">Total (฿)</div>
                    <div class="summary-value">${formatCurrency(summary.totalTHB, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total ($)</div>
                    <div class="summary-value">${formatCurrency(summary.totalUSD, '$')}</div>
                </div>
            `;
            const totalCardToggle = document.getElementById('toggle-totalCard');
            if (totalCardToggle) {
                totalCardToggle.addEventListener('change', () => toggleCardState(totalCardEl, totalCardToggle));
            }


            // Populate Rates Card
            ratesCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-ratesCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">อัตราแลกเปลี่ยน</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">AvgRate ($)</div>
                    <div class="summary-value" id="display-avgRate">${formatRate(summary.avgRate)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Target AvgRate ($)</div>
                    <div class="editable-field">
                        <div class="summary-value" id="display-targetRate">${formatRate(summary.targetRate)}</div>
                        <button class="edit-button ml-2" id="edit-button-targetRate">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <div class="hidden flex items-center" id="edit-form-targetRate">
                            <input type="number" step="0.01" min="0" id="input-targetRate" value="${parseFloat(summary.targetRate).toFixed(2)}">
                            <button class="save-button" id="save-button-targetRate">บันทึก</button>
                        </div>
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rate</div>
                    <div class="editable-field">
                        <div class="summary-value" id="display-currentRate">${formatRate(summary.currentRate)}</div>
                        <button class="edit-button ml-2" id="edit-button-currentRate">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <div class="hidden flex items-center" id="edit-form-currentRate">
                            <input type="number" step="0.01" min="0" id="input-currentRate" value="${parseFloat(summary.currentRate).toFixed(2)}">
                            <button class="save-button" id="save-button-currentRate">บันทึก</button>
                        </div>
                    </div>
                </div>
            `;
            const ratesCardToggle = document.getElementById('toggle-ratesCard');
            if (ratesCardToggle) {
                ratesCardToggle.addEventListener('change', () => toggleCardState(ratesCardEl, ratesCardToggle));
            }


            // Populate Buy Card
            buyCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">💵</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-buyCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">ซื้อเพิ่ม</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div> <div class="summary-item">
                    <div class="summary-label">ซื้อเพิ่ม (฿)</div>
                    <div id="display-additionalBuyTHB" class="highlight-value">0.00 ฿</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ซื้อเพิ่ม ($)</div>
                    <div id="display-additionalBuyUSD" class="highlight-value">0.00 USD</div>
                </div>
            `;
            const buyCardToggle = document.getElementById('toggle-buyCard');
            if (buyCardToggle) {
                buyCardToggle.addEventListener('change', () => toggleCardState(buyCardEl, buyCardToggle));
            }

            // Populate Profit/Loss Card (initial state)
            const totalTHB = parseFloat(summary.totalTHB) || 0;
            const totalUSD = parseFloat(summary.totalUSD) || 0;
            const currentRate = parseFloat(summary.currentRate) || 0;
            const realizedProfitLoss = parseFloat(summary.realizedProfitLoss) || 0; // Realized P/L from sales

            // Unrealized Profit/Loss (from current holdings)
            let unrealizedProfitLossTHB = (totalUSD * currentRate) - totalTHB;
            let unrealizedProfitLossUSD = unrealizedProfitLossTHB / currentRate;

            const unrealizedProfitLossClassTHB = unrealizedProfitLossTHB >= 0 ? 'profit-value' : 'loss-value';
            const unrealizedProfitLossClassUSD = unrealizedProfitLossUSD >= 0 ? 'profit-value' : 'loss-value';

            const realizedProfitLossClass = realizedProfitLoss >= 0 ? 'profit-value' : 'loss-value';


            profitLossCardEl.innerHTML = `
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="toggle-profitLossCard">
                        <span class="slider"></span>
                    </label>
                </div>
                <h3 class="card-title">กำไร/ขาดทุน</h3>
                <p class="card-status">สถานะ: ปกติ</p>
                <div class="flex-grow"></div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่รับรู้ (฿)</div>
                    <div id="display-realizedProfitLossTHB" class="${realizedProfitLossClass}">${formatCurrency(realizedProfitLoss, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่ยังไม่รับรู้ (฿)</div>
                    <div id="display-unrealizedProfitLossTHB" class="${unrealizedProfitLossClassTHB}">${formatCurrency(unrealizedProfitLossTHB, '฿')}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">กำไร/ขาดทุนที่ยังไม่รับรู้ ($)</div>
                    <div id="display-unrealizedProfitLossUSD" class="${unrealizedProfitLossClassUSD}">${formatCurrency(unrealizedProfitLossUSD, '$')}</div>
                </div>
            `;
            const profitLossCardToggle = document.getElementById('toggle-profitLossCard');
            if (profitLossCardToggle) {
                profitLossCardToggle.addEventListener('change', () => toggleCardState(profitLossCardEl, profitLossCardToggle));
            }


            // Add event listeners for editable fields
            addEditableFieldListeners();
            // Recalculate "Additional Buy" and Profit/Loss immediately
            calculateAdditionalBuy();
        }

        // Add event listeners to all editable fields
        function addEditableFieldListeners() {
            // Target Rate
            const targetRateEditButton = document.getElementById('edit-button-targetRate');
            const targetRateDisplay = document.getElementById('display-targetRate');
            const targetRateForm = document.getElementById('edit-form-targetRate');
            const targetRateInput = document.getElementById('input-targetRate');
            const targetRateSaveButton = document.getElementById('save-button-targetRate');


            if (targetRateEditButton) {
                targetRateEditButton.addEventListener('click', function() {
                    targetRateDisplay.classList.add('hidden');
                    targetRateEditButton.classList.add('hidden');
                    targetRateForm.classList.remove('hidden');
                    targetRateInput.focus();
                });


                targetRateInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        targetRateSaveButton.click();
                    }
                });

                targetRateSaveButton.addEventListener('click', function() {
                    saveEditableField('targetRate', targetRateInput, targetRateDisplay, targetRateEditButton, targetRateForm);
                });
            }


            // Current Rate
            const currentRateEditButton = document.getElementById('edit-button-currentRate');
            const currentRateDisplay = document.getElementById('display-currentRate');
            const currentRateForm = document.getElementById('edit-form-currentRate');
            const currentRateInput = document.getElementById('input-currentRate');
            const currentRateSaveButton = document.getElementById('save-button-currentRate');


            if (currentRateEditButton) {
                currentRateEditButton.addEventListener('click', function() {
                    currentRateDisplay.classList.add('hidden');
                    currentRateEditButton.classList.add('hidden');
                    currentRateForm.classList.remove('hidden');
                    currentRateInput.focus();
                });


                currentRateInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        currentRateSaveButton.click();
                    }
                });

                currentRateSaveButton.addEventListener('click', function() {
                    saveEditableField('currentRate', currentRateInput, currentRateDisplay, currentRateEditButton, currentRateForm);
                });
            }
        }


        // Function to save an editable field
        function saveEditableField(key, inputElement, displayElement, editButton, formElement) { // Added editButton parameter
            const newValue = parseFloat(inputElement.value);
            if (!isNaN(newValue) && newValue > 0) {
                // Update the value in summaryData before sending to API
                if (summaryData) {
                    summaryData[key] = newValue;
                }

                // Send update to Google Sheets via API
                // Note: The 'key' (e.g., 'targetRate', 'currentRate') is sent to the Apps Script.
                // Your Apps Script must be configured to map these keys to the correct cells (B2 for targetRate, B3 for currentRate).
                updateSummaryField(key, newValue)
                    .then(() => {
                        // Update display after successful save
                        displayElement.textContent = formatRate(newValue);


                        // Hide edit form
                        displayElement.classList.remove('hidden');
                        editButton.classList.remove('hidden');
                        formElement.classList.add('hidden');


                        // Recalculate additionalBuyTHB and Profit/Loss immediately
                        calculateAdditionalBuy();
                    })
                    .catch(error => {
                        console.error('Error saving field:', error);
                        showNotification(errorNotification, 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message); // Added notification
                        // Revert UI to display mode
                        displayElement.classList.remove('hidden');
                        editButton.classList.remove('hidden');
                        formElement.classList.add('hidden');
                    });
            } else {
                // Invalid input, show error
                inputElement.classList.add('border-red-500');
                setTimeout(() => {
                    inputElement.classList.remove('border-red-500');
                }, 2000);
                showNotification(errorNotification, 'ค่าที่ป้อนไม่ถูกต้อง'); // Added notification
                // Revert UI to display mode (if it was in edit mode)
                displayElement.classList.remove('hidden');
                editButton.classList.remove('hidden');
                formElement.classList.add('hidden');
            }
        }


        // Function to update a summary field in Google Sheets
        async function updateSummaryField(fieldName, value) {
            // Show loading indicator
            loadingOverlay.classList.remove('hidden');


            // Check if userSheetId is set
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                loadingOverlay.classList.add('hidden');
                return false;
            }


            const formData = new FormData();
            formData.append('action', 'updateSummary');
            formData.append('field', fieldName); // fieldName will be 'targetRate' or 'currentRate'
            formData.append('value', value);
            formData.append('sheetId', window.userSheetId); // Pass user's sheet ID


            try {
                console.log("Updating summary field via API_URL:", API_URL); // Added log for fetch
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });


                if (!response.ok) {
                    console.error('Network response was not ok for update summary:', response.status, response.statusText, response.url);
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();


                loadingOverlay.classList.add('hidden');


                if (data.success) {
                    showNotification(successNotification); // Show success notification
                    return true; // Indicate success
                } else {
                    showNotification(errorNotification, data.message || 'Failed to update summary field'); // Show error notification
                    throw new Error(data.message || 'Failed to update summary field'); // Throw error
                }
            } catch (error) {
                console.error('Error updating summary field:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถอัปเดตข้อมูลสรุปได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง'); // Show more specific error notification
                throw error; // Re-throw error
            }
        }

        // Variables for swipe logic (moved to global scope)
        let startX = 0;
        let currentX = 0;
        let isSwiping = false;
        let activeSwipeItem = null; // Stores the currently swiped item's swipe-content element

        // Function to close any currently open swipe item (moved to global scope)
        function closeActiveSwipeItem() {
            if (activeSwipeItem) {
                activeSwipeItem.style.transform = 'translateX(0)';
                activeSwipeItem.classList.remove('swiped');
                const deleteReveal = activeSwipeItem.nextElementSibling; // Assuming delete-reveal is the next sibling
                if (deleteReveal && deleteReveal.classList.contains('delete-reveal')) {
                    deleteReveal.classList.remove('revealed');
                }
                activeSwipeItem = null;
            }
        }

        // Function to delete a record from Google Sheet (moved to global scope)
        async function deleteRecord(originalRowIndex, sheetName) { // Added sheetName parameter
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }

            loadingOverlay.classList.remove('hidden');

            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', originalRowIndex); // Send original row index
            formData.append('sheetId', window.userSheetId);
            formData.append('sheetName', sheetName); // Pass the sheet name for deletion

            try {
                console.log(`Attempting to delete row ${originalRowIndex} from sheet ${sheetName} via API_URL:`, API_URL);
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.error('Network response was not ok for delete:', response.status, response.statusText, response.url);
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                loadingOverlay.classList.add('hidden');

                if (data.success) {
                    showNotification(successNotification, 'ลบข้อมูลสำเร็จ');
                    // Refresh history and summary after successful deletion
                    fetchHistory();
                    fetchSummary();
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการลบข้อมูล');
                }
            } catch (error) {
                console.error('Error deleting data:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถลบข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง');
            }
        }

        // Function to fetch history data from Google Sheets (moved to global scope)
        function fetchHistory() {
            historyList.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                </div>
            `;


            // Check if userSheetId is set
            if (!window.userSheetId) {
                historyList.innerHTML = '<p class="text-red-500 text-center py-4">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>';
                return;
            }


            console.log("Fetching history data from:", API_URL); // Added log for fetch


            const formData = new FormData();
            formData.append('action', 'getRecords');
            formData.append('sheetId', window.userSheetId); // Pass user's sheet ID


            fetch(API_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("History fetch response status:", response.status); // Log response status
                if (!response.ok) {
                    console.error('Network response was not ok for history:', response.status, response.statusText, response.url);
                    throw new Error(`Network response was not ok for history: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("History API Response:", data);


                if (data.success && data.records && Array.isArray(data.records) && data.records.length > 0) {
                    displayHistory(data.records); // Display history data
                } else {
                    historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching history data:', error);
                historyList.innerHTML = `<p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง</p>`;
            });
        }

        // Function to display history data with improved design (moved to global scope)
        function displayHistory(records) {
            historyList.innerHTML = ''; // Clear previous history content
            closeActiveSwipeItem(); // Close any open swipe item when refreshing history


            if (!records || records.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
                return;
            }


            // Sort records by timestamp (assuming it's the last element in data array)
            const sortedRecords = [...records].sort((a, b) => {
                const dateA = new Date(a.data[a.data.length - 1]); // Timestamp is last element
                const dateB = new Date(b.data[b.data.length - 1]);
                return dateB - dateA; // Newest first
            });


            sortedRecords.forEach((recordObj) => {
                const record = recordObj.data;
                const originalRowIndex = recordObj.rowIndex; // Get the original row index
                const type = recordObj.type; // 'buy' or 'sale'
                const sheetName = recordObj.sheetName; // 'Sheet1' or 'Sales'

                let displayDate, amountLabel, amountValue, rateLabel, rateValue, primaryAmount, secondaryAmount;

                // Extract data based on type
                if (type === 'buy') {
                    // [Date, THB Amount, Exchange Rate, USD Amount, Timestamp]
                    displayDate = record[0];
                    primaryAmount = parseFloat(record[3]); // USD Amount
                    secondaryAmount = parseFloat(record[1]); // THB Amount
                    rateValue = parseFloat(record[2]); // Exchange Rate

                    amountLabel = 'จำนวนเงิน:';
                    amountValue = formatCurrency(secondaryAmount, '฿');
                    rateLabel = 'อัตรา:';

                } else if (type === 'sale') {
                    // [Date, USD Amount, Exchange Rate, THB Received, Timestamp]
                    displayDate = record[0];
                    primaryAmount = parseFloat(record[1]); // USD Amount Sold
                    secondaryAmount = parseFloat(record[3]); // THB Received
                    rateValue = parseFloat(record[2]); // Exchange Rate

                    amountLabel = 'ได้รับเงิน:';
                    amountValue = formatCurrency(secondaryAmount, '฿');
                    rateLabel = 'อัตรา:';
                } else {
                    // Fallback for unknown types
                    return;
                }

                // Format date for display
                try {
                    if (typeof displayDate === 'string') {
                        const dateObj = new Date(displayDate);
                        if (!isNaN(dateObj.getTime())) {
                            displayDate = dateObj.toLocaleDateString('th-TH', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                } catch (e) {
                    console.error("Error formatting date:", e);
                }


                // Display only if numerical values are valid
                if (!isNaN(primaryAmount) && !isNaN(rateValue)) {
                    const historyItem = document.createElement('div');
                    historyItem.className = `history-item fade-in ${type}`; // Add 'buy' or 'sale' class
                    historyItem.dataset.originalRowIndex = originalRowIndex; // Store original row index
                    historyItem.dataset.sheetName = sheetName; // Store sheet name

                    historyItem.innerHTML = `
                        <div class="swipe-container">
                            <div class="swipe-content">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">${displayDate} (${type === 'buy' ? 'ซื้อ' : 'ขาย'})</span>
                                    <span class="font-semibold">${primaryAmount.toFixed(2)} USD</span>
                                </div>
                                <div class="flex justify-between text-sm mt-2">
                                    <span>${amountLabel} ${amountValue}</span>
                                    <span>${rateLabel} ${rateValue.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="delete-reveal">
                                <button class="delete-button" data-row-index="${originalRowIndex}" data-sheet-name="${sheetName}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;


                    historyList.appendChild(historyItem);
                }
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent swipe logic from interfering
                    const originalRowIndex = this.dataset.rowIndex; // Get the original row index
                    const sheetName = this.dataset.sheetName; // Get the sheet name
                    showCustomModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => deleteRecord(originalRowIndex, sheetName));
                });
            });

            // Add swipe event listeners to each history item
            document.querySelectorAll('.history-item').forEach(item => {
                const swipeContent = item.querySelector('.swipe-content');
                const deleteReveal = item.querySelector('.delete-reveal');
                const deleteButtonWidth = 80; // Must match CSS width of .delete-reveal

                let startX = 0;
                let currentX = 0;
                let isSwiping = false;
                let initialTranslateX = 0; // To handle items that might already be slightly open

                const handleStart = (e) => {
                    closeActiveSwipeItem(); // Close any other open item
                    isSwiping = true;
                    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    swipeContent.classList.add('dragging');
                    // Get current transform value if any (e.g., if it was partially swiped)
                    const transformMatch = swipeContent.style.transform.match(/translateX\(([^)]+)px\)/);
                    initialTranslateX = transformMatch ? parseFloat(transformMatch[1]) : 0;

                    // Disable Swiper's touch move when a history item swipe starts
                    if (swiperInstance) { // Use swiperInstance
                        swiperInstance.allowTouchMove = false;
                    }
                };

                const handleMove = (e) => {
                    if (!isSwiping) return;

                    currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    let deltaX = currentX - startX;

                    // Add initialTranslateX to deltaX to continue from current position
                    let newTranslateX = initialTranslateX + deltaX;

                    // Limit swipe to the left (negative values) and not beyond delete button width
                    newTranslateX = Math.max(-deleteButtonWidth, Math.min(0, newTranslateX));

                    swipeContent.style.transform = `translateX(${newTranslateX}px)`;
                    deleteReveal.style.transform = `translateX(${Math.max(0, deleteButtonWidth + newTranslateX)}px)`; // Adjust reveal position

                    // Prevent vertical scrolling if horizontal swipe is dominant
                    if (Math.abs(deltaX) > 5) { // Threshold for horizontal movement
                        e.preventDefault();
                    }
                };

                const handleEnd = () => {
                    if (!isSwiping) return;
                    isSwiping = false;
                    swipeContent.classList.remove('dragging');

                    const currentSwipePosition = parseFloat(swipeContent.style.transform.replace('translateX(', '').replace('px)', '')) || 0;

                    // If swiped more than half the delete button width, snap open
                    if (currentSwipePosition < -deleteButtonWidth / 2) {
                        swipeContent.style.transform = `translateX(-${deleteButtonWidth}px)`;
                        deleteReveal.style.transform = `translateX(0)`;
                        swipeContent.classList.add('swiped');
                        deleteReveal.classList.add('revealed');
                        activeSwipeItem = swipeContent; // Set this as the active open item
                    } else {
                        // Snap back to original position
                        swipeContent.style.transform = 'translateX(0)';
                        deleteReveal.style.transform = `translateX(100%)`;
                        swipeContent.classList.remove('swiped');
                        deleteReveal.classList.remove('revealed');
                    }
                    // Re-enable Swiper's touch move when the history item swipe ends
                    if (swiperInstance) { // Use swiperInstance
                        swiperInstance.allowTouchMove = true;
                    }
                };

                // Touch events
                swipeContent.addEventListener('touchstart', handleStart, { passive: false });
                swipeContent.addEventListener('touchmove', handleMove, { passive: false });
                swipeContent.addEventListener('touchend', handleEnd);

                // Mouse events
                swipeContent.addEventListener('mousedown', handleStart);
                swipeContent.addEventListener('mousemove', handleMove);
                swipeContent.addEventListener('mouseup', handleEnd);
                swipeContent.addEventListener('mouseleave', () => { // End swipe if mouse leaves
                    if (isSwiping) handleEnd();
                });
            });


            // If no valid records are displayed
            if (historyList.children.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">ยังไม่มีข้อมูล</p>';
            }
        }


        // Function to fetch summary data from Google Apps Script
        function fetchSummary() {
            // Display loaders in each summary card
            totalCardEl.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                </div>
            `;
            ratesCardEl.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                </div>
            `;
            buyCardEl.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                </div>
            `;
            profitLossCardEl.innerHTML = `
                <div class="flex justify-center py-8">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                </div>
            `;


            // Check if userSheetId is available before fetching data
            if (!window.userSheetId) {
                const noSheetIdMessage = '<p class="text-red-500 text-center py-4">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่า</p>';
                totalCardEl.innerHTML = noSheetIdMessage;
                ratesCardEl.innerHTML = noSheetIdMessage;
                buyCardEl.innerHTML = noSheetIdMessage;
                profitLossCardEl.innerHTML = noSheetIdMessage;
                return;
            }


            console.log("Fetching summary data from:", API_URL); // Added log for fetch

            const formData = new FormData();
            formData.append('action', 'getSummary');
            formData.append('sheetId', window.userSheetId); // Pass user's sheet ID


            fetch(API_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Summary fetch response status:", response.status); // Log response status
                if (!response.ok) {
                    // Log more details about the network response if it's not OK
                    console.error('Network response was not ok for summary:', response.status, response.statusText, response.url);
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Summary API Response:", data);


                if (data.success && data.summary) {
                    // Validate essential summary fields
                    const { totalTHB, totalUSD, targetRate, currentRate, realizedProfitLoss } = data.summary;

                    if (typeof totalTHB === 'number' && typeof totalUSD === 'number' &&
                        typeof targetRate === 'number' && typeof currentRate === 'number' &&
                        typeof realizedProfitLoss === 'number') {
                        summaryData = data.summary; // Store summary data globally
                        displaySummary(data.summary); // Display the summary
                        // Set default card states after summary is displayed
                        const totalCardToggle = document.getElementById('toggle-totalCard');
                        const ratesCardToggle = document.getElementById('toggle-ratesCard');
                        const buyCardToggle = document.getElementById('toggle-buyCard');
                        const profitLossCardToggle = document.getElementById('toggle-profitLossCard');

                        if (totalCardToggle) {
                            totalCardToggle.checked = true;
                            toggleCardState(totalCardEl, totalCardToggle);
                        }
                        if (ratesCardToggle) {
                            ratesCardToggle.checked = true;
                            toggleCardState(ratesCardEl, ratesCardToggle);
                        }
                        if (buyCardToggle) {
                            buyCardToggle.checked = true;
                            toggleCardState(buyCardEl, buyCardToggle);
                        }
                        if (profitLossCardToggle) {
                            profitLossCardToggle.checked = true;
                            toggleCardState(profitLossCardEl, profitLossCardToggle);
                        }
                    } else {
                        console.warn("Summary data received but essential fields are not numbers:", data.summary);
                        const invalidDataMessage = '<p class="text-red-500 text-center py-4">ข้อมูลสรุปไม่ถูกต้องหรือไม่สมบูรณ์</p>';
                        totalCardEl.innerHTML = invalidDataMessage;
                        ratesCardEl.innerHTML = invalidDataMessage;
                        buyCardEl.innerHTML = invalidDataMessage;
                        profitLossCardEl.innerHTML = invalidDataMessage;
                        showNotification(errorNotification, 'ข้อมูลสรุปไม่ถูกต้องหรือไม่สมบูรณ์');
                    }
                } else {
                    const noDataMessage = '<p class="text-gray-500 text-center py-4">ไม่พบข้อมูลสรุป</p>';
                    totalCardEl.innerHTML = noDataMessage;
                    ratesCardEl.innerHTML = noDataMessage;
                    buyCardEl.innerHTML = noDataMessage;
                    profitLossCardEl.innerHTML = noDataMessage;
                }
            })
            .catch(error => {
                console.error('Error fetching summary data:', error);
                const errorMessage = `<p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลสรุปได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง</p>`;
                totalCardEl.innerHTML = errorMessage;
                ratesCardEl.innerHTML = errorMessage;
                buyCardEl.innerHTML = errorMessage;
                profitLossCardEl.innerHTML = errorMessage;
            });
        }


        // Function to fetch the user's Google Sheet ID from Firestore
        async function fetchUserSheetId() {
            if (!window.db || !window.userId) {
                console.error("Firestore or User ID not available to fetch sheet ID.");
                window.userSheetId = null;
                const sheetIdInput = document.getElementById('sheetIdInput');
                if (sheetIdInput) sheetIdInput.value = '';
                return;
            }
            try {
                // Construct the document reference for the user's sheet ID
                // Using a fixed APP_ID_FOR_FIRESTORE as __app_id is not available outside Canvas
                const userSheetDocRef = doc(window.db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${window.userId}/sheets/userSheet`);
                const docSnap = await getDoc(userSheetDocRef); // Get the document snapshot
                if (docSnap.exists()) {
                    window.userSheetId = docSnap.data().sheetId; // Extract the sheetId
                    const sheetIdInput = document.getElementById('sheetIdInput');
                    if (sheetIdInput) sheetIdInput.value = window.userSheetId; // Update the input field
                    console.log("User's Google Sheet ID fetched from Firestore:", window.userSheetId);
                } else {
                    window.userSheetId = null; // No sheet ID found
                    const sheetIdInput = document.getElementById('sheetIdInput');
                    if (sheetIdInput) sheetIdInput.value = ''; // Clear the input field
                    console.log("No Google Sheet ID found for this user in Firestore.");
                }
            } catch (error) {
                console.error("Error fetching user sheet ID from Firestore:", error);
                window.userSheetId = null;
                const sheetIdInput = document.getElementById('sheetIdInput');
                if (sheetIdInput) sheetIdInput.value = '';
            }
        }


        // Function to save the user's Google Sheet ID to Firestore
        async function saveUserSheetId(sheetId) {
            if (!window.db || !window.userId) {
                console.error("Firestore or User ID not available to save sheet ID.");
                return false;
            }
            try {
                // Construct the document reference for the user's sheet ID
                // Using a fixed APP_ID_FOR_FIRESTORE as __app_id is not available outside Canvas
                const userSheetDocRef = doc(window.db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${window.userId}/sheets/userSheet`);
                await setDoc(userSheetDocRef, { sheetId: sheetId }); // Set the document with the new sheet ID
                window.userSheetId = sheetId; // Update global variable
                console.log("User's Google Sheet ID saved to Firestore:", sheetId);
                return true;
            } catch (error) {
                console.error("Error saving user sheet ID to Firestore:", error);
                return false;
            }
        }

        // Function to handle Email/Password Sign-up
        async function signUpWithEmailPassword(email, password) {
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification(successNotification, 'ลงทะเบียนสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว');
                loginModalOverlay.classList.add('hidden'); // Hide modal on successful signup
            } catch (error) {
                console.error("Error during Email/Password Sign-up:", error);
                let errorMessage = 'ลงทะเบียนไม่สำเร็จ: ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'อีเมลนี้ถูกใช้ไปแล้ว';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'รูปแบบอีเมลไม่ถูกต้อง';
                } else {
                    errorMessage += error.message;
                }
                showNotification(errorNotification, errorMessage);
            }
        }

        // Function to handle Email/Password Sign-in
        async function handleSignInWithEmailPassword(email, password) { // Renamed function
            try {
                await firebaseSignInWithEmailAndPassword(auth, email, password); // Use the aliased import
                showNotification(successNotification, 'เข้าสู่ระบบสำเร็จ!');
                loginModalOverlay.classList.add('hidden'); // Hide modal on successful login
            } catch (error) {
                console.error("Error during Email/Password Sign-in:", error);
                let errorMessage = 'เข้าสู่ระบบไม่สำเร็จ: ';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage += 'อีเมลหรือรหัสผ่านไม่ถูกต้อง โปรดตรวจสอบ Firebase Console ว่าเปิดใช้งานการยืนยันตัวตนด้วยอีเมล/รหัสผ่านแล้ว';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'รูปแบบอีเมลไม่ถูกต้อง';
                } else {
                    errorMessage += error.message;
                }
                showNotification(errorNotification, errorMessage);
            }
        }

        // Function to handle user sign-out
        async function signOutUser() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle resetting userId and UI
                showNotification(successNotification, 'ออกจากระบบสำเร็จ');
                // Show login modal after sign out
                loginModalOverlay.classList.remove('hidden');
            } catch (error) {
                console.error("Error during sign out:", error);
                showNotification(errorNotification, 'ออกจากระบบไม่สำเร็จ: ' + error.message);
            }
        }

        // --- Stock Application State & Data ---
        let stockTransactions = []; // This will now be fetched from Google Sheets
        let stockSettings = { // This will now be fetched from Google Sheets
            targetCurrency: 'THB', // Default, but can be updated via settings
            stockTargetRates: {},
            stockTargetExchangeRates: {}
        };
        // Removed stockUseMockData as we are now using real data from Sheets

        // --- Stock DOM Elements (prefixed) ---
        // These will be initialized within initializeStockApp once the DOM is ready for that slide
        let stockMainContent;
        let stockNavItems;
        let stockViews;
        let stockRecordForm;
        let stockSettingsForm;
        let stockHistoryTableBody;
        let stockHistorySearchInput;
        let stockSummaryDashboard;
        let stockSummaryStockDetails;
        let stockStockTargetRatesContainer;
        let stockAddStockTargetRateBtn;
        let stockStockTargetExchangeRatesContainer;
        let stockAddStockTargetUsdRateBtn;
        let stockTvSymbolInput;
        let stockTvLoadSymbolBtn;
        let stockTvFullscreenBtn;
        let stockTradingViewWidgetContainer;
        let stockTradingViewFullscreenModal; // Added for fullscreen
        let stockTradingViewFullscreenContent; // Added for fullscreen
        let stockCloseTradingViewFullscreenBtn; // Added for fullscreen

        // Color mapping for stock icons
        const stockIconColors = [
            'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500',
            'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'
        ];
        let stockColorMap = {};
        let stockNextColorIndex = 0;

        function stockGetStockIconColor(symbol) {
            if (!stockColorMap[symbol]) {
                stockColorMap[symbol] = stockIconColors[stockNextColorIndex % stockIconColors.length];
                stockNextColorIndex++;
            }
            return stockColorMap[symbol];
        }

        // --- Stock Data Persistence (now via Google Sheets) ---
        // Removed stockSaveDataToLocalStorage and stockLoadDataFromLocalStorage

        // --- Stock Modal Functions (re-using main app's modal) ---
        // These functions are already defined in the main script, so no need to redefine them here.
        // function stockShowModal(message) { showNotification(successNotification, message); } // Re-using existing notification
        // function stockCloseModal() { /* No direct equivalent for closing a generic modal here */ }

        // --- Stock TradingView Widget ---
        let stockCurrentTradingViewSymbol = '';
        function stockLoadTradingViewWidget() {
            const symbol = stockTvSymbolInput.value.trim().toUpperCase() || 'AAPL';
            stockCurrentTradingViewSymbol = symbol;
            const widgetHtml = `
                <iframe
                    id="stock-tradingview-iframe" style="width: 100%; height: 100%;" frameborder="0" allowtransparency="true" scrolling="no"
                    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_widget&symbol=${symbol}&interval=D&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=${document.body.classList.contains('light-theme') ? 'light' : 'dark'}&style=1&timezone=Asia%2FBangkok&locale=th&utm_source=localhost&utm_medium=widget_new&utm_campaign=chart&utm_term=${symbol}">
                </iframe>`;
            stockTradingViewWidgetContainer.innerHTML = widgetHtml;
        }

        function stockOpenTradingViewFullscreen() {
            if (!stockCurrentTradingViewSymbol && !stockTvSymbolInput.value.trim()) {
                showNotification(errorNotification, 'กรุณาโหลดกราฟของหุ้นที่ต้องการก่อนเข้าโหมดเต็มจอ');
                return;
            }
            const symbolToLoad = stockCurrentTradingViewSymbol || stockTvSymbolInput.value.trim().toUpperCase() || 'AAPL';
             const fullscreenWidgetHtml = `
                <iframe style="width: 100%; height: 100%;" frameborder="0" allowtransparency="true" scrolling="no"
                    src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_fullscreen_widget&symbol=${symbolToLoad}&interval=D&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=${document.body.classList.contains('light-theme') ? 'light' : 'dark'}&style=1&timezone=Asia%2FBangkok&enabled_features=['header_fullscreen_button']&locale=th&utm_source=localhost&utm_medium=widget_new&utm_campaign=chart&utm_term=${symbolToLoad}">
                </iframe>`;
            stockTradingViewFullscreenContent.innerHTML = fullscreenWidgetHtml;
            stockTradingViewFullscreenModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function stockCloseTradingViewFullscreen() {
            stockTradingViewFullscreenModal.style.display = 'none';
            stockTradingViewFullscreenContent.innerHTML = '';
            document.body.style.overflow = '';
        }

        // --- Stock Record Form Handling ---
        async function stockHandleRecordSubmit(event) {
            event.preventDefault();

            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }

            const formData = new FormData(stockRecordForm);
            const transaction = {
                date: formData.get('date'),
                stockSymbol: formData.get('stockSymbol').toUpperCase().trim(),
                quantity: parseFloat(formData.get('quantity')),
                totalTHB: parseFloat(formData.get('totalTHB')),
                usdExchangeRateAtPurchase: formData.get('usdExchangeRateAtPurchase') ? parseFloat(formData.get('usdExchangeRateAtPurchase')) : 0,
            };

            if (!transaction.date || !transaction.stockSymbol || isNaN(transaction.quantity) || transaction.quantity <= 0 || isNaN(transaction.totalTHB) || transaction.totalTHB <= 0) {
                showNotification(errorNotification, 'กรุณากรอกข้อมูลให้ถูกต้อง: วันที่, ชื่อหุ้น, จำนวนหุ้น และเงินบาทรวมต้องมากกว่า 0');
                return;
            }

            loadingOverlay.classList.remove('hidden');

            const apiFormData = new FormData();
            apiFormData.append('action', 'saveStockRecord');
            apiFormData.append('sheetId', window.userSheetId);
            for (const key in transaction) {
                apiFormData.append(key, transaction[key]);
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: apiFormData
                });
                const data = await response.json();

                loadingOverlay.classList.add('hidden');

                if (data.success) {
                    showNotification(successNotification, 'บันทึกรายการเรียบร้อยแล้ว');
                    stockRecordForm.reset();
                    document.getElementById('stockRecordDate').valueAsDate = new Date();
                    stockFetchAndRenderHistory(); // Refresh history
                    stockFetchAndRenderSummary(); // Refresh summary
                    stockNavigateTo('stockHistoryView');
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกรายการหุ้น');
                }
            } catch (error) {
                console.error('Error saving stock record:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถบันทึกรายการหุ้นได้: ' + error.message);
            }
        }

        // --- Stock History Table Rendering & Actions ---
        async function stockFetchAndRenderHistory(searchTerm = '') {
            stockHistoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-slate-500">กำลังโหลดประวัติ...</td></tr>`;

            if (!window.userSheetId) {
                stockHistoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</td></tr>`;
                return;
            }

            const formData = new FormData();
            formData.append('action', 'getStockRecords');
            formData.append('sheetId', window.userSheetId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success && data.records && Array.isArray(data.records)) {
                    stockTransactions = data.records; // Update local stockTransactions
                    stockRenderHistoryTable(searchTerm);
                } else {
                    stockHistoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">ไม่พบประวัติการซื้อขายหุ้น</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching stock history:', error);
                stockHistoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">ไม่สามารถโหลดประวัติหุ้นได้: ${error.message}</td></tr>`;
            }
        }

        function stockRenderHistoryTable(searchTerm = '') {
            stockHistoryTableBody.innerHTML = '';

            const displayTransactions = stockTransactions.filter(tx => {
                const symbol = tx.data[1] ? tx.data[1].toLowerCase() : ''; // Stock Symbol
                const date = tx.data[0] ? tx.data[0].toLowerCase() : ''; // Date
                const searchLower = searchTerm.toLowerCase();
                return symbol.includes(searchLower) || date.includes(searchLower);
            }).sort((a, b) => new Date(b.data[5]) - new Date(a.data[5])); // Sort by Timestamp (column 5)

            if (displayTransactions.length === 0) {
                stockHistoryTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-slate-500">ไม่พบรายการที่ตรงกัน หรือยังไม่มีประวัติการซื้อขาย</td></tr>`;
                return;
            }

            displayTransactions.forEach(tx => {
                const date = new Date(tx.data[0]).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                const stockSymbol = tx.data[1];
                const quantity = tx.data[2];
                const totalTHB = tx.data[3];
                const usdExchangeRateAtPurchase = tx.data[4];

                const row = stockHistoryTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${date}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-900">${stockSymbol}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${quantity.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${totalTHB.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${usdExchangeRateAtPurchase ? usdExchangeRateAtPurchase.toFixed(2) : '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">
                        <button onclick="stockConfirmDeleteTransaction('${tx.rowIndex}')" class="text-red-600 hover:text-red-800 font-medium">ลบ</button>
                    </td>
                `;
            });
        }

        function stockConfirmDeleteTransaction(rowIndex) {
            showCustomModal('ยืนยันการลบ', 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?', () => stockDeleteTransaction(rowIndex));
        }

        async function stockDeleteTransaction(rowIndex) {
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }

            loadingOverlay.classList.remove('hidden');

            const formData = new FormData();
            formData.append('action', 'deleteStockRecord');
            formData.append('rowIndex', rowIndex);
            formData.append('sheetId', window.userSheetId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                loadingOverlay.classList.add('hidden');

                if (data.success) {
                    showNotification(successNotification, 'ลบรายการเรียบร้อยแล้ว');
                    stockFetchAndRenderHistory(); // Refresh history
                    stockFetchAndRenderSummary(); // Refresh summary
                } else {
                    showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการลบรายการหุ้น');
                }
            } catch (error) {
                console.error('Error deleting stock data:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถลบรายการหุ้นได้: ' + error.message);
            }
        }

        // Removed stockEditTransaction as it's complex with direct sheet interaction. User can delete and re-add.

        // --- Stock Settings Form Handling ---
        async function stockFetchAndRenderSettingsForm() {
            document.getElementById('stockSettingsSheetId').value = window.userSheetId || ''; // Pre-fill with main sheet ID

            if (!window.userSheetId) {
                stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-red-500">กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าหลักก่อน</p>';
                stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-red-500">กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าหลักก่อน</p>';
                return;
            }

            const formData = new FormData();
            formData.append('action', 'getStockSettings');
            formData.append('sheetId', window.userSheetId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success && data.settings) {
                    stockSettings.stockTargetRates = {};
                    stockSettings.stockTargetExchangeRates = {};
                    for (const key in data.settings) {
                        if (key.startsWith('TargetRate_')) {
                            stockSettings.stockTargetRates[key.replace('TargetRate_', '')] = parseFloat(data.settings[key]);
                        } else if (key.startsWith('ExchangeRate_')) {
                            stockSettings.stockTargetExchangeRates[key.replace('ExchangeRate_', '')] = parseFloat(data.settings[key]);
                        } else if (key === 'TargetCurrency') {
                            stockSettings.targetCurrency = data.settings[key];
                        }
                    }
                    stockRenderStockTargetRates();
                    stockRenderStockTargetExchangeRates();
                } else {
                    stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>';
                    stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>';
                }
            } catch (error) {
                console.error('Error fetching stock settings:', error);
                showNotification(errorNotification, 'ไม่สามารถโหลดการตั้งค่าหุ้นได้: ' + error.message);
                stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-red-500">ไม่สามารถโหลดการตั้งค่าหุ้นได้</p>';
                stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-red-500">ไม่สามารถโหลดการตั้งค่าหุ้นได้</p>';
            }
        }

        async function stockHandleSettingsSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return;
            }

            // The sheetId input in stock settings is now just for display, the actual sheetId is window.userSheetId
            // No need to save sheetId here via API, as it's managed by the main settings.

            // Only update target rates and exchange rates if they are modified.
            // These are handled by their specific add/remove functions, which call updateStockSetting.
            showNotification(successNotification, 'บันทึกการตั้งค่าหุ้นเรียบร้อยแล้ว');
            stockFetchAndRenderSummary(); // Refresh summary if settings changed
        }

        async function stockUpdateSettingInSheet(key, value) {
            if (!window.userSheetId) {
                showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                return false;
            }
            loadingOverlay.classList.remove('hidden');
            const formData = new FormData();
            formData.append('action', 'updateStockSetting');
            formData.append('sheetId', window.userSheetId);
            formData.append('key', key);
            formData.append('value', value);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                loadingOverlay.classList.add('hidden');
                if (data.success) {
                    showNotification(successNotification, 'อัปเดตการตั้งค่าสำเร็จ');
                    return true;
                } else {
                    showNotification(errorNotification, data.message || 'ไม่สามารถอัปเดตการตั้งค่าได้');
                    return false;
                }
            } catch (error) {
                console.error('Error updating stock setting:', error);
                loadingOverlay.classList.add('hidden');
                showNotification(errorNotification, 'ไม่สามารถอัปเดตการตั้งค่าได้: ' + error.message);
                return false;
            }
        }

        function stockRenderStockTargetRates() {
            stockStockTargetRatesContainer.innerHTML = '';
            const targetRates = Object.keys(stockSettings.stockTargetRates).sort();
            if (targetRates.length === 0) {
                stockStockTargetRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>';
                return;
            }
            targetRates.forEach(symbol => {
                const rate = stockSettings.stockTargetRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${stockSettings.targetCurrency}</span>
                    <button onclick="stockRemoveStockTargetRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `;
                stockStockTargetRatesContainer.appendChild(div);
            });
        }

        async function stockHandleAddStockTargetRate() {
            const symbolInput = document.getElementById('stockNewTargetStockSymbol');
            const rateInput = document.getElementById('stockNewTargetStockRate');
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);

            if (symbol && !isNaN(rate) && rate > 0) {
                const success = await stockUpdateSettingInSheet(`TargetRate_${symbol}`, rate);
                if (success) {
                    stockSettings.stockTargetRates[symbol] = rate; // Update local state
                    stockRenderStockTargetRates();
                    stockFetchAndRenderSummary();
                    symbolInput.value = '';
                    rateInput.value = '';
                }
            } else {
                showNotification(errorNotification, 'กรุณากรอกชื่อหุ้นและ Rate เป้าหมายให้ถูกต้อง');
            }
        }

        async function stockRemoveStockTargetRate(symbol) {
            showCustomModal('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบ Rate เป้าหมายสำหรับ ${symbol}?`, async () => {
                const success = await stockUpdateSettingInSheet(`TargetRate_${symbol}`, ''); // Set to empty to "delete"
                if (success) {
                    delete stockSettings.stockTargetRates[symbol]; // Remove from local state
                    stockRenderStockTargetRates();
                    stockFetchAndRenderSummary();
                }
            });
        }

        function stockRenderStockTargetExchangeRates() {
            stockStockTargetExchangeRatesContainer.innerHTML = '';
            const exchangeRates = Object.keys(stockSettings.stockTargetExchangeRates).sort();
            if (exchangeRates.length === 0) {
                stockStockTargetExchangeRatesContainer.innerHTML = '<p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>';
                return;
            }
            exchangeRates.forEach(symbol => {
                const rate = stockSettings.stockTargetExchangeRates[symbol];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md border border-slate-200';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${symbol}:</span>
                    <span class="text-slate-600">${parseFloat(rate).toFixed(2)} THB/USD</span>
                    <button onclick="stockRemoveStockTargetUsdRate('${symbol}')" class="text-red-500 hover:text-red-700 text-sm font-medium">ลบ</button>
                `;
                stockStockTargetExchangeRatesContainer.appendChild(div);
            });
        }

        async function stockHandleAddStockTargetUsdRate() {
            const symbolInput = document.getElementById('stockNewTargetStockSymbolUsd');
            const rateInput = document.getElementById('stockNewTargetUsdRate');
            const symbol = symbolInput.value.toUpperCase().trim();
            const rate = parseFloat(rateInput.value);

            if (symbol && !isNaN(rate) && rate > 0) {
                const success = await stockUpdateSettingInSheet(`ExchangeRate_${symbol}`, rate);
                if (success) {
                    stockSettings.stockTargetExchangeRates[symbol] = rate; // Update local state
                    stockRenderStockTargetExchangeRates();
                    stockFetchAndRenderSummary();
                    symbolInput.value = '';
                    rateInput.value = '';
                }
            } else {
                showNotification(errorNotification, 'กรุณากรอกชื่อหุ้นและ Rate แลกเปลี่ยนเป้าหมายให้ถูกต้อง');
            }
        }

        async function stockRemoveStockTargetUsdRate(symbol) {
            showCustomModal('ยืนยันการลบ', `คุณแน่ใจหรือไม่ว่าต้องการลบ Rate แลกเปลี่ยนเป้าหมายสำหรับ ${symbol}?`, async () => {
                const success = await stockUpdateSettingInSheet(`ExchangeRate_${symbol}`, ''); // Set to empty to "delete"
                if (success) {
                    delete stockSettings.stockTargetExchangeRates[symbol]; // Remove from local state
                    stockRenderStockTargetExchangeRates();
                    stockFetchAndRenderSummary();
                }
            });
        }

        // --- Stock Summary Calculation and Rendering (Updated for new design) ---
        async function stockFetchAndRenderSummary() {
            stockSummaryDashboard.innerHTML = `
                <div class="summary-card">
                    <p class="summary-card-title">กำลังโหลดข้อมูล...</p>
                    <p class="summary-card-value">-</p>
                </div>
            `;
            stockSummaryStockDetails.innerHTML = '<p class="text-gray-400 p-4 text-center">กำลังโหลดข้อมูลหุ้น...</p>';

            if (!window.userSheetId) {
                 stockSummaryDashboard.innerHTML = `
                    <div class="summary-card col-span-1 sm:col-span-2">
                        <p class="summary-card-title">ภาพรวมพอร์ตการลงทุน</p>
                        <p class="text-lg text-red-500">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>
                    </div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-red-500 p-4 text-center">กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน</p>';
                return;
            }

            try {
                // Fetch stock transactions
                const stockTxFormData = new FormData();
                stockTxFormData.append('action', 'getStockRecords');
                stockTxFormData.append('sheetId', window.userSheetId);
                const stockTxResponse = await fetch(API_URL, { method: 'POST', body: stockTxFormData });
                const stockTxData = await stockTxResponse.json();

                if (stockTxData.success && Array.isArray(stockTxData.records)) {
                    stockTransactions = stockTxData.records; // Update global state
                } else {
                    stockTransactions = [];
                }

                // Fetch stock settings
                const stockSettingsFormData = new FormData();
                stockSettingsFormData.append('action', 'getStockSettings');
                stockSettingsFormData.append('sheetId', window.userSheetId);
                const stockSettingsResponse = await fetch(API_URL, { method: 'POST', body: stockSettingsFormData });
                const stockSettingsData = await stockSettingsResponse.json();

                if (stockSettingsData.success && stockSettingsData.settings) {
                    stockSettings.stockTargetRates = {};
                    stockSettings.stockTargetExchangeRates = {};
                    for (const key in stockSettingsData.settings) {
                        if (key.startsWith('TargetRate_')) {
                            stockSettings.stockTargetRates[key.replace('TargetRate_', '')] = parseFloat(stockSettingsData.settings[key]);
                        } else if (key.startsWith('ExchangeRate_')) {
                            stockSettings.stockTargetExchangeRates[key.replace('ExchangeRate_', '')] = parseFloat(stockSettingsData.settings[key]);
                        } else if (key === 'TargetCurrency') {
                            stockSettings.targetCurrency = stockSettingsData.settings[key];
                        }
                    }
                } else {
                    stockSettings.stockTargetRates = {};
                    stockSettings.stockTargetExchangeRates = {};
                }

                // Now render summary with fetched data
                stockRenderSummaryContent();

            } catch (error) {
                console.error('Error fetching stock data for summary:', error);
                stockSummaryDashboard.innerHTML = `<div class="summary-card col-span-1 sm:col-span-2"><p class="text-red-500 text-center py-4">ไม่สามารถโหลดข้อมูลสรุปหุ้นได้: ${error.message}</p></div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-red-500 p-4 text-center">ไม่สามารถโหลดข้อมูลหุ้นรายตัวได้</p>';
            }
        }

        function stockRenderSummaryContent() {
            stockSummaryDashboard.innerHTML = '';
            stockSummaryStockDetails.innerHTML = '';

            if (stockTransactions.length === 0) {
                 stockSummaryDashboard.innerHTML = `
                    <div class="summary-card col-span-1 sm:col-span-2">
                        <p class="summary-card-title">ภาพรวมพอร์ตการลงทุน</p>
                        <p class="text-lg text-gray-300">ยังไม่มีข้อมูลการลงทุน</p>
                        <p class="text-sm text-gray-400 mt-2">กรุณาไปที่หน้า "บันทึก" เพื่อเพิ่มรายการซื้อขายแรกของคุณ</p>
                    </div>`;
                stockSummaryStockDetails.innerHTML = '<p class="text-gray-400 p-4 text-center">เมื่อมีข้อมูลแล้ว รายละเอียดหุ้นจะแสดงที่นี่</p>';
                return;
            }

            let totalInvestmentTHB = 0;
            const uniqueStockSymbols = new Set();
            const stocksData = {};

            stockTransactions.forEach(tx => {
                const record = tx.data; // Data from Apps Script is in record.data
                const stockSymbol = record[1];
                const quantity = parseFloat(record[2]);
                const totalTHB = parseFloat(record[3]);
                const usdExchangeRateAtPurchase = parseFloat(record[4] || 0);

                totalInvestmentTHB += totalTHB;
                uniqueStockSymbols.add(stockSymbol);

                if (!stocksData[stockSymbol]) {
                    stocksData[stockSymbol] = {
                        totalShares: 0,
                        totalTHBSpent: 0,
                        totalUsdRateWeighted: 0,
                        usdRateTxCount: 0
                    };
                }
                stocksData[stockSymbol].totalShares += quantity;
                stocksData[stockSymbol].totalTHBSpent += totalTHB;

                if (usdExchangeRateAtPurchase > 0) { // Only count if a valid rate was provided
                    stocksData[stockSymbol].totalUsdRateWeighted += usdExchangeRateAtPurchase * quantity;
                    stocksData[stockSymbol].usdRateTxCount += quantity;
                }
            });

            const totalInvestmentCard = document.createElement('div');
            totalInvestmentCard.className = 'summary-card';
            totalInvestmentCard.innerHTML = `
                <p class="summary-card-title">มูลค่าลงทุนรวม</p>
                <p class="summary-card-value">${totalInvestmentTHB.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}<span class="summary-card-currency">${stockSettings.targetCurrency}</span></p>
            `;
            stockSummaryDashboard.appendChild(totalInvestmentCard);

            const uniqueStocksCard = document.createElement('div');
            uniqueStocksCard.className = 'summary-card';
            uniqueStocksCard.innerHTML = `
                <p class="summary-card-title">จำนวนหุ้นที่ถือครอง</p>
                <p class="summary-card-value">${uniqueStockSymbols.size}<span class="summary-card-currency">ตัว</span></p>
                <p class="text-xs text-gray-400 mt-1">หุ้นที่ไม่ซ้ำกัน</p>
            `;
            stockSummaryDashboard.appendChild(uniqueStocksCard);

            if (Object.keys(stocksData).length === 0) {
                 stockSummaryStockDetails.innerHTML = `<p class="text-gray-400 p-4 text-center">ยังไม่มีข้อมูลหุ้นรายตัว</p>`;
            }

            Object.keys(stocksData).sort().forEach(symbol => {
                const data = stocksData[symbol];
                const averageCostPerShare = data.totalShares > 0 ? data.totalTHBSpent / data.totalShares : 0;
                const averageUsdRateAtPurchase = data.usdRateTxCount > 0 ? data.totalUsdRateWeighted / data.usdRateTxCount / (data.usdRateTxCount > 0 ? data.usdRateTxCount / data.usdRateTxCount : 1) : 0;
                // Corrected averageUsdRateAtPurchase calculation: it should be totalUsdRateWeighted / totalShares if weighted by quantity.
                // Re-evaluating: if totalUsdRateWeighted sums (rate * quantity), then avg is sum(rate*qty) / sum(qty)
                const actualAverageUsdRateAtPurchase = data.totalShares > 0 ? data.totalUsdRateWeighted / data.totalShares : 0;


                const targetRate = stockSettings.stockTargetRates[symbol] || 0;
                const targetUsdExchangeRate = stockSettings.stockTargetExchangeRates[symbol] || 0;
                const iconColor = stockGetStockIconColor(symbol);

                let displayValue = '';
                if (data.totalTHBSpent >= 1000000) {
                    displayValue = (data.totalTHBSpent / 1000000).toFixed(1) + 'M';
                } else if (data.totalTHBSpent >= 1000) {
                    displayValue = (data.totalTHBSpent / 1000).toFixed(0) + 'K';
                } else {
                    displayValue = data.totalTHBSpent.toFixed(0);
                }


                const stockItemContainer = document.createElement('div');
                stockItemContainer.className = 'stock-list-item-container mb-3';

                const stockDiv = document.createElement('div');
                stockDiv.className = 'stock-list-item';
                stockDiv.innerHTML = `
                    <div class="stock-icon-placeholder ${iconColor}">
                        ${symbol.charAt(0)}
                    </div>
                    <div class="stock-info">
                        <h3 class="stock-info-title">${symbol}</h3>
                        <p class="text-sm text-gray-500">จำนวนหุ้น: ${data.totalShares.toLocaleString()}</p>
                        <p class="text-sm text-gray-500">ต้นทุนเฉลี่ย (THB/หุ้น): ${averageCostPerShare.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</p>
                        ${actualAverageUsdRateAtPurchase > 0 ? `<p class="text-sm text-gray-500">Rate แลกเปลี่ยนเฉลี่ย (THB/USD): ${actualAverageUsdRateAtPurchase.toFixed(2)}</p>` : ''}
                        ${targetRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมายราคา (THB/หุ้น): ${targetRate.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</p>` : ''}
                        ${targetUsdExchangeRate > 0 ? `<p class="text-sm text-blue-600 font-medium">เป้าหมาย Rate แลกเปลี่ยน (THB/USD): ${targetUsdExchangeRate.toFixed(2)}</p>` : ''}
                    </div>
                    <div class="stock-value-tag">
                        <span class="value-amount">${displayValue}</span>
                        <span class="value-label">${stockSettings.targetCurrency}</span>
                    </div>
                `;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'stock-actions hidden';
                actionsDiv.innerHTML = `
                    <div class="grid grid-cols-1 gap-2">
                         <div>
                            <label for="currentMarketPrice_${symbol}" class="block text-xs font-medium text-gray-700 mb-1">Rate ปัจจุบัน (ราคาตลาด/หุ้น):</label>
                            <input type="number" id="currentMarketPrice_${symbol}" step="any" placeholder="กรอกราคาตลาด" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button onclick="stockCalculateAdditionalPurchase('${symbol}', ${data.totalShares}, ${data.totalTHBSpent}, ${targetRate})" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm text-xs">คำนวณซื้อเพิ่ม</button>
                    </div>
                    <div id="additionalPurchaseResult_${symbol}" class="mt-2 text-xs text-gray-600"></div>
                `;

                stockItemContainer.appendChild(stockDiv);
                stockItemContainer.appendChild(actionsDiv);
                stockSummaryStockDetails.appendChild(stockItemContainer);

                stockDiv.addEventListener('click', () => {
                    actionsDiv.classList.toggle('hidden');
                    if (!actionsDiv.classList.contains('hidden')) {
                         setTimeout(() => actionsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
                    }
                });
            });
        }


        function stockCalculateAdditionalPurchase(symbol, currentShares, currentTotalCost, targetAvgPrice) {
            const marketPriceInput = document.getElementById(`currentMarketPrice_${symbol}`);
            const marketPrice = parseFloat(marketPriceInput.value);
            const resultDiv = document.getElementById(`additionalPurchaseResult_${symbol}`);
            resultDiv.innerHTML = '';

            if (isNaN(marketPrice) || marketPrice <= 0) {
                resultDiv.innerHTML = '<p class="text-red-600">กรุณากรอกราคาตลาดปัจจุบันให้ถูกต้อง</p>';
                return;
            }
            if (targetAvgPrice <= 0) {
                resultDiv.innerHTML = '<p class="text-orange-600">กรุณาตั้ง Rate เป้าหมายสำหรับหุ้นนี้ในหน้า "ตั้งค่า" ก่อน</p>';
                return;
            }

            if (Math.abs(marketPrice - targetAvgPrice) < 0.001) {
                const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) {
                     resultDiv.innerHTML = `<p class="text-green-600">ต้นทุนเฉลี่ยและราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมายแล้ว ไม่จำเป็นต้องซื้อเพิ่ม</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="text-orange-600">ราคาตลาดปัจจุบันเท่ากับ Rate เป้าหมาย ไม่สามารถใช้สูตรนี้เพื่อปรับ Rate เฉลี่ยได้โดยตรง</p>`;
                }
                return;
            }

            const amountTHBtoBuy = (targetAvgPrice * currentShares - currentTotalCost) * marketPrice / (marketPrice - targetAvgPrice);

            let message = '';
            if (amountTHBtoBuy > 0) {
                const newShares = amountTHBtoBuy / marketPrice;
                const newTotalShares = currentShares + newShares;
                const newTotalCost = currentTotalCost + amountTHBtoBuy;
                const newAvgCost = newTotalCost / newTotalShares;

                message = `
                    <p class="text-green-700 font-semibold">หากต้องการ Rate เฉลี่ยที่ ${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}:</p>
                    <ul class="list-disc list-inside ml-2 mt-1">
                        <li>ซื้อเพิ่ม: <strong class="font-medium">${amountTHBtoBuy.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}</strong></li>
                        <li>(ที่ราคา ${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}/หุ้น)</li>
                        <li>ได้หุ้นเพิ่ม: ${newShares.toLocaleString(undefined, {minimumFractionDigits: 4})} หุ้น</li>
                        <li>Rate เฉลี่ยใหม่: ${newAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${stockSettings.targetCurrency}</li>
                    </ul>
                `;
            } else {
                 const currentAvgCost = currentShares > 0 ? currentTotalCost / currentShares : 0;
                 if (Math.abs(currentAvgCost - targetAvgPrice) < 0.001) {
                    message = `<p class="text-green-600">ต้นทุนเฉลี่ยปัจจุบันของคุณอยู่ที่ประมาณ Rate เป้าหมายแล้ว (${currentAvgCost.toLocaleString(undefined, {minimumFractionDigits: 2})} ${stockSettings.targetCurrency}).</p>`;
                 } else if (targetAvgPrice > currentAvgCost && marketPrice < targetAvgPrice) {
                    message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยต่ำลง/เข้าใกล้ราคาตลาด</p>`;
                 } else if (targetAvgPrice < currentAvgCost && marketPrice > targetAvgPrice) {
                    message = `<p class="text-orange-500">Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ต่ำกว่าต้นทุนเฉลี่ยปัจจุบัน แต่ราคาตลาด (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) สูงกว่า Rate เป้าหมาย การซื้อที่ราคานี้จะทำให้ต้นทุนเฉลี่ยสูงขึ้น/เข้าใกล้ราคาตลาด</p>`;
                 }
                 else {
                    message = `<p class="text-orange-500">การซื้อหุ้นที่ราคาตลาดปัจจุบัน (${marketPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) อาจไม่ช่วยให้ไปถึง Rate เป้าหมาย (${targetAvgPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}) ตามที่ต้องการ หรือเงื่อนไขไม่เหมาะสม</p>`;
                 }
            }
            resultDiv.innerHTML = message;
        }


        // Main application initialization function.
        // This function is called after Firebase authentication and sheet ID fetching are attempted.
        function initializeAppComponent() {
            // Get references to various DOM elements
            const buyForm = document.getElementById('usdBuyForm'); // Changed from usdForm
            const thbAmountInput = document.getElementById('thbAmount');
            const exchangeRateInput = document.getElementById('exchangeRate');
            const usdResultElement = document.getElementById('usdResult');
            const refreshButton = document.getElementById('refreshButton');
            const refreshSummaryButton = document.getElementById('refreshSummaryButton');
            const navItems = document.querySelectorAll('.nav-item');
            const indicators = document.querySelectorAll('.indicator');

            // Sales form elements
            const sellForm = document.getElementById('usdSellForm');
            const usdSellAmountInput = document.getElementById('usdSellAmount');
            const exchangeRateSellInput = document.getElementById('exchangeRateSell');
            const thbReceiveResultElement = document.getElementById('thbReceiveResult');

            // Form toggle elements
            const buyFormToggleBtn = document.getElementById('buyFormToggleBtn');
            const sellFormToggleBtn = document.getElementById('sellFormToggleBtn');
            const buyFormContainer = document.getElementById('buyFormContainer');
            const sellFormContainer = document.getElementById('sellFormContainer');


            // Settings tab elements
            const sheetIdInput = document.getElementById('sheetIdInput');
            const saveSheetIdButton = document.getElementById('saveSheetIdButton');
            const displayUserId = document.getElementById('displayUserId');
            const signOutButtonSettings = document.getElementById('signOutButtonSettings'); // New sign out button in settings

            // Theme toggle elements
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const tradingViewWidgetContainer = document.querySelector('.tradingview-widget-container__widget');


            // Initialize Swiper for tab navigation
            swiperInstance = new Swiper(".mySwiper", { // Assign to global swiperInstance
                initialSlide: 0, // Default to Summary tab (now index 0)
                effect: "slide", // Slide transition effect
                speed: 300, // Transition speed
                allowTouchMove: false, // Initially disable touch move until authenticated
                resistance: true, // Enable resistance effect
                resistanceRatio: 0.85, // Resistance ratio
                on: {
                    // Update bottom navigation when slide changes
                    slideChange: function() {
                        updateNavigation(this.activeIndex);
                    },
                    // Load data specific to the tab after slide transition ends
                    slideChangeTransitionEnd: function() {
                        if (this.activeIndex === 0) { // Summary USD tab (index 0)
                            if (window.userSheetId) {
                                fetchSummary();
                            } else if (window.userId) { // If logged in but no sheet ID
                                showNotification(document.getElementById('errorNotification'), 'กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                            } else { // Not logged in (should be prevented by allowTouchMove anyway)
                                 const noSheetIdMessage = '<p class="text-gray-500 text-center py-4">โปรดเข้าสู่ระบบเพื่อดูข้อมูล</p>';
                                 totalCardEl.innerHTML = noSheetIdMessage;
                                 ratesCardEl.innerHTML = noSheetIdMessage;
                                 buyCardEl.innerHTML = noSheetIdMessage;
                                 profitLossCardEl.innerHTML = noSheetIdMessage;
                            }
                        } else if (this.activeIndex === 1) { // Record USD tab (index 1)
                            const today = new Date();
                            const formattedDate = today.toISOString().split('T')[0];
                            const dateInput = document.getElementById('date');
                            const dateSellInput = document.getElementById('dateSell');
                            if (dateInput) {
                                dateInput.value = formattedDate;
                                calculateUSD();
                            }
                            if (dateSellInput) {
                                dateSellInput.value = formattedDate;
                                calculateTHBForSale();
                            }
                        } else if (this.activeIndex === 2) { // History USD tab (index 2)
                            fetchHistory();
                        } else if (this.activeIndex === 4) { // Stock Management tab (new index 4)
                            initializeStockApp(); // Initialize stock app when this tab is active
                        }
                    },
                    // Prevent swiping if not logged in
                    touchStart: function(swiper, event) {
                        if (!window.userId) {
                            swiper.allowTouchMove = false;
                        } else {
                            swiper.allowTouchMove = true;
                        }
                    },
                    touchEnd: function(swiper, event) {
                         if (window.userId) {
                             swiper.allowTouchMove = true;
                         } else {
                             swiper.allowTouchMove = false;
                         }
                    }
                }
            });


            // Function to update the active state of bottom navigation items and indicators
            function updateNavigation(index) {
                navItems.forEach((item, i) => {
                    if (i === index) { // Directly use index as login slide is removed
                        item.classList.add('active'); // Add active class
                    } else {
                        item.classList.remove('active'); // Remove active class
                    }
                });


                indicators.forEach((indicator, i) => {
                    if (i === index) { // Directly use index
                        indicator.classList.add('active'); // Add active class
                    } else {
                        indicator.classList.remove('active'); // Remove active class
                    }
                });
            }


            // Add click listeners to bottom navigation items to change slides
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const targetIndex = parseInt(this.getAttribute('data-index')); // Get index from data-index attribute
                    if (window.userId) {
                        // If logged in, allow navigation to any content tab (0, 1, 2, 3, 4)
                        if (swiperInstance) {
                            swiperInstance.slideTo(targetIndex);
                        }
                    } else {
                        // If not logged in, prevent navigation and show error
                        showNotification(errorNotification, 'กรุณาเข้าสู่ระบบก่อน');
                    }
                });
            });


            // Function to calculate USD amount based on THB amount and exchange rate (for Purchase)
            function calculateUSD() {
                const thbAmount = parseFloat(thbAmountInput.value) || 0; // Get THB amount
                const exchangeRate = parseFloat(exchangeRateInput.value) || 0; // Get exchange rate


                if (thbAmount > 0 && exchangeRate > 0) {
                    const usdAmount = thbAmount / exchangeRate; // Calculate USD
                    usdResultElement.textContent = usdAmount.toFixed(2) + ' USD'; // Display result
                } else {
                    usdResultElement.textContent = '0.00 USD'; // Display 0.00 USD if inputs are invalid
                }
            }

            // Function to calculate THB amount based on USD amount and exchange rate (for Sale)
            function calculateTHBForSale() {
                const usdAmount = parseFloat(usdSellAmountInput.value) || 0;
                const exchangeRate = parseFloat(exchangeRateSellInput.value) || 0;

                if (usdAmount > 0 && exchangeRate > 0) {
                    const thbReceived = usdAmount * exchangeRate;
                    thbReceiveResultElement.textContent = thbReceived.toFixed(2) + ' ฿';
                } else {
                    thbReceiveResultElement.textContent = '0.00 ฿';
                }
            }


            // Add input event listeners to recalculate USD on change
            thbAmountInput.addEventListener('input', calculateUSD);
            exchangeRateInput.addEventListener('input', calculateUSD);

            // Add input event listeners to recalculate THB on change for sales
            usdSellAmountInput.addEventListener('input', calculateTHBForSale);
            exchangeRateSellInput.addEventListener('input', calculateTHBForSale);


            // Handle form submission for saving purchase data
            buyForm.addEventListener('submit', function(e) { // Changed from form
                e.preventDefault(); // Prevent default form submission


                const date = document.getElementById('date').value;
                const thbAmount = parseFloat(thbAmountInput.value);
                const exchangeRate = parseFloat(exchangeRateInput.value);


                // Validate input data
                if (!date || isNaN(thbAmount) || isNaN(exchangeRate)) {
                    showNotification(errorNotification, 'กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง'); // Show error notification
                    return;
                }


                // Check if userSheetId is set
                if (!window.userSheetId) {
                    showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                    return;
                }


                // Show loading overlay
                loadingOverlay.classList.remove('hidden');


                // Prepare data for API request
                const formData = new FormData();
                formData.append('action', 'save');
                formData.append('date', date);
                formData.append('thbAmount', thbAmount);
                formData.append('exchangeRate', exchangeRate);
                formData.append('sheetId', window.userSheetId); // Add user's sheet ID


                console.log("Attempting to save data to API_URL:", API_URL);


                // Send data to Google Apps Script
                fetch(API_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log("Save data response status:", response.status); // Log response status
                    if (!response.ok) {
                        // Log more details about the network response if it's not OK
                        console.error('Network response was not ok:', response.status, response.statusText, response.url);
                        throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading overlay
                    loadingOverlay.classList.add('hidden');


                    if (data.success) {
                        showNotification(successNotification); // Show success notification


                        // Reset form fields
                        thbAmountInput.value = '';
                        exchangeRateInput.value = '';
                        usdResultElement.textContent = '0.00 USD';


                        // Navigate to summary tab after successful save
                        setTimeout(() => {
                            if (swiperInstance) { // Use swiperInstance
                                swiperInstance.slideTo(0); // Go to summary tab (now index 0)
                            }
                            fetchSummary(); // Reload summary data
                        }, 1000);
                    } else {
                        showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล'); // Show error notification
                    }
                })
                .catch(error => {
                    console.error('Error saving data:', error); // Log the error
                    loadingOverlay.classList.add('hidden');
                    showNotification(errorNotification, 'ไม่สามารถบันทึกข้อมูลได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง'); // Show more specific error notification
                });
            });

            // Handle form submission for saving sales data
            sellForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const date = document.getElementById('dateSell').value;
                const usdAmount = parseFloat(usdSellAmountInput.value);
                const exchangeRate = parseFloat(exchangeRateSellInput.value);

                if (!date || isNaN(usdAmount) || isNaN(exchangeRate)) {
                    showNotification(errorNotification, 'กรุณากรอกข้อมูลการขายให้ครบถ้วนและถูกต้อง');
                    return;
                }

                if (!window.userSheetId) {
                    showNotification(errorNotification, 'กรุณาเข้าสู่ระบบและตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                    return;
                }

                loadingOverlay.classList.remove('hidden');

                const formData = new FormData();
                formData.append('action', 'saveSale'); // New action for sales
                formData.append('date', date);
                formData.append('usdAmount', usdAmount);
                formData.append('exchangeRate', exchangeRate);
                formData.append('sheetId', window.userSheetId);

                fetch(API_URL, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log("Save sale data response status:", response.status); // Log response status
                    if (!response.ok) {
                        console.error('Network response was not ok for sale:', response.status, response.statusText, response.url);
                        throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingOverlay.classList.add('hidden');
                    if (data.success) {
                        showNotification(successNotification, 'บันทึกการขายสำเร็จ');
                        // Reset form fields
                        usdSellAmountInput.value = '';
                        exchangeRateSellInput.value = '';
                        thbReceiveResultElement.textContent = '0.00 ฿';
                        setTimeout(() => {
                            if (swiperInstance) {
                                swiperInstance.slideTo(0); // Go to summary tab (now index 0)
                            }
                            fetchSummary(); // Reload summary data
                        }, 1000);
                    } else {
                        showNotification(errorNotification, data.message || 'เกิดข้อผิดพลาดในการบันทึกการขาย');
                    }
                })
                .catch(error => {
                    console.error('Error saving sale data:', error);
                    loadingOverlay.classList.add('hidden');
                    showNotification(errorNotification, 'ไม่สามารถบันทึกการขายได้: โปรดตรวจสอบ URL ของ Google Apps Script และการตั้งค่าการเข้าถึง');
                });
            });

            // Form toggle logic
            buyFormToggleBtn.addEventListener('click', () => {
                buyFormToggleBtn.classList.add('active-toggle');
                buyFormToggleBtn.classList.remove('active-sale-toggle'); // Ensure sale class is removed
                sellFormToggleBtn.classList.remove('active-toggle');
                sellFormToggleBtn.classList.remove('active-sale-toggle'); // Ensure sale class is removed
                buyFormContainer.classList.remove('hidden');
                sellFormContainer.classList.add('hidden');
            });

            sellFormToggleBtn.addEventListener('click', () => {
                sellFormToggleBtn.classList.add('active-sale-toggle'); // Add sale-specific active class
                sellFormToggleBtn.classList.remove('active-toggle'); // Remove generic active class
                buyFormToggleBtn.classList.remove('active-toggle');
                buyFormToggleBtn.classList.remove('active-sale-toggle'); // Ensure sale class is removed from buy
                buyFormContainer.classList.add('hidden');
                sellFormContainer.classList.remove('hidden');
            });

            // Set initial form view (default to buy)
            buyFormToggleBtn.click();


            // Close any open swipe item when clicking anywhere else on the document
            document.addEventListener('click', (e) => {
                if (activeSwipeItem && !activeSwipeItem.contains(e.target) && !e.target.closest('.delete-reveal')) {
                    closeActiveSwipeItem();
                }
            });


            // Click listener for history refresh button
            refreshButton.addEventListener('click', fetchHistory);


            // Click listener for summary refresh button
            refreshSummaryButton.addEventListener('click', function() {
                fetchSummary(); // Reload summary data (which will also trigger monthly data fetch)
            });


            // Function to set the theme
            function setTheme(isDark) {
                if (isDark) {
                    body.classList.remove('light-theme');
                    // Update TradingView widget theme to dark
                    if (tradingViewWidgetContainer) {
                        tradingViewWidgetContainer.innerHTML = ''; // Clear existing widget
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                        script.async = true;
                        // Corrected JSON string for TradingView widget settings
                        script.innerHTML = JSON.stringify({
                            "autosize": true,
                            "symbol": "FX_IDC:USDTHB",
                            "interval": "D",
                            "timezone": "Asia/Bangkok",
                            "theme": "dark", // Set to dark
                            "style": "1",
                            "locale": "th_TH",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "calendar": false,
                            "support_host": "https://www.tradingview.com"
                        });
                        tradingViewWidgetContainer.appendChild(script);
                    }
                } else {
                    body.classList.add('light-theme');
                    // Update TradingView widget theme to light
                    if (tradingViewWidgetContainer) {
                        tradingViewWidgetContainer.innerHTML = ''; // Clear existing widget
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                        script.async = true;
                        // Corrected JSON string for TradingView widget settings
                        script.innerHTML = JSON.stringify({
                            "autosize": true,
                            "symbol": "FX_IDC:USDTHB",
                            "interval": "D",
                            "timezone": "Asia/Bangkok",
                            "theme": "light", // Set to light
                            "style": "1",
                            "locale": "th_TH",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "calendar": false,
                            "support_host": "https://www.tradingview.com"
                        });
                        tradingViewWidgetContainer.appendChild(script);
                    }
                }
            }

            // Set initial theme based on checkbox state (it's checked by default in HTML for dark)
            // This needs to be called after all elements are initialized
            setTheme(themeToggle.checked);

            themeToggle.addEventListener('change', function() {
                console.log('Theme toggle:', this.checked ? 'On' : 'Off');
                setTheme(this.checked);
            });


            // Notification toggle functionality (placeholder)
            const notificationToggle = document.getElementById('notificationToggle');
            notificationToggle.addEventListener('change', function() {
                console.log('Notification toggle:', this.checked ? 'On' : 'Off');
            });


            // Event listener for saving Google Sheet ID in settings
            saveSheetIdButton.addEventListener('click', async function() {
                const newSheetId = sheetIdInput.value.trim();
                if (newSheetId) {
                    loadingOverlay.classList.remove('hidden');
                    const success = await saveUserSheetId(newSheetId); // Call the Firebase save function
                    loadingOverlay.classList.add('hidden');
                    if (success) {
                        showNotification(successNotification, 'บันทึก Google Sheet ID สำเร็จ');
                        // Reload summary data with the new sheet ID
                        fetchSummary();
                        // If user just saved sheet ID, navigate to summary
                        if (swiperInstance) {
                            swiperInstance.slideTo(0); // Go to summary tab (now index 0)
                        }
                    } else {
                        showNotification(errorNotification, 'ไม่สามารถบันทึก Google Sheet ID ได้');
                    }
                } else {
                    showNotification(errorNotification, 'กรุณาป้อน Google Sheet ID');
                }
            });

            // Event listeners for login/signup buttons on the login modal
            if (signInModalButton) {
                signInModalButton.addEventListener('click', () => {
                    const email = loginModalEmailInput.value;
                    const password = loginModalPasswordInput.value;
                    handleSignInWithEmailPassword(email, password);
                });
            }

            if (signUpModalSubmitButton) {
                signUpModalSubmitButton.addEventListener('click', () => {
                    const email = signUpModalEmailInput.value;
                    const password = signUpModalPasswordInput.value;
                    const confirmPassword = signUpModalConfirmPasswordInput.value;

                    if (password !== confirmPassword) {
                        showNotification(errorNotification, 'รหัสผ่านไม่ตรงกัน');
                        return;
                    }
                    signUpWithEmailPassword(email, password);
                });
            }

            if (loginModalSignOutButton) {
                loginModalSignOutButton.addEventListener('click', signOutUser);
            }

            // Sign out button in settings
            if (signOutButtonSettings) {
                signOutButtonSettings.addEventListener('click', signOutUser);
            }

            // Login/Sign-up form toggle logic for the modal
            if (loginModalToggleSignIn) {
                loginModalToggleSignIn.addEventListener('click', () => {
                    loginModalToggleSignIn.classList.add('active-login-tab');
                    loginModalToggleSignUp.classList.remove('active-login-tab');
                    loginModalFormContainer.classList.remove('hidden');
                    signUpModalFormContainer.classList.add('hidden');
                });
            }

            if (loginModalToggleSignUp) {
                loginModalToggleSignUp.addEventListener('click', () => {
                    loginModalToggleSignUp.classList.add('active-login-tab');
                    loginModalToggleSignIn.classList.remove('active-login-tab');
                    signUpModalFormContainer.classList.remove('hidden');
                    loginModalFormContainer.classList.add('hidden');
                });
            }

            // Set initial login form view (default to sign-in) for the modal
            if (loginModalToggleSignIn) {
                loginModalToggleSignIn.click();
            }

            // --- Initialize Stock App Elements and Event Listeners ---
            stockMainContent = document.getElementById('stockSummaryView').closest('.flex-grow.overflow-y-auto');
            stockNavItems = document.querySelectorAll('.stock-nav-item');
            stockViews = {
                stockSummaryView: document.getElementById('stockSummaryView'),
                stockGraphView: document.getElementById('stockGraphView'),
                stockRecordView: document.getElementById('stockRecordView'),
                stockHistoryView: document.getElementById('stockHistoryView'),
                stockSettingsView: document.getElementById('stockSettingsView')
            };
            stockRecordForm = document.getElementById('stockRecordForm');
            stockSettingsForm = document.getElementById('stockSettingsForm');
            stockHistoryTableBody = document.getElementById('stockHistoryTableBody');
            stockHistorySearchInput = document.getElementById('stockHistorySearchInput');

            stockSummaryDashboard = document.getElementById('stockSummaryDashboard');
            stockSummaryStockDetails = document.getElementById('stockSummaryStockDetails');

            stockStockTargetRatesContainer = document.getElementById('stockTargetRatesContainer');
            stockAddStockTargetRateBtn = document.getElementById('stockAddStockTargetRateBtn');
            stockStockTargetExchangeRatesContainer = document.getElementById('stockTargetExchangeRatesContainer');
            stockAddStockTargetUsdRateBtn = document.getElementById('stockAddStockTargetUsdRateBtn');

            stockTvSymbolInput = document.getElementById('stockTvSymbolInput');
            stockTvLoadSymbolBtn = document.getElementById('stockTvLoadSymbolBtn');
            stockTvFullscreenBtn = document.getElementById('stockTvFullscreenBtn');
            stockTradingViewWidgetContainer = document.getElementById('stockTradingViewWidgetContainer');
            stockTradingViewFullscreenModal = document.getElementById('tradingViewFullscreenModal'); // Get fullscreen modal
            stockTradingViewFullscreenContent = document.getElementById('tradingViewFullscreenContent'); // Get fullscreen content
            stockCloseTradingViewFullscreenBtn = document.getElementById('closeTradingViewFullscreenBtn'); // Get close fullscreen button


            // Attach event listeners for stock app's internal navigation
            stockNavItems.forEach(item => {
                item.addEventListener('click', () => stockNavigateTo(item.dataset.stockView));
            });

            // Attach event listeners for stock forms and buttons
            if (stockRecordForm) stockRecordForm.addEventListener('submit', stockHandleRecordSubmit);
            if (stockSettingsForm) stockSettingsForm.addEventListener('submit', stockHandleSettingsSubmit); // This will primarily trigger re-render of settings
            if (stockAddStockTargetRateBtn) stockAddStockTargetRateBtn.addEventListener('click', stockHandleAddStockTargetRate);
            if (stockAddStockTargetUsdRateBtn) stockAddStockTargetUsdRateBtn.addEventListener('click', stockHandleAddStockTargetUsdRate);
            if (stockHistorySearchInput) stockHistorySearchInput.addEventListener('input', () => stockFetchAndRenderHistory(stockHistorySearchInput.value.trim())); // Changed to fetch and render

            if (stockTvLoadSymbolBtn) stockTvLoadSymbolBtn.addEventListener('click', stockLoadTradingViewWidget);
            if (stockTvFullscreenBtn) stockTvFullscreenBtn.addEventListener('click', stockOpenTradingViewFullscreen);
            if (stockCloseTradingViewFullscreenBtn) stockCloseTradingViewFullscreenBtn.addEventListener('click', stockCloseTradingViewFullscreen);

            // Set initial date for stock record form
            if (document.getElementById('stockRecordDate')) {
                document.getElementById('stockRecordDate').valueAsDate = new Date();
            }
        }

        // Function to navigate between internal stock views
        function stockNavigateTo(viewId) {
            Object.values(stockViews).forEach(view => view.classList.add('hidden'));
            if (stockViews[viewId]) {
                stockViews[viewId].classList.remove('hidden');
                // For summaryView, the scrolling content is inside a nested div
                if (viewId === 'stockSummaryView') {
                    const stockSummaryContentScroller = stockViews[viewId].querySelector('.overflow-y-auto');
                    if (stockSummaryContentScroller) stockSummaryContentScroller.scrollTop = 0;
                    stockFetchAndRenderSummary(); // Fetch and render summary when navigating to it
                } else if (viewId === 'stockHistoryView') {
                    stockFetchAndRenderHistory(); // Fetch and render history when navigating to it
                } else if (viewId === 'stockSettingsView') {
                    stockFetchAndRenderSettingsForm(); // Fetch and render settings when navigating to it
                } else if (viewId === 'stockGraphView') {
                    // Optionally load default symbol or last loaded symbol if graph view is activated
                    if (!stockCurrentTradingViewSymbol) {
                        stockTvSymbolInput.value = 'AAPL'; // Default symbol
                        stockLoadTradingViewWidget();
                    }
                }
                 // For other stock views, scroll the container div
                if (stockMainContent) stockMainContent.scrollTop = 0;
            }
            stockNavItems.forEach(item => {
                item.classList.remove('active', 'text-blue-500', 'border-blue-500');
                item.classList.add('text-slate-600');
                if (item.dataset.stockView === viewId) {
                    item.classList.add('active', 'text-blue-500', 'border-blue-500');
                    item.classList.remove('text-slate-600');
                }
            });
        }


        let isAppInitialized = false; // New flag to ensure initializeAppComponent runs only once

        // This function will be called once the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure update notification is hidden on load
            const updateNotification = document.getElementById('updateNotification');
            if (updateNotification) {
                updateNotification.classList.add('hidden');
                updateNotification.classList.add('translate-y-full');
            }

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered:', registration);

                            // Check for Service Worker updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // A new Service Worker is installed and waiting to activate
                                        // Show update notification
                                        const updateNotification = document.getElementById('updateNotification');
                                        if (updateNotification) {
                                            updateNotification.classList.remove('hidden');
                                            updateNotification.classList.remove('translate-y-full');
                                            updateNotification.classList.add('translate-y-0');
                                        }
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                        });
                });

                // Listen for messages from the Service Worker (for update notification)
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                        const updateNotification = document.getElementById('updateNotification');
                        if (updateNotification) {
                            updateNotification.classList.remove('hidden');
                            updateNotification.classList.remove('translate-y-full');
                            updateNotification.classList.add('translate-y-0');
                        }
                    }
                });
            }

            // Listen for auth state changes to get userId and fetch user's sheet ID
            onAuthStateChanged(window.auth, async (user) => {
                const displayUserIdElement = document.getElementById('displayUserId');
                const bottomNav = document.querySelector('.bottom-nav'); // Get bottom nav element

                if (user) {
                    // User is signed in
                    window.userId = user.uid;
                    console.log("User ID:", window.userId);
                    if (displayUserIdElement) {
                        displayUserIdElement.textContent = window.userId;
                    }
                    // Hide login modal if user is logged in
                    loginModalOverlay.classList.add('hidden');

                    await fetchUserSheetId(); // Fetch user's sheet ID

                    // If logged in, allow swiper touch move and show bottom nav
                    if (swiperInstance) {
                        swiperInstance.allowTouchMove = true;
                        swiperInstance.allowSlidePrev = true; // Allow swiping prev between content tabs
                        swiperInstance.allowSlideNext = true; // Allow swiping next between content tabs
                        swiperInstance.slideTo(0); // Go to summary tab (now index 0)
                    }
                    bottomNav.classList.remove('bottom-nav-hidden'); // Show bottom nav smoothly

                    // Then, if sheet ID is missing, show notification.
                    if (!window.userSheetId) {
                        showNotification(document.getElementById('errorNotification'), 'กรุณาตั้งค่า Google Sheet ID ในหน้าตั้งค่าก่อน');
                    } else {
                        fetchSummary(); // Only fetch summary if sheet ID exists
                    }

                } else {
                    // User is signed out
                    window.userId = null;
                    window.userSheetId = null;
                    console.log("No user signed in.");
                    if (displayUserIdElement) {
                        displayUserIdElement.textContent = 'N/A (ไม่ได้เข้าสู่ระบบ)';
                    }
                    // Show login modal if user is not logged in
                    loginModalOverlay.classList.remove('hidden');

                    // Clear summary and history if no user is logged in
                    const noAuthMessage = '<p class="text-gray-500 text-center py-4">โปรดเข้าสู่ระบบเพื่อดูข้อมูล</p>';
                    totalCardEl.innerHTML = noAuthMessage;
                    ratesCardEl.innerHTML = noAuthMessage;
                    buyCardEl.innerHTML = noAuthMessage;
                    profitLossCardEl.innerHTML = noAuthMessage;
                    historyList.innerHTML = noAuthMessage;

                    if (swiperInstance) {
                        swiperInstance.slideTo(0); // Ensure it's on the first content slide (Summary)
                        swiperInstance.allowTouchMove = false; // Disable swiping when not logged in
                        swiperInstance.allowSlidePrev = false;
                        swiperInstance.allowSlideNext = false;
                    }
                    bottomNav.classList.add('bottom-nav-hidden'); // Hide bottom nav smoothly
                    showNotification(document.getElementById('errorNotification'), 'โปรดเข้าสู่ระบบเพื่อใช้งาน');
                }
                // Initialize app components only once, after the initial auth state is determined
                if (!isAppInitialized) {
                    initializeAppComponent();
                    isAppInitialized = true;
                }
            });
        });
    </script>
</head>
<body>
    <div class="swiper mySwiper">
        <div class="swiper-wrapper">
            <div class="swiper-slide bg-[#121212]">
                <div class="container">
                    <div class="flex justify-between items-center mb-6 py-2">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-100">สรุปข้อมูล</h2>
                        <button id="refreshSummaryButton" class="text-blue-400 hover:text-blue-300 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            รีเฟรช
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
                        <div id="totalCard" class="summary-card fade-in">
                            <div class="flex justify-center py-8">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                            </div>
                        </div>


                        <div id="ratesCard" class="summary-card fade-in">
                            <div class="flex justify-center py-8">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                            </div>
                        </div>


                        <div id="buyCard" class="summary-card fade-in">
                            <div class="flex justify-center py-8">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                            </div>
                        </div>

                        <div id="profitLossCard" class="summary-card fade-in">
                            <div class="flex justify-center py-8">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tradingview-widget-container summary-card w-full">
                        <div class="card-header mb-0">
                            <h3 class="card-title text-xl font-bold">กราฟ USD/THB</h3>
                        </div>
                        <div class="tradingview-widget-container__widget h-full"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                        {
                            "autosize": true,
                            "symbol": "FX_IDC:USDTHB",
                            "interval": "D",
                            "timezone": "Asia/Bangkok",
                            "theme": "dark",
                            "style": "1",
                            "locale": "th_TH",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "calendar": false,
                            "support_host": "https://www.tradingview.com"
                        }
                        </script>
                    </div>
                </div>
            </div>


            <div class="swiper-slide bg-[#121212]">
                <div class="container">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-6 text-center">บันทึกธุรกรรม USD</h2>

                    <div class="form-toggle-container">
                        <button id="buyFormToggleBtn" class="form-toggle-button active-toggle">บันทึกการซื้อ</button>
                        <button id="sellFormToggleBtn" class="form-toggle-button">บันทึกการขาย</button>
                    </div>

                    <div id="buyFormContainer">
                        <form id="usdBuyForm" class="space-y-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-400 mb-1">วันที่</label>
                                <input type="date" id="date" name="date" required
                                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>


                            <div>
                                <label for="thbAmount" class="block text-sm font-medium text-gray-400 mb-1">จำนวนเงินบาท</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500">฿</span>
                                    </div>
                                    <input type="number" id="thbAmount" name="thbAmount" step="0.01" min="0" required
                                        class="w-full pl-8 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.00">
                                    </div>
                            </div>


                            <div>
                                <label for="exchangeRate" class="block text-sm font-medium text-gray-400 mb-1">อัตราแลกเปลี่ยน (บาท/USD)</label>
                                <div class="relative">
                                    <input type="number" id="exchangeRate" name="exchangeRate" step="0.01" min="0" required
                                        class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="35.50">
                                </div>
                            </div>


                            <div class="bg-[#2C2C2E] p-4 rounded-md">
                                <p class="text-sm text-gray-400 mb-2">จำนวน USD ที่ได้รับ:</p>
                                <p id="usdResult" class="text-lg sm:text-xl font-semibold text-blue-400">0.00 USD</p>
                            </div>


                            <button type="submit"
                                class="w-full form-button flex items-center justify-center">
                                <span>บันทึกการซื้อ</span>
                            </button>
                        </form>
                    </div>

                    <div id="sellFormContainer" class="hidden">
                        <form id="usdSellForm" class="space-y-4">
                            <div>
                                <label for="dateSell" class="block text-sm font-medium text-gray-400 mb-1">วันที่</label>
                                <input type="date" id="dateSell" name="dateSell" required
                                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>


                            <div>
                                <label for="usdSellAmount" class="block text-sm font-medium text-gray-400 mb-1">จำนวน USD ที่ต้องการขาย</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500">$</span>
                                    </div>
                                    <input type="number" id="usdSellAmount" name="usdSellAmount" step="0.01" min="0" required
                                        class="w-full pl-8 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="0.00">
                                </div>
                            </div>


                            <div>
                                <label for="exchangeRateSell" class="block text-sm font-medium text-gray-400 mb-1">อัตราแลกเปลี่ยน (บาท/USD)</label>
                                <div class="relative">
                                    <input type="number" id="exchangeRateSell" name="exchangeRateSell" step="0.01" min="0" required
                                        class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="35.50">
                                </div>
                            </div>


                            <div class="bg-[#2C2C2E] p-4 rounded-md">
                                <p class="text-sm text-gray-400 mb-2">จำนวนเงินบาทที่ได้รับ:</p>
                                <p id="thbReceiveResult" class="text-lg sm:text-xl font-semibold text-blue-400">0.00 ฿</p>
                            </div>


                            <button type="submit"
                                class="w-full form-button sale-button flex items-center justify-center">
                                <span>บันทึกการขาย</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="swiper-slide bg-[#121212]">
                <div class="container">
                    <div class="bg-[#2C2C2E] rounded-lg shadow-lg p-6 flex flex-col h-full">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl sm:text-2xl font-semibold text-gray-100">ประวัติธุรกรรม</h2>
                            <button id="refreshButton" class="text-blue-400 hover:text-blue-300 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                                รีเฟรช
                            </button>
                        </div>
                        <div id="historyList" class="space-y-3">
                            <div class="flex justify-center py-8">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="swiper-slide bg-[#121212]">
                <div class="container">
                    <div class="bg-[#2C2C2E] rounded-lg shadow-lg p-6">
                        <h2 class="text-xl sm:text-2xl font-semibold text-gray-100 mb-6">ตั้งค่า</h2>


                        <div class="space-y-4">
                            <div class="p-4 border border-gray-700 rounded-md">
                                <label for="sheetIdInput" class="block text-sm font-medium text-gray-400 mb-2">Google Sheet ID</label>
                                <input type="text" id="sheetIdInput" placeholder="ป้อน Google Sheet ID ของคุณ"
                                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                                <button id="saveSheetIdButton"
                                    class="w-full form-button flex items-center justify-center">
                                    <span>บันทึก Sheet ID</span>
                                </button>
                                <p class="text-xs text-gray-500 mt-2">โปรดตรวจสอบให้แน่ใจว่า Google Sheet ของคุณสามารถเข้าถึงได้โดย Apps Script</p>
                            </div>


                            <div class="p-4 border border-gray-700 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-100">User ID</span>
                                    <span id="displayUserId" class="text-gray-400 text-sm break-all">กำลังโหลด...</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">ใช้สำหรับแยกข้อมูลผู้ใช้</p>
                            </div>

                            <div class="p-4 border border-gray-700 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-100">ธีม</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="themeToggle" checked> <span class="slider"></span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">โหมดมืด</p>
                            </div>


                            <div class="p-4 border border-gray-700 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-100">แจ้งเตือน</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="notificationToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">เปิดการแจ้งเตือน</p>
                            </div>


                            <div class="p-4 border border-gray-700 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-100">ภาษา</span>
                                    <select class="border border-gray-600 rounded-md px-2 py-1 text-sm bg-[#121212] text-gray-100">
                                        <option value="th">ไทย</option>
                                    </select>
                                </div>
                            </div>


                            <div class="p-4 border border-gray-700 rounded-md">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-100">เวอร์ชัน</span>
                                    <span class="text-gray-400">1.0.6</span>
                                </div>
                            </div>

                            <div class="p-4 border border-gray-700 rounded-md">
                                <button id="signOutButtonSettings" class="w-full form-button bg-red-500 hover:bg-red-600">
                                    ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="swiper-slide bg-[#121212]">
                <div class="container h-full flex flex-col">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-100 mb-4 text-center">จัดการหุ้น</h2>

                    <nav class="bg-slate-50 border-b border-slate-200 shadow-md h-12 flex items-center justify-around rounded-t-lg mb-4">
                        <button data-stock-view="stockSummaryView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150 active text-blue-500 border-blue-500">
                            <span class="text-xs">สรุป</span>
                        </button>
                        <button data-stock-view="stockGraphView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
                            <span class="text-xs">กราฟ</span>
                        </button>
                        <button data-stock-view="stockRecordView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
                            <span class="text-xs">บันทึก</span>
                        </button>
                        <button data-stock-view="stockHistoryView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
                            <span class="text-xs">ประวัติ</span>
                        </button>
                        <button data-stock-view="stockSettingsView" class="stock-nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-600 hover:bg-slate-100 transition duration-150">
                            <span class="text-xs">ตั้งค่า</span>
                        </button>
                    </nav>

                    <div class="flex-grow overflow-y-auto bg-white rounded-b-lg shadow-lg p-4">
                        <section id="stockSummaryView" class="h-full flex flex-col">
                            <div class="flex-grow overflow-y-auto">
                                <div id="stockSummaryDashboard" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                    <div class="summary-card">
                                        <p class="summary-card-title">กำลังโหลดข้อมูล...</p>
                                        <p class="summary-card-value">-</p>
                                    </div>
                                </div>
                                <h2 class="text-xl font-semibold mb-4 text-gray-800">รายละเอียดหุ้นรายตัว</h2>
                                <div id="stockSummaryStockDetails" class="space-y-0"> <p class="text-gray-400 p-4 text-center">กำลังโหลดข้อมูลหุ้น...</p>
                                </div>
                            </div>
                        </section>

                        <section id="stockGraphView" class="hidden h-full flex flex-col">
                            <h1 class="text-2xl font-bold mb-4 text-slate-700">กราฟหุ้น (TradingView)</h1>
                            <div class="mb-4 flex space-x-2">
                                <input type="text" id="stockTvSymbolInput" placeholder="เช่น AAPL, TSLA, BTCUSD" class="flex-grow p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <button id="stockTvLoadSymbolBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">โหลดกราฟ</button>
                                <button id="stockTvFullscreenBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">เต็มจอ</button>
                            </div>
                            <div id="stockTradingViewWidgetContainer" class="flex-grow border border-slate-300 rounded-md shadow-inner overflow-hidden bg-slate-50">
                                <p class="p-4 text-slate-500 text-center">กรุณาใส่ชื่อหุ้นและกด "โหลดกราฟ"</p>
                            </div>
                        </section>

                        <section id="stockRecordView" class="hidden">
                            <h1 class="text-2xl font-bold mb-4 text-slate-700">บันทึกรายการซื้อหุ้น</h1>
                            <form id="stockRecordForm" class="space-y-4">
                                <div>
                                    <label for="stockRecordDate" class="block text-sm font-medium text-slate-700">วันที่ซื้อ:</label>
                                    <input type="date" id="stockRecordDate" name="date" required
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="stockRecordStockSymbol" class="block text-sm font-medium text-slate-700">ชื่อหุ้น (Symbol):</label>
                                    <input type="text" id="stockRecordStockSymbol" name="stockSymbol" placeholder="เช่น AAPL" required
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="stockRecordQuantity" class="block text-sm font-medium text-slate-700">จำนวนหุ้น:</label>
                                    <input type="number" id="stockRecordQuantity" name="quantity" step="any" placeholder="10" required
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="stockRecordTotalTHB" class="block text-sm font-medium text-slate-700">เงินบาทรวม (สำหรับรายการนี้):</label>
                                    <input type="number" id="stockRecordTotalTHB" name="totalTHB" step="any" placeholder="50000" required
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="stockRecordUsdRate" class="block text-sm font-medium text-slate-700">Rate THB/USD (ณ วันซื้อ, ถ้ามี):</label>
                                    <input type="number" id="stockRecordUsdRate" name="usdExchangeRateAtPurchase" step="any" placeholder="35.50"
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <button type="submit"
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">บันทึกรายการ</button>
                            </form>
                        </section>

                        <section id="stockHistoryView" class="hidden">
                            <h1 class="text-2xl font-bold mb-4 text-slate-700">ประวัติการซื้อ</h1>
                            <div class="mb-4">
                                <input type="text" id="stockHistorySearchInput" placeholder="ค้นหาตามชื่อหุ้นหรือวันที่ (YYYY-MM-DD)"
                                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div id="stockHistoryTableContainer" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200 border border-slate-300 rounded-md shadow">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">วันที่</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ชื่อหุ้น</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">จำนวน</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">เงินบาทรวม</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Rate THB/USD</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">การกระทำ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockHistoryTableBody" class="bg-white divide-y divide-slate-200">
                                        <tr><td colspan="6" class="text-center p-4 text-slate-500">ยังไม่มีประวัติการซื้อขาย</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <section id="stockSettingsView" class="hidden">
                            <h1 class="text-2xl font-bold mb-4 text-slate-700">ตั้งค่า</h1>
                            <form id="stockSettingsForm" class="space-y-6">
                                <div>
                                    <label for="stockSettingsSheetId" class="block text-sm font-medium text-slate-700">Sheet ID (Google Sheets - ใช้ร่วมกับ USD Tracker):</label>
                                    <input type="text" id="stockSettingsSheetId" name="sheetId" placeholder="จะถูกเติมโดยอัตโนมัติ" readonly
                                        class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-100 cursor-not-allowed">
                                    <p class="text-xs text-gray-500 mt-1">Sheet ID นี้จะถูกใช้ร่วมกับส่วน USD Tracker</p>
                                </div>
                                <div class="border-t border-slate-200 pt-4">
                                    <h2 class="text-lg font-semibold mb-2 text-slate-700">Rate เป้าหมายของหุ้นแต่ละตัว (THB/หุ้น):</h2>
                                    <div id="stockTargetRatesContainer" class="space-y-2">
                                        <p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate เป้าหมาย</p>
                                    </div>
                                    <div class="mt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                        <input type="text" id="stockNewTargetStockSymbol" placeholder="ชื่อหุ้น (Symbol)"
                                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                                        <input type="number" id="stockNewTargetStockRate" placeholder="Rate เป้าหมาย (THB)"
                                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                                        <button type="button" id="stockAddStockTargetRateBtn"
                                            class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm">เพิ่ม</button>
                                    </div>
                                </div>
                                <div class="border-t border-slate-200 pt-4">
                                    <h2 class="text-lg font-semibold mb-2 text-slate-700">Rate แลกเปลี่ยนเป้าหมายของหุ้นแต่ละตัว (THB/USD):</h2>
                                    <div id="stockTargetExchangeRatesContainer" class="space-y-2">
                                        <p class="text-sm text-slate-500">ยังไม่มีการตั้งค่า Rate แลกเปลี่ยนเป้าหมาย</p>
                                    </div>
                                    <div class="mt-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                        <input type="text" id="stockNewTargetStockSymbolUsd" placeholder="ชื่อหุ้น (Symbol)"
                                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                                        <input type="number" id="stockNewTargetUsdRate" placeholder="Rate เป้าหมาย (THB/USD)" step="any"
                                            class="w-full sm:w-1/2 p-2 border border-slate-300 rounded-md shadow-sm">
                                        <button type="button" id="stockAddStockTargetUsdRateBtn"
                                            class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm">เพิ่ม</button>
                                    </div>
                                </div>
                                <button type="submit"
                                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150">บันทึกการตั้งค่า</button>
                            </form>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="bottom-nav bottom-nav-hidden"> <div class="grid grid-cols-5 gap-2">
            <div class="nav-item" data-index="0"> <div class="emoji">📈</div>
                <div class="label">สรุป USD</div>
            </div>
            <div class="nav-item" data-index="1"> <div class="emoji">📝</div>
                <div class="label">บันทึก USD</div>
            </div>
            <div class="nav-item" data-index="2"> <div class="emoji">📚</div>
                <div class="label">ประวัติ USD</div>
            </div>
            <div class="nav-item" data-index="3"> <div class="emoji">⚙️</div>
                <div class="label">ตั้งค่า USD</div>
            </div>
            <div class="nav-item" data-index="4"> <div class="emoji">📊</div>
                <div class="label">จัดการหุ้น</div>
            </div>
        </div>
        <div class="page-indicator">
            <div class="indicator"></div>
            <div class="indicator"></div>
            <div class="indicator"></div>
            <div class="indicator"></div>
            <div class="indicator"></div>
        </div>
    </div>

    <div id="updateNotification" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 translate-y-full bg-[#2C2C2E] text-white px-6 py-3 rounded-md shadow-lg z-50">
        <p class="text-center">มีการอัปเดตใหม่! กรุณารีเฟรชเพื่อใช้งานเวอร์ชันล่าสุด</p>
        <button onclick="window.location.reload(true)" class="ml-4 px-4 py-2 bg-blue-500 rounded-md">รีเฟรช</button>
        <button class="close-button" onclick="document.getElementById('updateNotification').classList.add('hidden');">&times;</button>
    </div>


    <div id="customModalOverlay" class="custom-modal-overlay hidden">
        <div class="custom-modal-content">
            <h3 id="customModalTitle"></h3>
            <p id="customModalMessage"></p>
            <div class="custom-modal-actions">
                <button id="customModalConfirmBtn" class="confirm">ยืนยัน</button>
                <button id="customModalCancelBtn" class="cancel">ยกเลิก</button>
            </div>
        </div>
    </div>

    <div id="loginModalOverlay" class="login-modal-overlay hidden">
        <div class="login-modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center">ยินดีต้อนรับ</h2>
            <div id="loginModalAuthSection" class="space-y-4">
                <div class="login-toggle-container">
                    <button id="loginModalToggleSignIn" class="login-toggle-button active-login-tab">เข้าสู่ระบบ</button>
                    <button id="loginModalToggleSignUp" class="login-toggle-button">ลงทะเบียน</button>
                </div>

                <div id="loginModalFormContainer" class="space-y-4">
                    <div>
                        <label for="loginModalEmailInput" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                        <input type="email" id="loginModalEmailInput" placeholder="กรอกอีเมล"
                            class="login-input">
                    </div>
                    <div>
                        <label for="loginModalPasswordInput" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                        <input type="password" id="loginModalPasswordInput" placeholder="กรอกรหัสผ่าน"
                            class="login-input">
                    </div>
                    <button id="signInModalButton" class="login-button">
                        เข้าสู่ระบบ
                    </button>
                </div>

                <div id="signUpModalFormContainer" class="space-y-4 hidden">
                    <div>
                        <label for="signUpModalEmailInput" class="block text-sm font-medium text-gray-700 mb-1">อีเมล</label>
                        <input type="email" id="signUpModalEmailInput" placeholder="กรอกอีเมล"
                            class="login-input">
                    </div>
                    <div>
                        <label for="signUpModalPasswordInput" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                        <input type="password" id="signUpModalPasswordInput" placeholder="กรอกรหัสผ่าน"
                            class="login-input">
                    </div>
                    <div>
                        <label for="signUpModalConfirmPasswordInput" class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่าน</label>
                        <input type="password" id="signUpModalConfirmPasswordInput" placeholder="ยืนยันรหัสผ่าน"
                            class="login-input">
                    </div>
                    <button id="signUpModalSubmitButton" class="login-button">
                        ลงทะเบียน
                    </button>
                </div>
            </div>
            <p class="login-version text-center">V 1.0.6</p>
        </div>
    </div>

    <div id="tradingViewFullscreenModal" class="modal tradingview-fullscreen-modal">
        <div class="modal-content relative">
            <button id="closeTradingViewFullscreenBtn" class="absolute top-2 right-2 z-10 bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="tradingViewFullscreenContent" class="w-full h-full"></div>
        </div>
    </div>


    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[#2C2C2E] p-5 rounded-lg flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <h2 class="text-center text-gray-100 text-xl font-semibold">กำลังบันทึกข้อมูล...</h2>
        </div>
    </div>


    <div id="successNotification" class="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full z-50">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p>บันทึกข้อมูลสำเร็จ</p>
        </div>
    </div>


    <div id="errorNotification" class="fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-md shadow-lg transform transition-transform duration-300 translate-x-full z-50">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <p>เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง</p>
        </div>
    </div>
</body>
</html>
